
<script>
    aviewer = _phonegap;
    //aviewer.serverUrl = "http://aniparti.lianxi.cn";
  // aviewer.serverUrl = "http://pixi.aniparti.pk";

  // aviewer.serverUrl = "http://" + window.domainName;
aviewer.serverUrl = "http://mad.aniparti.com";


    window.WebGLImageFilter = function () { var r = null, t = 0, e = null, o = !1, i = -1, a = [null, null], n = [], u = -1, c = -1, v = null, l = null, x = document.createElement("canvas"); if (!(r = x.getContext("webgl") || x.getContext("experimental-webgl"))) throw "Couldn't get WebGL context"; this.addFilter = function (r) { var t = Array.prototype.slice.call(arguments, 1), e = R[r]; n.push({ func: e, args: t }) }, this.reset = function () { n = [] }, this.apply = function (i) { if (E(i.width, i.height), t = 0, e = r.createTexture(), r.bindTexture(r.TEXTURE_2D, e), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_WRAP_S, r.CLAMP_TO_EDGE), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_WRAP_T, r.CLAMP_TO_EDGE), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_MIN_FILTER, r.NEAREST), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_MAG_FILTER, r.NEAREST), r.texImage2D(r.TEXTURE_2D, 0, r.RGBA, r.RGBA, r.UNSIGNED_BYTE, i), 0 == n.length) return T(p.FRAGMENT_IDENTITY), g(), x; for (var a = 0; a < n.length; a++) { o = a == n.length - 1; var u = n[a]; u.func.apply(this, u.args || []) } return x }; var E = function (t, e) { if (t != u || e != c) { if (x.width = u = t, x.height = c = e, !v) { var o = new Float32Array([-1, -1, 0, 1, 1, -1, 1, 1, -1, 1, 0, 0, -1, 1, 0, 0, 1, -1, 1, 1, 1, 1, 1, 0]); v = r.createBuffer(), r.bindBuffer(r.ARRAY_BUFFER, v), r.bufferData(r.ARRAY_BUFFER, o, r.STATIC_DRAW), r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL, !0) } r.viewport(0, 0, u, c), a = [null, null] } }, m = function (r) { return a[r] = a[r] || f(u, c), a[r] }, f = function (t, e) { var o = r.createFramebuffer(); r.bindFramebuffer(r.FRAMEBUFFER, o); var i = r.createRenderbuffer(); r.bindRenderbuffer(r.RENDERBUFFER, i); var a = r.createTexture(); return r.bindTexture(r.TEXTURE_2D, a), r.texImage2D(r.TEXTURE_2D, 0, r.RGBA, t, e, 0, r.RGBA, r.UNSIGNED_BYTE, null), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_MAG_FILTER, r.LINEAR), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_MIN_FILTER, r.LINEAR), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_WRAP_S, r.CLAMP_TO_EDGE), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_WRAP_T, r.CLAMP_TO_EDGE), r.framebufferTexture2D(r.FRAMEBUFFER, r.COLOR_ATTACHMENT0, r.TEXTURE_2D, a, 0), r.bindTexture(r.TEXTURE_2D, null), r.bindFramebuffer(r.FRAMEBUFFER, null), { fbo: o, texture: a } }, g = function (a) { var n = null, u = null, c = !1; n = 0 == t ? e : m(i).texture, t++, !o || a & _.INTERMEDIATE ? u = m(i = (i + 1) % 2).fbo : (u = null, c = t % 2 == 0), r.bindTexture(r.TEXTURE_2D, n), r.bindFramebuffer(r.FRAMEBUFFER, u), r.uniform1f(l.uniform.flipY, c ? -1 : 1), r.drawArrays(r.TRIANGLES, 0, 6) }, T = function (t) { if (t.__program) return l = t.__program, r.useProgram(l.id), l; l = new function (r, t, e) { var o = function (r, t, e) { var o = new RegExp("\\b" + t + " \\w+ (\\w+)", "ig"); r.replace(o, function (r, t) { return e[t] = 0, r }) }, i = function (r, t, e) { var o = r.createShader(e); return r.shaderSource(o, t), r.compileShader(o), r.getShaderParameter(o, r.COMPILE_STATUS) ? o : (console.log(r.getShaderInfoLog(o)), null) }; this.uniform = {}, this.attribute = {}; var a = i(r, t, r.VERTEX_SHADER), n = i(r, e, r.FRAGMENT_SHADER); this.id = r.createProgram(), r.attachShader(this.id, a), r.attachShader(this.id, n), r.linkProgram(this.id), r.getProgramParameter(this.id, r.LINK_STATUS) || console.log(r.getProgramInfoLog(this.id)), r.useProgram(this.id), o(t, "attribute", this.attribute); for (var u in this.attribute) this.attribute[u] = r.getAttribLocation(this.id, u); o(t, "uniform", this.uniform), o(e, "uniform", this.uniform); for (var c in this.uniform) this.uniform[c] = r.getUniformLocation(this.id, c) }(r, p.VERTEX_IDENTITY, t); var e = Float32Array.BYTES_PER_ELEMENT, o = 4 * e; return r.enableVertexAttribArray(l.attribute.pos), r.vertexAttribPointer(l.attribute.pos, 2, r.FLOAT, !1, o, 0 * e), r.enableVertexAttribArray(l.attribute.uv), r.vertexAttribPointer(l.attribute.uv, 2, r.FLOAT, !1, o, 2 * e), t.__program = l, l }, _ = { INTERMEDIATE: 1 }, p = {}; p.VERTEX_IDENTITY = ["precision highp float;", "attribute vec2 pos;", "attribute vec2 uv;", "varying vec2 vUv;", "uniform float flipY;", "void main(void) {", "vUv = uv;", "gl_Position = vec4(pos.x, pos.y*flipY, 0.0, 1.);", "}"].join("\n"), p.FRAGMENT_IDENTITY = ["precision highp float;", "varying vec2 vUv;", "uniform sampler2D texture;", "void main(void) {", "gl_FragColor = texture2D(texture, vUv);", "}"].join("\n"); var R = { colorMatrix: function (t) { var e = new Float32Array(t); e[4] /= 255, e[9] /= 255, e[14] /= 255, e[19] /= 255; var o = 1 == e[18] && 0 == e[3] && 0 == e[8] && 0 == e[13] && 0 == e[15] && 0 == e[16] && 0 == e[17] && 0 == e[19] ? R.colorMatrix.SHADER.WITHOUT_ALPHA : R.colorMatrix.SHADER.WITH_ALPHA, i = T(o); r.uniform1fv(i.uniform.m, e), g() } }; R.colorMatrix.SHADER = {}, R.colorMatrix.SHADER.WITH_ALPHA = ["precision highp float;", "varying vec2 vUv;", "uniform sampler2D texture;", "uniform float m[20];", "void main(void) {", "vec4 c = texture2D(texture, vUv);", "gl_FragColor.r = m[0] * c.r + m[1] * c.g + m[2] * c.b + m[3] * c.a + m[4];", "gl_FragColor.g = m[5] * c.r + m[6] * c.g + m[7] * c.b + m[8] * c.a + m[9];", "gl_FragColor.b = m[10] * c.r + m[11] * c.g + m[12] * c.b + m[13] * c.a + m[14];", "gl_FragColor.a = m[15] * c.r + m[16] * c.g + m[17] * c.b + m[18] * c.a + m[19];", "}"].join("\n"), R.colorMatrix.SHADER.WITHOUT_ALPHA = ["precision highp float;", "varying vec2 vUv;", "uniform sampler2D texture;", "uniform float m[20];", "void main(void) {", "vec4 c = texture2D(texture, vUv);", "gl_FragColor.r = m[0] * c.r + m[1] * c.g + m[2] * c.b + m[4];", "gl_FragColor.g = m[5] * c.r + m[6] * c.g + m[7] * c.b + m[9];", "gl_FragColor.b = m[10] * c.r + m[11] * c.g + m[12] * c.b + m[14];", "gl_FragColor.a = c.a;", "}"].join("\n"), R.brightness = function (r) { var t = (r || 0) + 1; R.colorMatrix([t, 0, 0, 0, 0, 0, t, 0, 0, 0, 0, 0, t, 0, 0, 0, 0, 0, 1, 0]) }, R.saturation = function (r) { var t = 2 * (r || 0) / 3 + 1, e = -.5 * (t - 1); R.colorMatrix([t, e, e, 0, 0, e, t, e, 0, 0, e, e, t, 0, 0, 0, 0, 0, 1, 0]) }, R.desaturate = function () { R.saturation(-1) }, R.contrast = function (r) { var t = (r || 0) + 1, e = -128 * (t - 1); R.colorMatrix([t, 0, 0, 0, e, 0, t, 0, 0, e, 0, 0, t, 0, e, 0, 0, 0, 1, 0]) }, R.negative = function () { R.contrast(-2) }, R.hue = function (r) { r = (r || 0) / 180 * Math.PI; var t = Math.cos(r), e = Math.sin(r), o = .213, i = .715, a = .072; R.colorMatrix([o + .787 * t + e * -o, i + t * -i + e * -i, a + t * -a + .928 * e, 0, 0, o + t * -o + .143 * e, i + t * (1 - i) + .14 * e, a + t * -a + -.283 * e, 0, 0, o + t * -o + -.787 * e, i + t * -i + e * i, a + .928 * t + e * a, 0, 0, 0, 0, 0, 1, 0]) }, R.desaturateLuminance = function () { R.colorMatrix([.2764723, .929708, .0938197, 0, -37.1, .2764723, .929708, .0938197, 0, -37.1, .2764723, .929708, .0938197, 0, -37.1, 0, 0, 0, 1, 0]) }, R.sepia = function () { R.colorMatrix([.393, .7689999, .18899999, 0, 0, .349, .6859999, .16799999, 0, 0, .272, .5339999, .13099999, 0, 0, 0, 0, 0, 1, 0]) }, R.brownie = function () { R.colorMatrix([.5997023498159715, .34553243048391263, -.2708298674538042, 0, 47.43192855600873, -.037703249837783157, .8609577587992641, .15059552388459913, 0, -36.96841498319127, .24113635128153335, -.07441037908422492, .44972182064877153, 0, -7.562075277591283, 0, 0, 0, 1, 0]) }, R.vintagePinhole = function () { R.colorMatrix([.6279345635605994, .3202183420819367, -.03965408211312453, 0, 9.651285835294123, .02578397704808868, .6441188644374771, .03259127616149294, 0, 7.462829176470591, .0466055556782719, -.0851232987247891, .5241648018700465, 0, 5.159190588235296, 0, 0, 0, 1, 0]) }, R.kodachrome = function () { R.colorMatrix([1.1285582396593525, -.3967382283601348, -.03992559172921793, 0, 63.72958762196502, -.16404339962244616, 1.0835251566291304, -.05498805115633132, 0, 24.732407896706203, -.16786010706155763, -.5603416277695248, 1.6014850761964943, 0, 35.62982807460946, 0, 0, 0, 1, 0]) }, R.technicolor = function () { R.colorMatrix([1.9125277891456083, -.8545344976951645, -.09155508482755585, 0, 11.793603434377337, -.3087833385928097, 1.7658908555458428, -.10601743074722245, 0, -70.35205161461398, -.231103377548616, -.7501899197440212, 1.847597816108189, 0, 30.950940869491138, 0, 0, 0, 1, 0]) }, R.polaroid = function () { R.colorMatrix([1.438, -.062, -.062, 0, 0, -.122, 1.378, -.122, 0, 0, -.016, -.016, 1.483, 0, 0, 0, 0, 0, 1, 0]) }, R.shiftToBGR = function () { R.colorMatrix([0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0]) }, R.convolution = function (t) { var e = new Float32Array(t), o = 1 / u, i = 1 / c, a = T(R.convolution.SHADER); r.uniform1fv(a.uniform.m, e), r.uniform2f(a.uniform.px, o, i), g() }, R.convolution.SHADER = ["precision highp float;", "varying vec2 vUv;", "uniform sampler2D texture;", "uniform vec2 px;", "uniform float m[9];", "void main(void) {", "vec4 c11 = texture2D(texture, vUv - px);", "vec4 c12 = texture2D(texture, vec2(vUv.x, vUv.y - px.y));", "vec4 c13 = texture2D(texture, vec2(vUv.x + px.x, vUv.y - px.y));", "vec4 c21 = texture2D(texture, vec2(vUv.x - px.x, vUv.y) );", "vec4 c22 = texture2D(texture, vUv);", "vec4 c23 = texture2D(texture, vec2(vUv.x + px.x, vUv.y) );", "vec4 c31 = texture2D(texture, vec2(vUv.x - px.x, vUv.y + px.y) );", "vec4 c32 = texture2D(texture, vec2(vUv.x, vUv.y + px.y) );", "vec4 c33 = texture2D(texture, vUv + px );", "gl_FragColor = ", "c11 * m[0] + c12 * m[1] + c22 * m[2] +", "c21 * m[3] + c22 * m[4] + c23 * m[5] +", "c31 * m[6] + c32 * m[7] + c33 * m[8];", "gl_FragColor.a = c22.a;", "}"].join("\n"), R.detectEdges = function () { R.convolution.call(this, [0, 1, 0, -3, 1, 0, 1, 0]) }, R.sobelX = function () { R.convolution.call(this, [-1, 0, 1, -2, 0, 2, -1, 0, 1]) }, R.sobelY = function () { R.convolution.call(this, [-1, -2, -1, 0, 0, 0, 1, 2, 1]) }, R.sharpen = function (r) { var t = r || 1; R.convolution.call(this, [0, -1 * t, 0, -1 * t, 1 + 4 * t, -1 * t, 0, -1 * t, 0]) }, R.emboss = function (r) { var t = r || 1; R.convolution.call(this, [-2 * t, -1 * t, 0, -1 * t, 1, 1 * t, 0, 1 * t, 2 * t]) }, R.blur = function (t) { var e = t / 7 / u, o = t / 7 / c, i = T(R.blur.SHADER); r.uniform2f(i.uniform.px, 0, o), g(_.INTERMEDIATE), r.uniform2f(i.uniform.px, e, 0), g() }, R.blur.SHADER = ["precision highp float;", "varying vec2 vUv;", "uniform sampler2D texture;", "uniform vec2 px;", "void main(void) {", "gl_FragColor = vec4(0.0);", "gl_FragColor += texture2D(texture, vUv + vec2(-7.0*px.x, -7.0*px.y))*0.0044299121055113265;", "gl_FragColor += texture2D(texture, vUv + vec2(-6.0*px.x, -6.0*px.y))*0.00895781211794;", "gl_FragColor += texture2D(texture, vUv + vec2(-5.0*px.x, -5.0*px.y))*0.0215963866053;", "gl_FragColor += texture2D(texture, vUv + vec2(-4.0*px.x, -4.0*px.y))*0.0443683338718;", "gl_FragColor += texture2D(texture, vUv + vec2(-3.0*px.x, -3.0*px.y))*0.0776744219933;", "gl_FragColor += texture2D(texture, vUv + vec2(-2.0*px.x, -2.0*px.y))*0.115876621105;", "gl_FragColor += texture2D(texture, vUv + vec2(-1.0*px.x, -1.0*px.y))*0.147308056121;", "gl_FragColor += texture2D(texture, vUv                             )*0.159576912161;", "gl_FragColor += texture2D(texture, vUv + vec2( 1.0*px.x,  1.0*px.y))*0.147308056121;", "gl_FragColor += texture2D(texture, vUv + vec2( 2.0*px.x,  2.0*px.y))*0.115876621105;", "gl_FragColor += texture2D(texture, vUv + vec2( 3.0*px.x,  3.0*px.y))*0.0776744219933;", "gl_FragColor += texture2D(texture, vUv + vec2( 4.0*px.x,  4.0*px.y))*0.0443683338718;", "gl_FragColor += texture2D(texture, vUv + vec2( 5.0*px.x,  5.0*px.y))*0.0215963866053;", "gl_FragColor += texture2D(texture, vUv + vec2( 6.0*px.x,  6.0*px.y))*0.00895781211794;", "gl_FragColor += texture2D(texture, vUv + vec2( 7.0*px.x,  7.0*px.y))*0.0044299121055113265;", "}"].join("\n") };

    window.anipartiBaseURL = aviewer.serverUrl;
   
    aviewer.api = function (api, data, success, failed, binary) {


        var request = {
            url: aviewer.serverUrl + '/aniparti/' + api, method: "POST", data: data, dataType: "json",
            success: function (res) {
                success(res);

            },
            error: function (err) {
                window.ui.hideProcessing();
                if (failed)failed(err.responseJSON); else console.error(err);
            },

        };
        if (binary) {
            request.contentType = false;
            request.processData = false;
            delete request.dataType;
        }
        if (aviewer.userAccessToken) {
            console.log("aviewer.userAccessToken", aviewer.userAccessToken);
            request.beforeSend = function (xhr, settings) {
                
                xhr.setRequestHeader('Authorization', 'Bearer ' + aviewer.userAccessToken);
            }
        }


        $.ajax(request);

    };
   

    aviewer.uploadFile = function (file, done, qry) {
        var fd = new FormData();
        fd.append("file", file);
        aviewer.api('upload_file_av' + (qry ? '?' + qry : ''), fd, function (res) {
            if (done) done(res.url);
        }, false, true);

    };

  

    aviewer.viewerArea = $("#viewerArea");
    //aviewer.viewerArea.hide();

   
    $(".sidebarButton").parent().remove();
    $(".list-title").css("font-size", "14px");

    window.convertoFloat32ToInt16 = function (buffer) {
        var l = buffer.length;  //Buffer
        var buf = new Int16Array(l / 1);
        while (l--) {
            s = Math.max(-1, Math.min(1, buffer[l]));
            buf[l] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }


        return buf;
    };

    aviewer.dubbedSounds = {};
    aviewer.dubbedImages = {};
    aviewer.dubbedObjects = {};
    window.anipartiViewerOverride = window.anipartiViewerOverride || [];
    aviewer.userDubbedSounds = {};
    aviewer.userDubbedSoundsApplied = {};
    Math.dist = function (x1, y1, x2, y2) { return Math.abs(Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1))); };

    window.anipartiViewerOverride.push(function (viewer) {
        console.log("viewer", viewer);
        viewer.PIXI = viewer.getPIXI();

      
        viewer.isUGCVersion = aviewer.isUGCVersion;

        viewer.actions["SaveAndShareUGC"] = function (slide, action) {
            aviewer.app.saveAndShareUGC(true);
        };

        viewer.actions["SoundDubbing"] = function (slide, action) {

            console.log("action.soundMappingName", action.soundMappingName);
            if (action.soundMappingName == "") return;

            var mp = slide.mappingNames[action.soundMappingName];
            
            if (mp && mp.soundBuffer) {
                var destAudio = viewer.soundManager.buffers[mp.soundBuffer];
                aviewer.dubAudio(function (data) {

                    var numChannels = audioinput._cfg.channels;
                    var audioBuffer = viewer.soundManager.context.createBuffer(numChannels, (data.length / numChannels), audioinput._cfg.sampleRate);

                    var i, index = 0, channel;
                    for (i = 0; i < numChannels; i++) {
                        channels = audioBuffer.getChannelData(i);
                        while (index < data.length) {
                            channels[index] = data[index + i];
                            index += numChannels;
                        }
                    }
                    destAudio.ab = audioBuffer;
                    aviewer.dubbedSounds[mp.soundBuffer] = { buff: audioBuffer, data: data };
                    ui.modals.info("Dubbing Audio", "<h4 style='color:black'>Audio has been updated</h4>");
                    console.log("audioBuffer", audioBuffer);


                });


            }




        };

        viewer.actions["OpenProjectById"] = function (slide, action) {
            window.ui.showProcessing();
            aviewer.api("get_repo_public", { id: window.parseItemTags(action.projectId, function (k) { return (eval(k));}) }, function (res) {
                window.ui.hideProcessing();
                window.loadContent(res.data.content);
            });
        };

        viewer.actions["QRCodeActions"] = function (slide, action) {
            console.log(action);
            cordova.plugins.barcodeScanner.scan(
               function (result) {

                   if (!result.cancelled) {
                       viewer.QRCodeText = result.text;
                       
                       action.ActionsList.forEach(function (item) {
                           slide.executeAction(item.action);
                       });
                   }
                

               },
               function (error) {
                   alert("Scanning failed: " + error);
               },
               {
                   preferFrontCamera: false, // iOS and Android
                   showFlipCameraButton: true, // iOS and Android
                   showTorchButton: true, // iOS and Android
                   torchOn: false, // Android, launch with the torch switched on (if available)
                   saveHistory: true, // Android, save scan history (default false)
                   prompt: "Place a barcode inside the scan area", // Android
                   resultDisplayDuration: 500, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
                   formats: "QR_CODE,PDF_417", // default: all but PDF_417 and RSS_EXPANDED
                   orientation: "portrait", // Android only (portrait|landscape), default unset so it rotates with the device
                   disableAnimations: true, // iOS
                   disableSuccessBeep: false // iOS and Android
               }
            );

        };

    
        viewer.events("SlideLoading", function (slide) {
            if (!aviewer.userDubbedImages) aviewer.userDubbedImages = {};
            slide.layers.forEach(function (layer) {
                layer.objects.forEach(function (obj) {
                    if (aviewer.userDubbedImages[slide.uuid + "." + obj.uuid]) {
                        var mm = aviewer.userDubbedImages[slide.uuid + "." + obj.uuid];
                       
                        if (mm.action == "ModifyMaskingImage") {
                            obj.component.backImage = mm.uploaded;
                            slide.preloading.push({ imageUrl: obj.component.backImage });
                        }
                        else {
                            obj.imageUrl = mm.uploaded;
                            slide.preloading.push({ imageUrl: obj.imageUrl });
                        }
                      
                        
                        if (mm.emojs) {
                            mm.emojs.forEach(function (emoj) {
                               // emoj.image = emoj.image.replace(viewer.resourceUrl, "");
                                slide.preloading.push({ imageUrl: emoj.image });
                            });
                        }
                    }
                });
            });
            slide.preloading.forEach(function (item) {
                if (item.soundBuffer) {
                    if (aviewer.userDubbedSounds[item.soundBuffer]) {
                        aviewer.userDubbedSoundsApplied[aviewer.userDubbedSounds[item.soundBuffer]] = item.soundBuffer;
                        item.soundBuffer = aviewer.userDubbedSounds[item.soundBuffer];
                    }
                }

            });
        });

        viewer.events("SlideLoaded", function (slide) {
            var PIXI = viewer.getPIXI();
            
           
            if (slide.uuid == "MainSlide") {

                
            } else {
                for (var s in aviewer.userDubbedSoundsApplied) {
                    viewer.soundManager.buffers[aviewer.userDubbedSoundsApplied[s]] = viewer.soundManager.buffers[s];
                }

                slide.layers.forEach(function (layer) {
                    layer.objects.forEach(function (obj) {
                        if (aviewer.userDubbedImages[slide.uuid + "." + obj.uuid]) {
                            var mm = aviewer.userDubbedImages[slide.uuid + "." + obj.uuid];
                            console.log("dubb mm", mm);
                            console.log("dubb image", obj);
                            var emojs = mm.emojs;
                            if (emojs) {
                                emojs.forEach(function (emoj) {
                                    if (!viewer.emojs[emoj.image]) {
                                        var tex = viewer.getTexture(emoj.image); // PIXI.Texture.fromImage(emoj.image);
                                        // tex.baseTexture.width = emoj.width;
                                        // tex.baseTexture.height = emoj.height;
                                        viewer.emojs[emoj.image] = new viewer.spriteSheet(tex, { rows: 1, cols: emoj.width / emoj.height }, slide);

                                    }
                                    var s = viewer.emojs[emoj.image].createInstance();
                                    s.slide = slide;
                                    s.x = emoj.x;
                                    s.y = emoj.y;
                                    s.scale.x = emoj.sx; s.scale.y = emoj.sy;
                                    s.startSprite(emoj.speed * (emoj.width / emoj.height));
                                    obj.pixi.addChild(s);
                                });
                            }

                            if (mm.action == "ModifyMaskingImage") {
                            

                                obj.pixi.backImage.scale.x = parseFloat(mm.scaleX);
                                obj.pixi.backImage.scale.y = parseFloat(mm.scaleY);
                                obj.pixi.backImage.rotation = parseFloat(mm.rotation);

                                obj.pixi.backImage.anchor.x = parseFloat(mm.anchorX);
                                obj.pixi.backImage.anchor.y = parseFloat(mm.anchorY);

                                console.log("ModifyMaskingImage");
                            }

                        }
                    });
                });

            }


        });
        window.sideBarButton = $(".sidebarButton");
        viewer.events("RenderEventTime", function () {
            window.sideBarButton.show();
        });
       
        viewer.emojs = {};
       
        viewer.actions["MoveToNextSlide"] = function (slide, action) {
            slide.readyToMoveNextSlide = true;
            console.log("MoveToNextSlide");
        };

      

        viewer.actions["ModifyMaskingImage"] = function (slide, action) {

            aviewer.maskingImageAction = action;
            aviewer.maskingImageSlide = slide;
            var startMaskingImageEditor = function (userimage) {
                var pixi = slide.objects[action.imageName];
                aviewer.maskingImageSlide.pause();
                $(".navigationBar").hide();
                var PIXI = viewer.getPIXI();
         

                var mw = viewer.width(), mh = viewer.height();
                var mw2 = mw / 2;
                var mh2 = mh / 2;

                var canv = aviewer.app.dubImagCanv;


               var sw = pixi.maskingImage.texture.baseTexture.width;
               var sh = pixi.maskingImage.texture.baseTexture.height;

                canv.setSize(sw, sh * 2);


                canv.ctx.fillStyle = "transparent";
                canv.ctx.fillRect(0, 0, sw, sh*2);

                canv.ctx.drawImage(pixi.maskingImage.texture.baseTexture.source, (canv.width / 2) - (sw / 2), (canv.height / 2) - (sh / 2));



                var imageData = canv.ctx.getImageData(0, 0, canv.width, canv.height);
                var data = imageData.data;
                for (var p = 0, len = data.length; p < len; p += 4) {
                    data[p + 0] = 1; data[p + 1] = 1; data[p + 2] = 1;
                    if (data[p + 3] == 0) {
                        data[p + 3] = 200;
                    }
                    else if (data[p + 3] == 255) {
                        data[p + 3] = 0;
                    }
                   

                }
                canv.ctx.putImageData(imageData, 0, 0);


                var scale = mw / sw

                window.ui.hideProcessing();

               
                var pixiContainer = viewer.maskingImageContainer;
                if (!pixiContainer) {
                    pixiContainer = new PIXI.Container();
                    viewer.pixiStage.addChild(pixiContainer);

                    var backDrop = new PIXI.Sprite(PIXI.Texture.WHITE);
                    pixiContainer.addChild(backDrop);
                    backDrop.anchor.set(0.5);
                    backDrop.scale.set(100);

                    pixiContainer.maskingImage = new PIXI.Sprite(PIXI.Texture.WHITE);
                    pixiContainer.maskingImage.anchor.set(0.5);

                    pixiContainer.backImage = new PIXI.Sprite(PIXI.Texture.WHITE);

                    pixiContainer.frontImage = new PIXI.Sprite(PIXI.Texture.WHITE);
                    pixiContainer.addChild(pixiContainer.backImage);
                    pixiContainer.addChild(pixiContainer.maskingImage);
                    pixiContainer.addChild(pixiContainer.frontImage);

                    pixiContainer.backImage.interactive = true;
                    pixiContainer.backImage.on('pointerdown', function (event) {
                        this.lx = event.data.global.x;
                        this.ly = event.data.global.y;
                        this.dragging = true;
                    });

                    pixiContainer.backImage.on('pointerup', function (event) {
                        this.dragging = false;
                    });

                    pixiContainer.backImage.on('pointermove', function (event) {
                        if (this.dragging) {

                            var dx = ((event.data.global.x - this.lx) );
                            var dy = ((event.data.global.y - this.ly) );

                            var cos = Math.cos(this.rotation);
                            var sin = Math.sin(this.rotation);

                            var dxx = ((cos * dx) + (sin * dy));
                            var dyy = ((cos * dy) - (sin * dx));

                            this.ax += dxx;
                            this.ay += dyy;



                            this.anchor.x = 0.5 - (this.ax / this.texture.baseTexture.width);
                            this.anchor.y = 0.5 - (this.ay / this.texture.baseTexture.height);



                            this.lx = event.data.global.x;
                            this.ly = event.data.global.y;
                        }
                        event.stopPropagation();
                    });

                    viewer.maskingImageContainer = pixiContainer;
                }

                pixiContainer.maskingImage.texture = PIXI.Texture.fromImage(canv.toDataURL("image/png"));
                if (pixi.frontImage) {
                    pixiContainer.frontImage.visible = true;
                    pixiContainer.frontImage.texture = pixi.frontImage.texture;
                    pixiContainer.frontImage.anchor.set(0.5);
                    pixiContainer.frontImage.scale.x = pixi.frontImage.scale.x;
                    pixiContainer.frontImage.scale.y = pixi.frontImage.scale.y;
                    pixiContainer.frontImage.x = pixi.frontImage.x;
                    pixiContainer.frontImage.y = pixi.frontImage.y;
                    pixiContainer.frontImage.rotation = pixi.frontImage.rotation;
                }
                else {
                    pixiContainer.frontImage.visible = false;
                }

                var imageWidth = userimage.width;
                var imageHeight = userimage.height;
                var imageSize = sw * 3;
                if (userimage.width > imageSize) {
                    imageHeight *= imageSize / imageWidth;
                    imageWidth = imageSize;
                }

                canv.setSize(imageWidth, imageHeight);
                canv.ctx.drawImage(userimage, 0, 0, userimage.width, userimage.height, 0, 0, imageWidth, imageHeight);
                

                pixiContainer.backImage.texture = PIXI.Texture.fromImage(canv.toDataURL("image/png"));

                pixiContainer.backImage.scale.x = 1;
                pixiContainer.backImage.scale.y = 1;
                pixiContainer.backImage.rotation = 0;

                pixiContainer.backImage.anchor.set(0.5);
                pixiContainer.backImage.ax = 0;
                pixiContainer.backImage.ay = 0;            
                

                pixiContainer.scale.x = scale;
                pixiContainer.scale.y = scale;
                pixiContainer.x = mw2;
                pixiContainer.y = mh2;

                pixiContainer.visible = true;

                aviewer.maskingImageContainer = pixiContainer;
                aviewer.maskingImagePIXI = pixi;
                if (!aviewer.maskingImageManipulator) {

                    aviewer.maskingImageManipulator = $(aviewer.maskingImageManipulatorUI);
                    aviewer.maskingImageManipulator.css("width", mw + "px").css("height", mh + "px");

                    aviewer.maskingImageManipulatorTitle = aviewer.maskingImageManipulator.find(".maskingImageManipulatorTitle");
                  

                    aviewer.maskingImageRotator = aviewer.maskingImageManipulator.find(".maskingImageRotator");

                    aviewer.maskingImageRotator.on("input", function () {
                        aviewer.maskingImageContainer.backImage.rotation = (parseFloat(this.value)) * DEG_TO_RAD_HELP;
                    });

                    aviewer.maskingImageScaler = aviewer.maskingImageManipulator.find(".maskingImageScaler");
                    aviewer.maskingImageManipulator.find(".maskingImageScalerPOS").css("margin-top", (mw / 2) + "px");
                    aviewer.maskingImageManipulator.find(".maskingImageScalerPOS.fa-plus").css("margin-top", -(mw / 2) + "px");
                    
                    aviewer.maskingImageScaler.on("input", function () {
                        var s = 1 * ((parseInt(this.value)) / 50);
                        aviewer.maskingImageContainer.backImage.scale.x = s;
                        aviewer.maskingImageContainer.backImage.scale.y = s;
                    });

                    aviewer.maskingImageConfirmButton = aviewer.maskingImageManipulator.find(".maskingImageConfirmButton");
                    aviewer.maskingImageConfirmButton.on("touchend click", function (e) {
                        e.stopPropagation(); e.preventDefault();
                        var key = aviewer.maskingImageSlide.uuid + "." + aviewer.maskingImageAction.imageName;
                        var item = {
                            key: key, slide: aviewer.maskingImageSlide.uuid, imageName: aviewer.maskingImageAction.imageName, action: aviewer.maskingImageAction.actionName,
                            dataUrl: aviewer.maskingImageContainer.backImage.texture.baseTexture.source.src,
                            scaleX: aviewer.maskingImageContainer.backImage.scale.x.toFixed(3),
                            scaleY: aviewer.maskingImageContainer.backImage.scale.y.toFixed(3),
                            rotation: aviewer.maskingImageContainer.backImage.rotation.toFixed(4),
                            anchorX: aviewer.maskingImageContainer.backImage.anchor.x.toFixed(3),
                            anchorY: aviewer.maskingImageContainer.backImage.anchor.y.toFixed(3)
                        };
                        aviewer.dubbedImages[key] = item;
                        console.log("aviewer.dubbedImages", aviewer.dubbedImages);
                        aviewer.maskingImagePIXI.backImage.texture = PIXI.Texture.fromImage(item.dataUrl);
                        aviewer.maskingImagePIXI.backImage.anchor.x =parseFloat(item.anchorX);
                        aviewer.maskingImagePIXI.backImage.anchor.y = parseFloat(item.anchorY);
                        aviewer.maskingImagePIXI.backImage.scale.x = parseFloat(item.scaleX);
                        aviewer.maskingImagePIXI.backImage.scale.y = parseFloat(item.scaleX);
                        aviewer.maskingImagePIXI.backImage.rotation = parseFloat(item.rotation);

                        aviewer.maskingImageContainer.visible = false;
                        aviewer.maskingImageSlide.resume();
                        $(".navigationBar").show();
                        aviewer.maskingImageManipulator.hide();
                        

                    });
                    

                    aviewer.maskingImageCancelButton = aviewer.maskingImageManipulator.find(".maskingImageCancelButton");
                    aviewer.maskingImageManipulator.append(aviewer.maskingImageCancelButton);
                    aviewer.maskingImageCancelButton.on("click", function (e) {
                        e.stopPropagation(); e.preventDefault();
                        aviewer.maskingImageContainer.visible = false;
                        aviewer.maskingImageSlide.resume();
                        $(".navigationBar").show();
                        aviewer.maskingImageManipulator.hide();

                    });
                }
                window.layoutContainer.append(aviewer.maskingImageManipulator);
                aviewer.maskingImageManipulator.show();
                aviewer.maskingImageRotator.val(0);
                aviewer.maskingImageScaler.val(50);
                aviewer.maskingImageManipulatorTitle.html(aviewer.maskingImageAction.editingTitle);

                //action.editingTitle

            };

          
      
            slide.pause();
            window.ui.modals.question("Upload Image", '').ready = function () {
                var md = this;
                md.$.css("min-width", "330px").css("width", "330px");
                md.$.find('.ui-ui-modal-ok-button').addClass('btn-success').html("Upload Image").fileUploadButtonEx({
                    accept: "image/*", onFileData: function (data) {
                        window.ui.showProcessing();
                        md.forceClose();
                        window.checkImageSource(data, function () {
                            var img = this;
                            $(".navigationBar").hide();
                            var div = $(aviewer.maskingImageFiltersUI);
                            window.layoutContainer.append(div);
                            
                            var canv = window.createCanvasObject(10, 10);
                            var imageWidth = this.width;
                            var imageHeight = this.height;
                            var imageSize = 1280;
                            if (this.width > imageSize) {
                                imageHeight *= imageSize / imageWidth;
                                imageWidth = imageSize;
                            }

                            canv.setSize(imageWidth, imageHeight);
                            canv.ctx.drawImage(this, 0, 0, this.width, this.height, 0, 0, imageWidth, imageHeight);
                            div.prepend(canv);
                            $(canv).css("position", "absolute").css("left", "20px").css("top", "30px")
                                .css("transform-origin","left top")
                                .css("transform", "scale(" + (((window.windowWidth-40) / imageWidth)) + ")");

                            window.ui.hideProcessing();
                            var completedImage = img;
                            img.onload = function () {

                                var filtersPresets = [
                                       { name: 'none', title: 'None' },
                                       { name: 'negative', title: 'Negative' },
                                       { name: 'brightness', args: [1.5], title: 'Brightness' },
                                       { name: 'saturation', args: [1.5], title: 'Saturation' },
                                       { name: 'contrast', args: [1.5], title: 'Contrast' },
                                       { name: 'hue', args: [180], title: 'Hue' },
                                       { name: 'desaturate', title: 'Desaturate' },
                                       { name: 'desaturateLuminance', title: 'Desaturate Luminance' },
                                       { name: 'brownie', title: 'Brownie' },
                                       { name: 'sepia', title: 'Sepia' },
                                       { name: 'vintagePinhole', title: 'Vintage Pinhole' },
                                       { name: 'kodachrome', title: 'Kodachrome' },
                                       { name: 'technicolor', title: 'Technicolor' },
                                       { name: 'detectEdges', title: 'Detect Edges' },
                                       { name: 'sharpen', title: 'Sharpen' },
                                       { name: 'emboss', title: 'Emboss' },
                                       { name: 'blur', args: [7], title: 'Blur' }];

                                var filterObject = new window.WebGLImageFilter();

                                var applyFilter = function (f) {
                                    if (f.name == 'none') return;
                                    filterObject.addFilter(f.name, f.args);
                                };
                                var filtersTab = div.find(".filtersTab");

                                filtersTab.find(".nav-tabs").find("a").click(function (e) {
                                    filtersTab.find(".nav-tabs").find("li.active").removeClass("active");
                                    $(this.parentNode).addClass("active");
                                    var tab = this.getAttribute("href").replace("#", "");
                                    filtersTab.find(".tab-pane").hide();
                                    filtersTab.find(".tab-pane." + tab).show();
                                    e.stopPropagation(); e.preventDefault();

                                });

                                filtersTab.filterIndex = [filtersPresets[0], filtersPresets[0], filtersPresets[0]];

                                filtersTab.filterButtonClick = function () {

                                    $(this.parentNode).find("button.active").removeClass("active");
                                    $(this).addClass("active");
                                    filtersTab.filterIndex[this.filterIndex] = this.filter;

                                    filterObject.reset();
                                    filtersTab.filterIndex.forEach(function (f) {
                                        applyFilter(f);
                                    });
                                    completedImage = filterObject.apply(img);
                                    canv.ctx.drawImage(completedImage, 0, 0);

                                };
                              

                                var index = 0;
                                filtersTab.find(".tab-pane").each(function () {
                                    var cont = $('<div style="height:100px"></div>');
                                    cont.css("min-width", (window.windowWidth * 4.2) + "px");
                                    for (var i = 0; i < filtersPresets.length; i++) {                                       
                                        var btn = $('<button class="btn btn-sm"></button>');
                                        btn.css("width", (window.windowWidth / 2.3) + "px");
                                        btn.html(filtersPresets[i].title);
                                        cont.append(btn);
                                        btn[0].filter = filtersPresets[i];
                                        btn[0].onclick = filtersTab.filterButtonClick;
                                        btn[0].filterIndex = index;
                                        if (btn[0].filter.name == "none") btn.addClass("active");
                                    }
                                    $(this).append(cont);
                                    index++;
                                });

                                
                            };

                           

                            img.src = canv.toDataURL("image/png");

                            
                           

                            div.find(".maskingImageConfirmButton").on("click",function (e) {
                              
                                delete canv;
                                delete img;
                                div.remove();
                                e.stopPropagation();
                                startMaskingImageEditor(completedImage);
                            });

                            div.find(".maskingImageCancelButton").on("touchend click", function (e) {
                                delete canv;
                                div.remove();
                                slide.resume();
                                e.stopPropagation();
                                $(".navigationBar").show();
                            });
                            
                            
                        });
                    }
                });

                md.closing = function (res) {
                   if(!res) slide.resume();
                    return (!res);
                };



                md.$.find('.ui-ui-modal-cancel-button').html("Cancel");


            };

        };

        viewer.actions["ModifyImage"] = function (slide, action) {
           if (action.actionCompleted) return;

            var pixi = slide.objects[action.imageName];
            slide.pause();
            console.log(pixi);

            //viewer.textures.nextPageImage = PIXI.Texture.fromImage(window.anipartiMainURL + "/global/img/nextPage.jpg");
            aviewer.modifyImage(function (url,emojs) {
                var tx = viewer.PIXI.Texture.fromImage(url);
                pixi.texture = tx;

                pixi.removeChildren();
                if (emojs) {
                    emojs.forEach(function (emoj) {
                        if (!viewer.emojs[emoj.image]) {
                            var tex = viewer.PIXI.Texture.fromImage(emoj.image);
                            tex.baseTexture.width = emoj.width;
                            tex.baseTexture.height = emoj.height;
                            viewer.emojs[emoj.image] = new viewer.spriteSheet(tex, { rows: 1, cols: emoj.width / emoj.height }, slide);
                          
                        }
                        var s = viewer.emojs[emoj.image].createInstance();
                       
                        s.slide = slide;
                        s.x = emoj.x;
                        s.y = emoj.y;
                        s.scale.x = emoj.sx; s.scale.y = emoj.sy;
                        s.startSprite(emoj.speed * (emoj.width / emoj.height));
                        pixi.addChild(s);
                    });
                }
             
                slide.resume();
                setTimeout(function (pixi) {
                    pixi.scale.x = pixi.obj.scaleX * pixi.displayScale;
                    pixi.scale.y = pixi.obj.scaleY * pixi.displayScale;
                    //viewer.resume();
                    if (action.oneTimeAction) action.actionCompleted = true;
                    var key=slide.uuid + "." + action.imageName;
                    aviewer.dubbedImages[key] = {
                        key: key, slide: slide.uuid, imageName: action.imageName, dataUrl: url, emojs: emojs
                    };





                }, 50,pixi);
             
            }, pixi._texture.baseTexture.width, pixi._texture.baseTexture.height, function () {
                slide.resume();
            }, action.editingTitle, action);
        };

        viewer.actions["ModifyDynamicText"] = function (slide, action) {
            var pixi = slide.objects[action.textName];
            slide.pause();
            var maxlength = parseInt("0" + action.maxTextLength);

            if (maxlength < 1) maxlength = 100;

            window.ui.modals.open({
                title: action.editingTitle, element: '<textarea data-bind="textBox" maxlength="'+maxlength+'" style="width:100%;margin-bottom:10px" rows="4"></textarea><h6 style="color:black" data-bind="showTextLength"></h6>',
               
            }).ready = function () {
                var md = this;
                md.setWidth("350px");
                window.bindElements(md.$, md);
                md.$.find(".ui-ui-modal-cancel-button").css("width", "130px");
                md.$.find(".ui-ui-modal-ok-button").css("width", "130px");
                md.textBox.$.val(pixi.pixiText.text);
                md.textBox.$.focus();
                

                md.showTextLength.$.html("more " + (maxlength - md.textBox.$.val().length));
                md.textBox.$.keypress(function () {
                    md.showTextLength.$.html("more " + (maxlength - md.textBox.$.val().length));

                });
                md.closing = function (res) {

                    if (res) {
                        pixi.pixiText.text = md.textBox.$.val();
                        if (window.currentTextDictionary) {
                            if (!window.currentTextDictionary.languages["ugc"]) {
                                window.currentTextDictionary.languages["ugc"] = {};
                                for (var c in window.currentTextDictionary.languages[window.selectedViewerLanguage]) {
                                    window.currentTextDictionary.languages["ugc"][c] = window.currentTextDictionary.languages[window.selectedViewerLanguage][c];

                                }
                                window.selectedViewerLanguage = "ugc";
                                window.currentTextDictionary.currentLanguage = window.currentTextDictionary.languages["ugc"];

                            }
                            window.currentTextDictionary.languages["ugc"][pixi.obj.component.textId] = pixi.pixiText.text;
                        }
                        
                        if (!aviewer.dubbedObjects["ugc_dictionary"]) aviewer.dubbedObjects["ugc_dictionary"] = { defLng: window.selectedViewerLanguage, codes: {}};
                        aviewer.dubbedObjects["ugc_dictionary"].codes[pixi.obj.component.textId] = pixi.pixiText.text;
                        console.log("aviewer.dubbedObjects", aviewer.dubbedObjects);

                    }
                    slide.resume();
                    //pixi.obj.component.textId
                    return (true);
                }
            };

        };

        viewer.actions["EditSmartText"] = function (slide, action) {
            var pixi = slide.objects[action.textName];
            pixi.pixiText = pixi.obj.pixiText;
            slide.pause();
            var maxlength = parseInt("0" + action.maxTextLength);

            if (maxlength < 1) maxlength = 100;

            window.ui.modals.open({
                title: action.editingTitle, element: '<textarea data-bind="textBox" maxlength="' + maxlength + '" style="width:100%;margin-bottom:10px" rows="4"></textarea><h6 style="color:black" data-bind="showTextLength"></h6>',

            }).ready = function () {
                var md = this;
                md.setWidth("350px");
                window.bindElements(md.$, md);
                md.$.find(".ui-ui-modal-cancel-button").css("width", "130px");
                md.$.find(".ui-ui-modal-ok-button").css("width", "130px");
                md.textBox.$.val(pixi.pixiText.text);
                md.textBox.$.focus();

                md.updateTextLengthInfo = function () {
                    md.showTextLength.$.html(md.textBox.$.val().length + "/" + maxlength);
                };
                md.updateTextLengthInfo();
                md.textBox.$.keydown(md.updateTextLengthInfo);
                md.closing = function (res) {


                    if (res) {
                        pixi.pixiText.text = md.textBox.$.val();
                        if (window.currentTextDictionary) {
                            if (!window.currentTextDictionary.languages["ugc"]) {
                                window.currentTextDictionary.languages["ugc"] = {};
                                for (var c in window.currentTextDictionary.languages[window.selectedViewerLanguage]) {
                                    window.currentTextDictionary.languages["ugc"][c] = window.currentTextDictionary.languages[window.selectedViewerLanguage][c];

                                }
                                window.selectedViewerLanguage = "ugc";
                                window.currentTextDictionary.currentLanguage = window.currentTextDictionary.languages["ugc"];

                            }
                            window.currentTextDictionary.languages["ugc"][pixi.obj.component.textId] = pixi.pixiText.text;
                        }

                        if (!aviewer.dubbedObjects["ugc_dictionary"]) aviewer.dubbedObjects["ugc_dictionary"] = { defLng: window.selectedViewerLanguage, codes: {} };
                        aviewer.dubbedObjects["ugc_dictionary"].codes[pixi.obj.component.textId] = pixi.pixiText.text;
                        console.log("aviewer.dubbedObjects", aviewer.dubbedObjects);

                        pixi.pixiText.updateTextTexture();

                    }
                    slide.resume();
                    //pixi.obj.component.textId
                    return (true);
                }
            };

        };

        viewer.improvedResourceLoader = window.improvedResourceLoader;
        viewer.loadSlideResources = function (slide, done) {
            viewer.improvedResourceLoader(slide, done); return;           

        };

        window.afterLanguageChanged = function () {
            window.currentTextDictionary.currentLanguage = window.currentTextDictionary.languages[window.selectedViewerLanguage];
            console.log("window.selectedViewerLanguage", window.selectedViewerLanguage);
            for (var i = 1; i < viewer.usedSlides.length; i++) {
                //console.log("[" + i + "]", viewer.usedSlides[i]);
                for (var o in viewer.usedSlides[i].objects) {
                    var pixi = viewer.usedSlides[i].objects[o];
                    if (pixi.obj && pixi.obj.componentId == "textSprite1.0") {
                        pixi.pixiText.text = window.currentTextDictionary.get(pixi.obj.component.textId);
                    }
                    else if (pixi.obj && pixi.obj.componentId == "smartText1.0") {
                        pixi.pixiText = pixi.obj.pixiText;
                        pixi.pixiText.text = window.currentTextDictionary.get(pixi.obj.component.textId);
                        pixi.pixiText.updateTextTexture();
                    }
                }
            }


            
        };

        if (window.currentTextDictionary1 && window.currentTextDictionary.languages) {
            window.currentTextDictionary.languages["ugc"] = {};
            for (var c in window.currentTextDictionary.currentLanguage) {
                window.currentTextDictionary.languages["ugc"][c] = window.currentTextDictionary.currentLanguage[c];
            }
        }
        if (window.currentTextDictionary) {

            delete window.currentTextDictionary.languages["ugc"];
            window.selectedViewerLanguage = window.realContent.projectSettings.viewerLanguage;
            window.currentTextDictionary.currentLanguage = window.currentTextDictionary.languages[window.selectedViewerLanguage];

        }
        if (aviewer.userDubbedObjects) {
          
            if (window.currentTextDictionary)
            {
                console.log("aviewer.userDubbedObjects", aviewer.userDubbedObjects);
                if (aviewer.userDubbedObjects["ugc_dictionary"]) {
                    
                    var uDict = aviewer.userDubbedObjects["ugc_dictionary"];
                    window.currentTextDictionary.languages["ugc"] = {};
                    for (var c in window.currentTextDictionary.languages[uDict.defLng]) {
                        window.currentTextDictionary.languages["ugc"][c] = window.currentTextDictionary.languages[uDict.defLng][c];
                    }
                    for (var c in uDict.codes) {
                        window.currentTextDictionary.languages["ugc"][c] = uDict.codes[c];
                    }

                    window.selectedViewerLanguage = "ugc";
                    setTimeout(function () { window.afterLanguageChanged(); }, 200);

                    delete aviewer.userDubbedObjects["ugc_dictionary"];
                }

                
            }

           
        }
       
        

    });

 
    aviewer.dubbAudioData = [];
    window.addEventListener("audioinput", function (evt) {
       // console.log("evt.data", evt.data);
        aviewer.dubbAudioData.push(evt.data);

    }, false);

    window.addEventListener("audioinputerror", function (error) {
        alert("onAudioInputError event recieved: " + JSON.stringify(error));
    }, false);
    aviewer.dubAudio = function (done) {
        
        if (!window.audioinput) {
            ui.modals.error("Dubbing Audio", "Not available on Web<br/>Please use App");
            return;
        }
       
        
        aviewer.dubAudioModal = ui.modals.info2("Dubbing Audio", aviewer.dubAudioUI);

        aviewer.dubAudioModal.ready = function () {
            var md = this;
            md.isRecording = false;
            md.recordingButtonClick = function () {
                md.startRecording();
                md.$.find(".badge-success").find("i").removeClass("fa-play").addClass("fa-check");
            };


            md.$.find(".badge-danger").click(function () {
                md.close(false);

            });

            md.$.find(".badge-success").click(function () {
                md.recordingButtonClick();

            });

            md.recordingTime = 0;

            md.recordingTimeDisplay = md.$.find(".recordingTimeDisplay");

            md.startRecording = function () {
                md.recordingStartTime = Date.now();
                md.recordingTimeDisplay.css("color", "black");
                ui.timer(1000, function () {
                    md.recordingTime = (Date.now() - md.recordingStartTime) / 1000;

                    // padString(parseInt((md.recordingTime / 60 / 60) % 60) + '', '00') + ":"
                    md.recordingTimeDisplay.html(

                        padString(parseInt((md.recordingTime / 60) % 60) + '', '00') + ":"
                        + padString(parseInt((md.recordingTime) % 60) + '', '00')
                        );
                    return (md.isRecording);
                });
                aviewer.dubbAudioData = [];
                audioinput.start({
                    sampleRate: audioinput.SAMPLERATE.CD_AUDIO_44100Hz,
                    bufferSize: 16384,
                    channels: audioinput.CHANNELS.MONO,
                    format: audioinput.FORMAT.PCM_16BIT,
                    normalize: true,
                    normalizationFactor: 32767.0,
                    audioSourceType: audioinput.AUDIOSOURCE_TYPE.DEFAULT
                });
                md.isRecording = true;

                md.recordingButtonClick = function () {
                    md.close(true);
                };
            };

            this.closing = function (res) {
                if (md.isRecording) {
                    audioinput.stop();
                }
                md.isRecording = false;
                if (res) {
                    var concatenatedData = [];
                    while (aviewer.dubbAudioData.length !== 0) {
                        if (aviewer.dubbAudioData.length === 0) {
                            break;
                        }
                        concatenatedData = concatenatedData.concat(aviewer.dubbAudioData.shift());
                    }
                    done(concatenatedData);

                }
                aviewer.dubAudioModal = false;
                return (true);
            };
        };



    };

    window.loadStyleSheetFile(document, window.appUrl + "/ui_libs.css?v1.00009");
    window.isOS = function () {
        return navigator.userAgent.match(/ipad|iphone/i);
    };

    window.selectText = function (txb) {
        var range,
            selection;

        if (window.isOS()) {
            range = document.createRange();
            range.selectNodeContents(txb);
            selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            txb.setSelectionRange(0, 999999);
        } else {
            txb.select();
        }
    };


    window.loadJSFile(document, window.appUrl + "/ui_libs.js?v1.00002").onload = function () {

       
        window.bindElements($(document.body), aviewer);
        aviewer.appView.$.uiViews({
            name: "aviewerApp",
            done:function(app) {

                aviewer.app = app;
               
                aviewer.app.toggleSidebar = function () {

                    $('.layout-container').toggleClass('sidebar');
                };
                aviewer.UGCLikes = {};

                app.logoutUser = function () {

                    window.ui.storage.remove("aviewerUser");
                    aviewer.user = null;
                    app.loginUser(function (user) {

                    });
                };

                app.registerUser = function (autoLogin) {
                    app.pushView({

                        html: aviewer.registerUserUI,
                        ready: function (view) {
                            /*
                            view.userPicture.$.fileUploadButtonEx({
                                accept: "image/*", onFileData: function (data) {
                                    view.imageCropper.$.show();
                                    view.imageCropperDiv.$.croppie({
                                        url: data,
                                        showZoomer: false,
                                        viewport: { width: 256, height: 256 },
                                      
                                    }).css("bottom","110px");


                                }
                            });
                            */
                            view.cancelImageCropper.onclick = function () {
                                view.imageCropper.$.hide();

                            };

                            view.doneImageCropper.onclick = function () {
                                view.imageCropper.$.hide();
                                view.imageCropperDiv.$.croppie('result', 'blob').then(function (data) {
                                    console.log(data);
                                });
                            };

                            view.signUpButton.onclick = function () {
                                if (view.userPassword.$.val() != view.userCPassword.$.val()) {
                                    window.ui.modals.error("Sign up failed", "Password do not match");
                                    return (false);
                                }
                                window.ui.showProcessing();
                                aviewer.api("signup", {
                                   
                                    user_title: view.userName.$.val(), user_type: 1000, email: view.userEmail.$.val(),
                                    username: view.userName.$.val(), password: view.userPassword.$.val(),
                                    user_settings: "{}", user_details:"{}"
                                },
                                    function (res) {
                                        window.ui.hideProcessing();
                                        window.ui.modals.info("Sign up success", "Thank you for signing up").closing = function () {

                                            aviewer.app.popView();
                                            if (autoLogin) {
                                                setTimeout(function () {
                                                    app.loginUser(function (user) { });

                                                }, 200);
                                            }
                                            
                                            return (true);
                                        };
                                        
                                    },
                              function (errs) {                               
                                  if (errs.length > 0) {
                                      window.ui.modals.error("Sign up failed", errs[0].field + ':' + errs[0].message);
                                  }
                                 
                              });

                            };


                        }
                    });

                };


                app.loginUser = function (done,emailOnly) {
                    
                    

                    if (aviewer.user) {
                        $(document.body).addClass('userIsLoggedIn');
                        setTimeout(function () { done(aviewer.user); }, 100);
                    }
                    else {

                       

                        aviewer.user = window.ui.storage.get("aviewerUser");

                        if (aviewer.user) {
                            aviewer.user = JSON.parse(aviewer.user);
                            $(document.body).addClass('userIsLoggedIn');
                            setTimeout(function () { done(aviewer.user); }, 100);
                            return;
                        }

                        if (emailOnly) {
                            ui.modals.inputBox({
                                title: "Participate with email",
                                ok: function (value) {

                                    if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(value)) {
                                        done({ id: -1000, username: value, emailOnly: true });
                                        return (true);
                                    }
                                    ui.modals.error("Invalid email", "please enter a valid email address");
                                    return (false);
                                }
                            }).ready = function () {
                                this.$.find("input").addClass("form-control");
                                this.setWidth("350px");
                                this.$.find(".ui-ui-modal-ok-button").addClass("btn-danger").html("NEXT >>");
                                this.$.find(".ui-ui-modal-cancel-button").html("CANCEL");
                            };

                            return;
                        }
                        app.pushView({

                            html: aviewer.loginUserUI,
                            ready: function (view) {
                                view.signUpButton.onclick = function () {
                                    app.registerUser();
                                   

                                };
                                view.signInButton.onclick = function () {
                                    window.ui.showProcessing();
                                    aviewer.api("login_av", { username: view.userName.$.val(), password: view.userPassword.$.val() },
                                        function (res) {
                                            aviewer.userAccessToken = res.access_token;


                                            window.ui.hideProcessing();

                                            aviewer.user = res.user;

                                            aviewer.user.userPassword = view.userPassword.$.val();


                                            window.ui.storage.set("aviewerUser", JSON.stringify(aviewer.user));

                                          
                                            aviewer.app.popView();
                                            $(document.body).addClass('userIsLoggedIn');
                                            setTimeout(function () { done(aviewer.user); }, 100);
                                        },
                                  function (res) {
                                      console.log(res);
                                      window.ui.modals.error("Login failed", "Invalid username or password");
                                  });

                                };


                            }
                        });
                    }


                };

                app.uploadDubbedSounds = function (done) {
                   
                    var sounds = [];
                    for (var s in aviewer.dubbedSounds) {
                        var snd = aviewer.dubbedSounds[s];
                        if (!snd.uploaded) {
                            snd.org = s;
                            sounds.push(snd);

                        }
                    }
                   
                    eachItem(sounds, function (snd, next) {

                        var mp3Data = [];
                        var mp3encoder = new lamejs.Mp3Encoder(1, 44100, 64);
                        var mp3Tmp = mp3encoder.encodeBuffer(window.convertoFloat32ToInt16(snd.data));
                        mp3Data.push(mp3Tmp);
                        var mp3buf = mp3encoder.flush();
                        if (mp3buf.length > 0) {
                            mp3Data.push(new Int8Array(mp3buf));
                        }

                        var blob = new Blob(mp3Data, { type: 'audio/mp3' });
                        aviewer.uploadFile(blob, function (url) {
                            snd.uploaded = url;
                            console.log(snd);
                            next.call();
                        });
                    },


                        function () {
                            
                            done(sounds);
                        });

                   

                };

                app.dubImagCanv = window.createCanvasObject(10, 10);
                app.uploadDubbedImages = function (done) {

                    var images = [];
                    for (var m in aviewer.dubbedImages) {
                        var mm = aviewer.dubbedImages[m];
                        if (!mm.uploaded) {
                            images.push(mm);
                        }
                    }

                    eachItem(images, function (mm, next) {
                        var blob1, blob2;
                        window.checkImageSource(mm.dataUrl, function () {

                            if (window.isMobileDevice) {
                                app.dubImagCanv.setSize(this.width * 2, this.height * 2);
                                app.dubImagCanv.ctx.drawImage(this, 0, 0, this.width * 2, this.height * 2);
                                blob1 = window.dataURLtoBlob(app.dubImagCanv.toDataURL("image/png"));
                                blob2 = window.dataURLtoBlob(mm.dataUrl);
                            }
                            else {
                                app.dubImagCanv.setSize(this.width * 0.5, this.height * 0.5);
                                app.dubImagCanv.ctx.drawImage(this, 0, 0, this.width * 0.5, this.height * 0.5);
                                blob2 = window.dataURLtoBlob(app.dubImagCanv.toDataURL("image/png"));
                                blob1 = window.dataURLtoBlob(mm.dataUrl);
                            }

                            console.log(blob1); console.log(blob2);
                            aviewer.uploadFile(blob1, function (url) {
                                var key = url.replace('/assets/', '') + '_res_2';
                                aviewer.uploadFile(blob2, function (url2) {
                                    mm.uploaded = url;                                 
                                    delete mm.dataUrl;
                                    next.call();
                                }, 'key=' + key);
                            });
                        });

                       

                        
                    },


                        function () {done(images); });



                };


                app.showBookComments = function ( ugcId,exitScreen) {
                    app.pushView({

                        html: window.parseItemTags(aviewer.userGeneratedBooksCommentsUI, function (k) {
                            return (eval(k));
                        }),
                        ready: function (view) {

                            view.dead = function () {
                              
                                if(exitScreen) exitScreen();

                            };
                            view.appendCommentItem = function (item,appendToLast) {
                                var item$ = $(window.parseItemTags(aviewer.userGeneratedBookCommentTemplate, function (k) {
                                    return (eval(k));
                                }));
                                if (appendToLast) view.listItems.$.append(item$); else view.listItems.$.prepend(item$);

                                item$.find("img")[0].onerror = function () {
                                    this.src =aviewer.serverUrl+ "/global/img/large-user-avatar.png";
                                };

                            };
                            view.viewPreviousCommentsLink.onclick = function () {
                                view.getList();

                            };
                            view.getList = function (clear,justRefreshList) {
                                if (clear) view.listItems.$.html("");
                                var start = view.listItems.$.find(".listItemTemplate").length;
                                view.loadingList = true;
                                var q = {
                                    limit: { start: start, count: 10 },
                                    filter: { data_ref: ugcId, data_type: 20 },
                                    order:{data_time:"DESC"},
                                    fetchContent: true
                                };

                                window.ui.showProcessing();
                                aviewer.api("search_data_collection", q, function (res) {
                                    console.log(res);
                                    if (res.data.length < 10)
                                        view.loadingList = true;
                                    else
                                        view.loadingList = false;

                                    res.data.forEach(function (item) {
                                        
                                        view.appendCommentItem(item);
                                    });
                                    view.listItems.$.prepend(view.viewPreviousCommentsLink);
                                    if (res.data.length > 9) {
                                        view.loadingList = false;
                                        view.viewPreviousCommentsLink.$.show();
                                    } else {
                                        view.viewPreviousCommentsLink.$.hide();
                                    }

                                    window.ui.hideProcessing();
                                });
                            };
                            view.getList();

                            view.postComment = function () {
                                var txt = view.postCommentText.$.val();
                                if (txt != "") {
                                    view.postCommentText.$.val("");
                                    console.log(txt);
                                    window.ui.showProcessing();
                                    aviewer.api("aniparti_data_collection", { data_ref: ugcId,data_text:txt,  data_type: 20, data_user: aviewer.user.id }, function (res) {
                                        window.ui.hideProcessing();
                                      
                                        view.appendCommentItem({ data_text: txt, username: aviewer.user.username, usid: aviewer.user.id ,data_time:Date.now()},true);
                                    });
                                }
                             

                            };
                            view.postCommentLink.onclick = function () {
                                view.postComment();
                            };
                            view.postCommentText.onkeydown = function (e) {
                                if (e.keyCode == 13) view.postComment();
                            };
                        }
                    })
                };
                app.saveAndShareUGC = function (shareURL) {

                    book=aviewer.currentPlay_book;
                    ugcId=aviewer.currentPlay_ugcId;
                    app.loginUser(function (user) {
                        console.log("app.loginUser");
                        ui.modals.open({
                            title: "Share & Publish Now", element: aviewer.saveAndPublishUI,
                            buttons: '<div class="ui-ui-modal-action-buttons"><button class="btn default pull-left ui-ui-modal-cancel-button buttonRadius" >Cancel</button><button class="btn btn-danger pull-right ui-ui-modal-ok-button buttonRadius">Save & Publish</button></div>'

                        }).ready = function () {
                            var md = this;
                            md.setWidth("350px");
                            window.bindElements(md.$, md);
                            md.$.find(".ui-ui-modal-cancel-button").css("width", "130px").css("color", "white").html("CANCEL");
                            md.$.find(".ui-ui-modal-ok-button").css("width", "130px").html("SHARE & PUBLISH");

                            md.publishTitle.$.val(user.username + "'s " + book.name);

                            if (user.emailOnly) {
                                md.publishTitle.$.val(user.username);
                            }
                            md.closing = function (ok) {

                                if (ok) {


                                    window.ui.showProcessing();



                                    var userData = { dubbedSounds: {}, dubbedImages: {}, dubbedObjects: aviewer.dubbedObjects };

                                    var completePublish = function () {
                                        var repo = {
                                            user_id: user.id, type: 1051, tags: "", status: 0, ref_key: book.id, repo_path: book.repo_path, description: "", name: md.publishTitle.$.val(), scope: 100
                                        };
                                        repo.scope = md.publishModePrivate.checked ? 200 : 100;
                                        repo.content = JSON.stringify(userData);
                                        aviewer.api('save_repo_av', repo, function (res) {

                                            if (shareURL) {
                                                ui.modals.info("Share & Publish Now", "<h6 style='color:gray;text-align:center'>Successfully saved</h6>").ready = function () {
                                                    this.$.find(".ui-ui-modal-ok-button").css("margin-left", "-65px");
                                                    this.closing = function () {
                                                        app.shareToPublic('http://mad.aniparti.com/ugc?' + res.id,true)
                                                        return (true);
                                                    }

                                                };

                                                
                                            }
                                            console.log(res);
                                            window.ui.hideProcessing();
                                            md.forceClose();
                                        });

                                    };

                                    app.uploadDubbedImages(function (images) {
                                        images.forEach(function (mm) {
                                            userData.dubbedImages[mm.key] = mm;
                                        });

                                        app.uploadDubbedSounds(function (sounds) {
                                            sounds.forEach(function (snd) {
                                                userData.dubbedSounds[snd.org] = snd.uploaded;
                                            });
                                            completePublish();
                                            console.log(userData);
                                        });


                                    });



                                    return (false);
                                }
                                return (true);
                            };
                        }

                    }, true);

                };

                app.shareToPublic = function (url,backToList) {
                    var md = ui.modals.info('Copy the LINK to share', '<label>URL:</label><br/><div class="inputArea"></div><h6 style="color:red;text-align:center;font-size:80%">Copy &amp; Paste this URL wherever you want to share</h6>');
                    md.ready = function () {

                        this.$.find(".ui-ui-modal-ok-button").css("margin-left", "-65px");
                    };
                    aviewer.copyURLText.$.show();
                    md.$.find(".inputArea").append(aviewer.copyURLText);
                    aviewer.copyURLText.$.val(url);
                    aviewer.copyURLText.$.focus();
                    if (window.isOS()) {
                        var range = document.createRange();
                        range.selectNodeContents(aviewer.copyURLText);
                        var selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                        aviewer.copyURLText.setSelectionRange(0, 999999);
                    } else {
                        aviewer.copyURLText.$.select();
                    }
                    md.closing = function () {

                        var successful = document.execCommand('copy');
                        var msg = successful ? 'successful' : 'unsuccessful';
                        console.log(msg);
                        aviewer.copyURLText.$.hide();
                        $(document.body).append(aviewer.copyURLText);
                        if (backToList) {
                            aviewer.saveShareCompleted = true;
                            aviewer.app.popView();
                        }
                        return (true);
                    };

                };
                app.playBook = function (book, userData, ugcId,refreshList) {
                    
                    aviewer.currentPlay_book = book;
                    aviewer.currentPlay_userData = userData;
                    aviewer.currentPlay_ugcId = ugcId;
                    aviewer.dubbedSounds = {};
                    aviewer.dubbedImages = {};
                    aviewer.dubbedObjects = {};
                    aviewer.userDubbedImages = {};
                    aviewer.userDubbedSounds = {};
                    aviewer.userDubbedSoundsApplied = {};
                    aviewer.isUGCVersion = false;
                    if (userData) {
                        aviewer.userDubbedSounds = userData.dubbedSounds;
                        aviewer.userDubbedImages = userData.dubbedImages;
                        aviewer.userDubbedObjects = userData.dubbedObjects || {};
                        aviewer.isUGCVersion = true;
                    }
                     app.pushView({

                        html: aviewer.playBookUI,
                        ready: function (view) {
                            window.ui.showProcessing();
                            view.css("overflow", "hidden");
                         
                            var windowWidth = $(window).width();
                            var windowHeight = $(window).height();

                            if (windowWidth > windowHeight) {
                                var w = (windowWidth * 0.5);
                                if (w > 600) w = 600;
                                view.css("width", w + "px");
                                view.css("left", "50%").css("margin-left", -(w * 0.5) + "px");
                            }

                           

                            aviewer.saveAndPublishButton.hide();
                            aviewer.shareButton.hide();
                            aviewer.likeButton.hide();
                            aviewer.commentsButton.hide();

                            setTimeout(function (view) {

                               // aviewer.viewerArea.insertBefore(view.navigationBar.$);

                                view.append(window.layoutContainer);

                                //window.layoutContainer.insertBefore(view.popViewButton.$);
                                console.log("book", book);
                                window.loadContent(book.content);
                                window.layoutContainer.show();
                              
                                window.ui.hideProcessing();
                                if (userData) {
                                    if(ugcId) view.addClass('likeSupport');
                                    console.log('likeSupport', view);                                    
                                }
                                else {
                                    aviewer.saveAndPublishButton.show();
                                    view.addClass('shareSupport');
                                }
                            }, 200, view);

                            view.dead = function () {
                                window.clearContent();
                                window.layoutContainer.hide();
                                $(document.body).append(window.layoutContainer);
                                if (window.ugcIndexPage) {

                                }
                                history.pushState(null, null, window.ugcIndexPage ? "ugc/view?" + book.id : "ugc?" + book.id);
                                if (refreshList) refreshList();

                                
                            };
                            
                            if (userData) {
                                aviewer.likeButton.show();
                                aviewer.commentsButton.show();
                                aviewer.shareButton.show();

                                if (ugcId) {
                                    aviewer.isUGCVersion = true;
                                    if (aviewer.likedThisUGC) {
                                        aviewer.likeButton.addClass("liked");
                                    } else {
                                         

                                        aviewer.likeButton.removeClass("liked");
                                        aviewer.likeButton[0].onclick = function () {
                                            app.loginUser(function (user) {
                                                if (aviewer.UGCLikes[parseInt(aviewer.user.id)]) {
                                                    aviewer.likeButton.addClass("liked");
                                                    return;
                                                }
                                                console.log("aviewer.user", aviewer.user);


                                                window.ui.showProcessing();                                                                                        
                                                aviewer.api("aniparti_data_collection", { data_ref: ugcId, data_type: 10, data_user: aviewer.user.id }, function (res) {
                                                    aviewer.UGCLikes[parseInt(aviewer.user.id)] = true;
                                                    window.ui.hideProcessing();
                                                    aviewer.likeButton.addClass("liked");
                                                });
                                            });

                                        };
                                        
                                       


                                    }
                                    
                                    aviewer.shareButton[0].onclick = function () {
                                        app.shareToPublic('http://mad.aniparti.com/ugc?' + ugcId);
                                    }
                                    aviewer.commentsButton[0].onclick = function () {
                                       
                                        app.loginUser(function (user) {
                                            var slide = window.viewer.activeSlide;                                            
                                            slide.pause();
                                            console.log("slide-pause", slide.uuid);
                                            app.showBookComments(ugcId, function () {                                             
                                                slide.resume();
                                                console.log("slide-resume", slide.uuid);                                                
                                            });
                                        });
                                        
                                    };


                                }
                                
                            }
                           

                          
                          

                            aviewer.saveAndPublishButton[0].onclick = function (e) {
                                if (!window.audioinput) {
                                    //ui.modals.error("Save &amp Publish", "Not available on Web<br/>Please use App"); return;

                                }
                                app.saveAndShareUGC();
                                e.stopPropagation();
                                e.preventDefault();
                                return (false);

                            };

                        }
                     });

                     $(".sidebarLinks.backToListLink")[0].onclick = function () {
                         console.log(".sidebarLinks.backToListLink");
                         aviewer.app.popView();

                     };

                };
                app.hideEmailAddress = function (email) {
                    var parts = email.split("@");
                    var name = parts[0];
                    var moreparts = parts[1].split(".");
                    var padding = "*****************************************";
                    if (name.length < 2) name += "***";
                    if (moreparts[0].length > 2) parts[1] = (moreparts[0].substr(0, 2) + padding.substr(0, moreparts[0].length - 2)) + "." + moreparts[1];
                    parts[0] = name.substr(0, 2) + padding.substr(0, name.length - 2);
                   
                    return (parts[0] + "@" + parts[1]);

                };
                app.showUserGeneratedBooks = function (mainBook, ugcId) {

                    app.pushView({
                        noTransistions: window.ugcIndexPage,
                        html: window.parseItemTags(aviewer.userGeneratedBooksUI, function (k) {
                            return (eval(k));
                        }),
                        ready: function (view) {
                            
                            if (window.ugcIndexPage) {
                                view.backToListButton.$.hide();
                            }
                            view.mainBookImage.onerror = function () {
                                this.src = aviewer.serverUrl+"/global/img/publish-thumbnail.jpg_2";
                            };
                            view.mainBookImage.src = aviewer.serverUrl +'/'+ mainBook.repo_path + "_2";

                            view.loadUgc = function (item) {

                                item.userData = JSON.parse(item.content);
                                window.ui.showProcessing();
                                aviewer.likedThisUGC = false;
                                aviewer.UGCLikes = {};
                              
                                aviewer.api("aniparti_data_collection_query", { data_ref: item.id, data_type: 10 }, function (data) {
                                    data.res.forEach(function (d) {
                                        var like_user =parseInt(d.data_user);
                                        aviewer.UGCLikes[like_user] = true;
                                        if (aviewer.user && like_user == parseInt(aviewer.user.id)) {
                                            aviewer.likedThisUGC = true;
                                        }
                                    });
                                    var viewKey = 'data_view_' + (aviewer.user ? aviewer.user.id : '-1') + '_' + item.id;  
                                    if (!window.ui.storage.get(viewKey)) {
                                        aviewer.api("aniparti_data_collection", { data_ref: item.id, data_type:30}, function (res) {
                                            window.ui.storage.set(viewKey, 'true');
                                            window.ui.hideProcessing();
                                            app.playBook( mainBook, item.userData, item.id);
                                        });
                                    }
                                    else {
                                        window.ui.hideProcessing();
                                        app.playBook(mainBook, item.userData, item.id);
                                    }

                                });
                            };
                            view.getList = function (clear,justRefreshList) {
                                if (clear) view.listItems.$.html("");
                                var start = view.listItems.$.find(".listItemTemplate").length;
                                view.loadingList = true;
                                var q = {
                                    limit: { start: start, count: 10 },
                                    filter: { type: 1051, scope: 100, ref_key: mainBook.id },
                                    fetchContent:true,
                                    fields: {
                                        comments: '(select count(data_user) from aniparti_data_collection where data_ref=ap.id AND data_type=20)',
                                        likes: '(select count(data_user) from aniparti_data_collection where data_ref=ap.id AND data_type=10)',
                                        views: '(select count(data_user) from aniparti_data_collection where data_ref=ap.id AND data_type=30)'
                                    },
                                    order: { 'modified_date': 'DESC' }

                                };

                                if (view.searchList) {
                                    q.search = view.searchList;
                                }
                                   


                               
                                window.ui.showProcessing();

                                aviewer.api("search_repo_public", q, function (res) {
                                    console.log(res);
                                    if (res.data.length < 10)
                                        view.loadingList = true;
                                    else
                                        view.loadingList = false;

                                    res.data.forEach(function (item) {
                                        if (item.usid == -1000) {
                                            item.name =app.hideEmailAddress(item.name);
                                        }
                                        var item$ = $(window.parseItemTags(aviewer.userGeneratedBookItemTemplate, function (k) {
                                            return (eval(k));
                                        }));
                                        view.listItems.$.append(item$);
                                        item$[0].onclick = function () {
                                            view.loadUgc(item);
                                            history.pushState(null, null, window.ugcIndexPage ? "ugc/view?" + item.id : "ugc?" + item.id);
                                        };



                                        item$.find("img")[0].onerror = function () {
                                            this.src =aviewer.serverUrl+ "/global/img/large-user-avatar.png";
                                        };
                                        if (item.id == ugcId && !justRefreshList) {
                                            view.loadUgc(item);
                                          
                                        }

                                    });


                                    if (res.data.length == 0 && start<2) {
                                        view.listArea.$.append('<h5 style="color:black;position:absolute;left:0;right:0; top:50%;text-align:center;font-weight:bold;margin-top:-100px;line-height: 50px;"><i style="color:#b5b4b4;font-size:72px;" class="fa fa-exclamation-circle"></i><br/>No list yet ^^;</h5>');
                                    }
                                    if (res.data.length > 19) view.loadingList = false;

                                    window.ui.hideProcessing();
                                });
                            };


                            view.listArea.$.scrollHeightItems(
                                function () {
                                    return (view.listItems.$.height() - 10);
                                },
                                function () {

                                    if (!view.loadingList) view.getList();
                                }
                            );

                            if (mainBook.id == ugcId) {
                                //setTimeout(function () { app.playBook(mainBook); }, 100);
                            }
                            view.getList();

                            view.anipartiLogo.onclick = function (e) {
                                view.getList(true,true);
                                e.preventDefault();e.stopPropagation();
                            };

                            view.refreshItemsLink.onclick = function (e) {
                                view.getList(true, true);
                                e.preventDefault(); e.stopPropagation();
                            };

                            view.readOriginalButton.onclick = function () {
                                app.playBook(mainBook, false, false, function () {
                                    if (aviewer.saveShareCompleted) {
                                        aviewer.saveShareCompleted = false;
                                        setTimeout(function () { view.getList(true, true); }, 100);
                                    }

                                });
                            };

                            view.dead = function () {
                                history.pushState(null, null, "ugc");
                            };

                            view.searchItem = function () {
                                var txt = view.searchItemText.$.val();
                                if (txt != "") {
                                    view.searchItemText.$.val("");
                                    view.searchList = { name: txt+'%' };
                                    view.getList(true,true);
                                }
                                else {
                                    view.searchList = false;
                                    view.getList(true, true);
                                }

                            };
                            view.searchItemLink.onclick = function () {
                                view.searchItem();
                            };
                            view.searchItemText.onkeydown = function (e) {
                                if (e.keyCode == 13) view.searchItem();
                            };

                        }
                    })

                };


                app.showMyUGCList = function () {
                    app.pushView({

                        html: window.parseItemTags(aviewer.myUGCListUI, function (k) {
                            return (eval(k));
                        }),
                        ready: function (view) {



                            view.getList = function (clear) {
                                if (clear) view.listItems.$.html("");
                                var start = view.listItems.$.find(".listItemTemplate").length;
                                view.loadingList = true;
                                var q = {
                                    limit: { start: start, count: 10 },
                                    filter: { type: 1051, user_id: aviewer.user.id },
                                    fetchContent: true,
                                    fields: {
                                        comments: '(select count(data_user) from aniparti_data_collection where data_ref=ap.id AND data_type=20)',
                                        likes: '(select count(data_user) from aniparti_data_collection where data_ref=ap.id AND data_type=10)',
                                        views: '(select count(data_user) from aniparti_data_collection where data_ref=ap.id AND data_type=30)'
                                    },
                                    order: { modified_date: 'DESC' }

                                };

                                window.ui.showProcessing();
                                aviewer.api("search_repo_public", q, function (res) {
                                    console.log(res);
                                    if (res.data.length < 10)
                                        view.loadingList = true;
                                    else
                                        view.loadingList = false;

                                    res.data.forEach(function (item) {
                                        var item$ = $(window.parseItemTags(aviewer.myUGCItemTemplate, function (k) {
                                            return (eval(k));
                                        }));
                                        view.listItems.$.append(item$);
                                       
                                        item$.find("img")[0].onerror = function () {
                                            this.src =aviewer.serverUrl+ "/global/img/publish-thumbnail.jpg";
                                        };

                                        item$.find(".fa-play")[0].onclick = function () {
                                            item.userData = JSON.parse(item.content);
                                            if (!item.mainBook) {
                                                window.ui.showProcessing();
                                                aviewer.api("get_repo_public", { id: item.ref_key }, function (res) {
                                                    window.ui.hideProcessing();
                                                    item.mainBook = res.data;
                                                    app.playBook(item.mainBook, item.userData);
                                                });
                                            }
                                            else app.playBook(item.mainBook, item.userData);
                                        };

                                        item["user_id"] = aviewer.user.id;

                                        item$.find(".privatePublicCheckbox")[0].onchange = function () {
                                            var chkBox = this;
                                            var setPublicPrivate = function (item, scope) {
                                                item.scope = scope;
                                                window.ui.showProcessing();
                                                aviewer.api('save_repo_av', item, function (res) {
                                                    console.log(res);
                                                    window.ui.hideProcessing();
                                                    chkBox.checked = item.scope == 100;
                                                });
                                            };
                                            if (chkBox.checked) {
                                                if (item.scope == 200) {
                                                    window.ui.modals.question("Public", "Do you want to set it for public").closing = function (ok) {
                                                        if (ok)
                                                            setPublicPrivate(item, 100);
                                                        else
                                                            chkBox.checked = item.scope == 100;
                                                        return (true);
                                                    };
                                                }
                                            }
                                            else {
                                                if (item.scope == 100) {
                                                    window.ui.modals.question("Public", "Do you want to remove from public").closing = function (ok) {
                                                        if (ok) setPublicPrivate(item, 200);
                                                        else chkBox.checked = item.scope == 100;
                                                        return (true);
                                                    };
                                                }
                                            }

                                            



                                        };

                                        item$.find(".deleteButton")[0].onclick = function () {
                                            window.ui.modals.question("Delete", "Do you want to delete this item").closing = function (ok) {
                                                if (ok)
                                                {
                                                    window.ui.showProcessing();
                                                    aviewer.api('delete_repo_av', { id: item.id }, function (res) {
                                                        window.ui.hideProcessing();
                                                        view.getList(true);
                                                    });
                                                }
                                                return (true);
                                            };
                                            
                                            
                                        };
                                    });

                                    if (res.data.length > 19) view.loadingList = false;

                                    window.ui.hideProcessing();
                                });
                            };


                            view.listArea.$.scrollHeightItems(
                                function () {
                                    return (view.listItems.$.height() - 10);
                                },
                                function () {

                                    if (!view.loadingList) view.getList();
                                }
                            );


                            view.getList();

                            view.anipartiLogo.onclick = function (e) {
                                view.getList(true,true);
                                e.preventDefault();e.stopPropagation();
                            };

                        }
                    })

                };


                app.testBook = function (id) {

                    window.ui.showProcessing();
                    aviewer.api("get_repo_public", { id: id }, function (res) {
                        window.ui.hideProcessing();
                        app.playBook(res.data, { dubbedSounds: { "/assets/599f57b67d5e68iga9i": "/assets/59a961091e534qsm844" } });

                    });
                };

                app.testBook2 = function (id) {

                    window.ui.showProcessing();
                    aviewer.api("get_repo_public", { id: id }, function (res) {
                        window.ui.hideProcessing();
                        app.showUserGeneratedBooks(res.data);

                    });
                };

                app.pushView({
                    noTransistions: true,
                    html: aviewer.motionBooksUI,
                    ready: function (view) {

                        view.getList = function (clear) {
                            if (clear) view.listItems.$.html("");
                            var start = view.listItems.$.find(".listItemTemplate").length;
                            view.loadingList = true;
                            var q = {
                                limit: { start: start, count: 20 },
                                filter: { type: 106 },
                                order: { modified_date:'DESC' }
                            };
                            window.ui.showProcessing();
                            aviewer.api("search_repo_public", q, function (res) {
                                console.log(res);
                                if (res.data.length < 10)
                                    view.loadingList = true;
                                else
                                    view.loadingList = false;

                                res.data.forEach(function (item) {
                                    var item$ = $(window.parseItemTags(aviewer.motionBookItemTemplate, function (k) {
                                        return (eval(k));
                                    }));
                                    view.listItems.$.append(item$);

                                    item$.find("img")[0].onerror = function () {
                                        this.src =aviewer.serverUrl+ "/global/img/publish-thumbnail.jpg";
                                    };
                                    item$.click(function () {

                                        window.ui.showProcessing();
                                        aviewer.api("get_repo_public", { id: item.id }, function (res) {
                                            window.ui.hideProcessing();
                                            app.showUserGeneratedBooks(res.data);
                                            history.pushState(null, null,window.ugcIndexPage ? "ugc/view?" + item.id : "ugc?" + item.id);
                                           


                                        });


                                    });

                                });

                                if (res.data.length > 19) view.loadingList = false;

                                window.ui.hideProcessing();
                            });
                        };


                        view.listArea.$.scrollHeightItems(
                            function () {
                                return (view.listItems.$.height() - 10);
                            },
                            function () {

                                if (!view.loadingList) view.getList();
                            }
                        );
                        aviewer.user = window.ui.storage.get("aviewerUser");
                        if (aviewer.user) {

                            aviewer.user = JSON.parse(aviewer.user);
                            $(document.body).addClass('userIsLoggedIn');

                        }
                       

                       

                        if (aviewer.ugcRefId && aviewer.ugcRefId != "") {
                            console.log("aviewer.ugcRefId", aviewer.ugcRefId);
                            window.ui.showProcessing();
                            aviewer.api("get_repo_public", { id: aviewer.ugcRefId }, function (res) {
                                window.ui.hideProcessing();
                                app.showUserGeneratedBooks(res.data, aviewer.ugcId);

                            });
                        }
                        else {
                            if (window.ugcIndexPage)  setTimeout(function () { $(".listOfItemsArea").html('<h4 style="color:black;text-align:center">No ugc content available</h4>'); }, 100);
                        }


                        if (!window.ugcIndexPage) {
                            view.getList();
                        }
                        


                        
                        view.anipartiLogo.onclick = function (e) {
                            view.getList(true);
                            e.preventDefault();e.stopPropagation();
                        };

                        if (!window.isMobileDevice) {
                            

                        }
                        setTimeout(function () {
                            //app.loginUser(function (user) { });
                            //app.registerUser();
                        }, 100);
                        

                    }
                });


                app.userSettings = function () {
                    app.pushView({

                        html: window.parseItemTags(aviewer.userSettingsUI, function (k) {
                            return (eval(k));
                        }),
                        ready: function (view) {
                                                 

                        }
                    });

                };

                document.addEventListener("backbutton", function () {
                    if (confirm("Do you want to exit")) {
                        navigator.app.exitApp();
                    }

                    return;
                    var currentView = app.rootElement.views.find(".view-present");
                    if (currentView.hasClass('mainScreenView')) {
                      
                    }
                    else {
                        app.popView();
                    }

                }, false);

             

              
            }
        });

        $("#mainContainer").show();
       // aviewer.appView.$.insertBefore(aviewer.viewerArea);
        $("#mainContainer").append(aviewer.appView.$);
        aviewer.appView.$.find(".ui-views-sidebar-overlay,.ui-views-sidebar").remove();
       
        window.prepareNewNavigationSystem();
        window.layoutContainer.hide();
        //window.topNavBar.hide();
        window.layoutContainer.append($(".viewerErrorMessage"));
        if (!window.isMobileDevice) {
            if (windowWidth > 600) windowWidth = 600;
            window.layoutContainer.css("width", windowWidth + "px").css("left", "50%").css("margin-left", "-" + (windowWidth / 2) + "px");
            
        }
        window.windowWidth = windowWidth;
        $(".ugcLinks").show();
        

        aviewer.shareButton = $(".sidebarLinks.shareLink");
        aviewer.saveAndPublishButton = $(".sidebarLinks.ugcPublishingLink");
        aviewer.commentsButton = $(".pageNavigationPanel .commentLink");
        aviewer.likeButton = $(".pageNavigationPanel .likeLink");
        $(".nextEpisodeLink,.maniSearchLink,.notReguiredInUGC").hide();



    };


    aviewer.modifyImage = function (modifyImageComplete, sww, shh, modifyImageCancel, editTitle, modifyImageAction) {
         if (!aviewer.fabricCanvas) {

            window.bindElements(aviewer.modifyImageUI, aviewer.modifyImageUI);

            aviewer.appView.$.append(aviewer.modifyImageUI);
            aviewer.fabricCanvas = new window.ui.canvas("modifyImageCanvas", { width: 0, height: 0 });
            aviewer.fabricCanvas.setViewport(aviewer.appView.$.width(), aviewer.appView.$.height());
            aviewer.fabricCanvas.pan.x = -aviewer.fabricCanvas.width / 2;
            aviewer.fabricCanvas.pan.y = -(aviewer.fabricCanvas.height / 2);
            aviewer.fabricCanvas.absolutePan(aviewer.fabricCanvas.pan);
            aviewer.fabricCanvas.resCanv = window.createCanvasObject(10, 10);

            aviewer.modifyImageUI.penWidth = 5;
            aviewer.modifyImageUI.penSize.$.customSliderInput(1, 10).smartEdit(aviewer.modifyImageUI.penWidth).onUpdate = function (v) {
                aviewer.modifyImageUI.penWidth = v;
                aviewer.modifyImageUI.penSizeBall.$.css("transform", "scale(" + (v / 10) + ")");
                if (aviewer.fabricCanvas.drawing && aviewer.fabricCanvas.drawing.currentPoly) {
                    aviewer.fabricCanvas.drawing.currentPoly.lineWidth = aviewer.modifyImageUI.penWidth;
                }
            };

            aviewer.modifyImageUI.penColorValue = "rgb(0,0,0)";
            aviewer.modifyImageUI.penColor.$.ColorPicker({

                onBeforeShow: function () {
                    aviewer.modifyImageUI.penColor.$.ColorPickerSetColor(aviewer.modifyImageUI.penColorValue);
                },
                onChange: function (hsb, hex, rgb) {
                    var c = "rgb(" + rgb.r + "," + rgb.g + "," + rgb.b + ")";
                    aviewer.modifyImageUI.penColor.$.css('backgroundColor', c);
                    aviewer.modifyImageUI.penColorValue = c;
                    if (aviewer.fabricCanvas.drawing && aviewer.fabricCanvas.drawing.currentPoly) {
                        aviewer.fabricCanvas.drawing.currentPoly.color = aviewer.modifyImageUI.penColorValue;
                    }

                }
            });

            aviewer.modifyImageUI.penOkButton.$.click(function () {
                $(".hideWrittingUI").show();
                aviewer.modifyImageUI.penOptions.$.hide();

                aviewer.fabricCanvas.drawingMode = false;
                var obj = aviewer.fabricCanvas.drawing.finishNewObject();
                aviewer.fabricCanvas.setActiveObject(obj);
                obj.setCoords();
                aviewer.fabricCanvas.renderAll();


            });
            aviewer.modifyImageUI.penCancelButton.$.click(function () {
                $(".hideWrittingUI").show();
                aviewer.modifyImageUI.penOptions.$.hide();
                aviewer.fabricCanvas.drawingMode = false;
                aviewer.fabricCanvas.drawing.reset();
                aviewer.fabricCanvas.renderAll();
            });


            aviewer.fabricCanvas._mouseWheel = function (evt) {


            };
            aviewer.fabricCanvas.enableInteraction().selection = false;
             
            aviewer.fabricCanvas.itemEditOptions = aviewer.modifyImageUI.find(".itemEditOptions");

            aviewer.fabricCanvas._renderOverlay = function (ctx) {

                aviewer.fabricCanvas.itemEditOptions.hide();

                if (aviewer.fabricCanvas._activeObject) {
                    if (aviewer.fabricCanvas._activeObject.resizingBox) return;
                    if (aviewer.fabricCanvas._activeObject.textObject) {
                        aviewer.modifyImageUI.editObjectButton.$.show();
                    }
                    else {
                        aviewer.modifyImageUI.editObjectButton.$.hide();
                    }
                    
                    aviewer.fabricCanvas._activeObject.updateBounds();
                    aviewer.fabricCanvas.itemEditOptions.show();
                    var z = aviewer.fabricCanvas.currentZoom;
                    var rc = aviewer.fabricCanvas._activeObject.bounds;

                    var _width = rc.width * z;
                    var _height = rc.height * z;

                    var _left = ((rc.left * z) - aviewer.fabricCanvas.pan.x) + _width + (10 * z);
                    var _top = (rc.top * z) - aviewer.fabricCanvas.pan.y;
                    aviewer.fabricCanvas.itemEditOptions.css("left", _left + "px").css("top", _top + "px");
                }
              

              


                if (aviewer.fabricCanvas.drawingMode) {

                }
            };

            aviewer.fabricCanvas.itemEditOptions.find(".deleteObject").click(function () {
                if (aviewer.fabricCanvas._activeObject) {
                    aviewer.fabricCanvas.deleteObject(aviewer.fabricCanvas._activeObject);
                    aviewer.fabricCanvas.renderAll();
                }
                    
            });

            aviewer.fabricCanvas.itemEditOptions.find(".editObject").click(function () {
                if (aviewer.fabricCanvas._activeObject) {
                    if (aviewer.fabricCanvas._activeObject.textObject) {
                        aviewer.fabricCanvas.editTextBox(aviewer.fabricCanvas._activeObject);
                    }
                }

            });

            aviewer.fabricCanvas.itemEditOptions.find(".duplicateObject").click(function () {


            });
             
            aviewer.fabricCanvas.resizingBox = aviewer.fabricCanvas.newObject({
                lockMovementX: true, lockMovementY: true, hasRotatingPoint: false, resizingBox: true,

                originX: "center", originY: "center", centeredScaling: true, width: 200, height: 200,evented:false,
                _render: function (ctx) {
                    var width = this.width * this.scaleX;
                    var height = this.height * this.scaleY;
                    this.width = width;
                    this.height = height;
                    this.scaleX = 1;
                    this.scaleY = 1;
                    ctx.strokeStyle = "rgb(200,200,200)";

                    ctx.strokeRect(-width / 2, -height / 2, width, height);

                }

            });

            aviewer.fabricCanvas.drawing = aviewer.fabricCanvas.newObject({
                left: 0, top: 0, evented: false, resizingBox: true, width: 1, height: 1, points: [], polys: [],
                ready: function () {
                    this.startNewPoly();
                },
                addPoint: function (x, y) {

                    this.currentPoly.points.push({ x: x, y: y });
                },
                reset:function(){
                    this.polys.length = 0;

                },
                startNewPoly: function () {
                    this.currentPoly = { color: aviewer.modifyImageUI.penColorValue, points: [], lineWidth: aviewer.modifyImageUI.penWidth };
                    this.polys[this.polys.length] = this.currentPoly;
                },
                _render: function (ctx) {

                    var self = this;
                    this.polys.forEach(function (pl) {
                        ctx.strokeStyle = pl.color;
                        ctx.lineWidth = pl.lineWidth;

                        ctx.beginPath();
                        pl.points.forEach(function (p, index) {
                            if (index == 0) {
                                ctx.moveTo(p.x, p.y);
                            }
                            else {
                                ctx.lineTo(p.x, p.y);
                            }
                        });
                        ctx.stroke();
                    });


                },
                finishNewObject: function () {
                    var minx = 99999, miny = 99999, maxx = -99999, maxy = -99999;

                    this.polys.forEach(function (pl) {
                        pl.points.forEach(function (p, index) {
                            if (p.x > maxx) maxx = p.x;
                            if (p.y > maxy) maxy = p.y;
                            if (p.x < minx) minx = p.x;
                            if (p.y < miny) miny = p.y;
                        });
                    });

                    var obj = aviewer.fabricCanvas.newObject({
                        originX: "center", originY: "center", centeredScaling: true, cornerSize: 40,
                        width: maxx - minx, height: maxy - miny, left: minx, top: miny, polys: JSON.parse(JSON.stringify(this.polys)),
                        _render: this._render,
                        _render1: function (ctx) {
                            var w = this.width * this.scaleX;
                            var h = this.height * this.scaleY;

                            this.scaleX = 1;
                            this.scaleY = 1;

                            this.width = w; this.height = h;

                            var sx = this.width / this.awidth;
                            var sy = this.height / this.aheight;
                            this.polys.forEach(function (pl) {
                                ctx.strokeStyle = pl.color;
                                ctx.lineWidth = pl.lineWidth;
                                ctx.beginPath();
                                pl.points.forEach(function (p, index) {
                                    if (index == 0) {
                                        ctx.moveTo(p.x * sx, p.y * sy);
                                    }
                                    else {
                                        ctx.lineTo(p.x * sx, p.y * sy);
                                    }
                                });
                                ctx.stroke();
                            });

                        }
                    });


                    this.polys.length = 0;

                    obj.polys.forEach(function (pl) {
                        pl.points.forEach(function (p, index) {
                            p.x -= minx + obj.width * 0.5;
                            p.y -= miny + obj.height * 0.5;
                        });
                    });


                    obj.left += obj.width * 0.5;
                    obj.top += obj.height * 0.5;
                    obj.awidth = obj.width;
                    obj.aheight = obj.height;

                    return (obj);
                }
            });

            aviewer.fabricCanvas.onDragging = function (dmx, dmy, ee, e) {
                if (!aviewer.fabricCanvas.drawingMode) return;
                if (Math.abs(dmx) > 2 || Math.abs(dmy) > 2) {
                    var x = aviewer.fabricCanvas.lmx + aviewer.fabricCanvas.pan.x;
                    var y = aviewer.fabricCanvas.lmy + aviewer.fabricCanvas.pan.y;
                    aviewer.fabricCanvas.drawing.addPoint(x, y);
                    aviewer.fabricCanvas.renderAll();
                }

            };

            aviewer.fabricCanvas.onDraggingUp = function () {
                if (!aviewer.fabricCanvas.drawingMode) return;

                aviewer.fabricCanvas.drawing.startNewPoly();
                //aviewer.fabricCanvas.drawingMode = false;
                //aviewer.fabricCanvas.setActiveObject(aviewer.fabricCanvas.drawing.finishNewObject());
                //aviewer.fabricCanvas.renderAll();
            };


            aviewer.fabricCanvas.editTextBox = function (tbox) {
                window.ui.modals.question("Edit Text", '<textarea rows=10 style="width:100%;text-align:center;border-radius:12px"></textarea>').ready = function () {
                    var md = this;
                    md.$.css("min-width", "330px").css("width", "330px");
                    md.$.find("textarea").val(tbox.text).select().focus();
                    md.$.find('.ui-ui-modal-ok-button').addClass('btn-danger').html("Ok");
                    md.$.find('.ui-ui-modal-cancel-button').html("Cancel");
                    md.closing = function (res) {

                        if (res) {
                            tbox.text = md.$.find("textarea").val();
                            tbox.setCoords();
                            setTimeout(function () {
                                aviewer.fabricCanvas.renderAll();
                                if (tbox.width > aviewer.fabricCanvas.width) tbox.width = aviewer.fabricCanvas.width;
                                aviewer.fabricCanvas.renderAll();

                            }, 200);

                        }
                        return (true);
                    };

                };


            };
            aviewer.fabricCanvas.addTextBox = function (txt) {

                var txb = aviewer.fabricCanvas.newObject({
                    textObject: true, originX: "center", originY: "center", centeredScaling: true, textAlign: "center",
                    left: 0, top: 0, width: 50, height: 50, borderPadding: 5, text: txt, lineSpacing: 0, fontFamily: "Open Sans",
                    cornerSize: 40,
                    _render: function (ctx) {
                        var texts = this.text.split('\n');

                        var width = this.width * this.scaleX;
                        var height = this.height * this.scaleY;

                        var pd = this.borderPadding;
                        var lpc = this.lineSpacing;
                        var x = -width / 2, y = -height / 2;
                        this.scaleX = 1; this.scaleY = 1;
                        this.height = height;
                        var lineHeight = (height - ((pd * 2.0) + (lpc * texts.length))) / (texts.length);


                        if (lineHeight < 7) {
                            lineHeight = 7;
                            height = (lineHeight + (pd * 2) + lpc) * texts.length;
                            this.height = height;
                            y = -height / 2;
                        }
                        ctx.save();
                        var tws = [];


                        var firstWidth = true;
                        ctx.font = (lineHeight) + "px " + this.fontFamily;
                        for (var i = 0; i < texts.length; i++) {
                            var ww = ctx.measureText(texts[i]).width;
                            if (ww > width || firstWidth) width = (ww + pd * 3) + lpc;
                            tws.push(ww);
                            firstWidth = false;

                        }
                        this.width = width;


                        var printText = function (x, y, i) {
                            ctx.fillText(texts[i], x, y);
                        }
                        if (this.textAlign == "center")
                            printText = function (x, y, i) { ctx.fillText(texts[i], x + (((width - pd * 2) * 0.5) - ((tws[i] * 0.5) + pd * 0.5)), y); }
                        else if (this.textAlign == "right")
                            printText = function (x, y, i) { ctx.fillText(texts[i], x + (((width - pd * 2)) - ((tws[i]) + pd * 0.5)), y); }

                        ctx.fillStyle = this.fontColor;


                        for (var i = 0; i < texts.length; i++)
                            printText(x + pd, (((y + (lineHeight + lpc) * i) + (lineHeight / 1.25)) + pd) + lpc * 0.5, i);


                        ctx.restore();
                    },
                    ready: function () {
                        this.setControlVisible("ml", false);
                        this.setControlVisible("mr", false);
                        this.setControlVisible("mt", false);
                        this.setControlVisible("mb", false);

                    },
                    clipTo: function (ctx) {
                        var w = this.width, h = this.height, x = -this.width / 2, y = -this.height / 2;
                        ctx.rect(x, y, w, h);
                    }
                });

                txb.setCoords();
                aviewer.fabricCanvas.setActiveObject(txb);

                return (txb);


            };


            aviewer.modifyImageUI.action_textObject = function () {
                aviewer.fabricCanvas.addTextBox("Text field");
                aviewer.fabricCanvas.renderAll();
            };
            aviewer.modifyImageUI.find(".textObject").click(aviewer.modifyImageUI.action_textObject);

            aviewer.modifyImageUI.action_penObject = function () {
                aviewer.fabricCanvas.drawingMode = true;
                aviewer.fabricCanvas.drawing.bringToFront();
                aviewer.fabricCanvas.drawing.polys.length = 0;
                aviewer.fabricCanvas.drawing.startNewPoly();
                aviewer.fabricCanvas._discardActiveObject();
                $(".hideWrittingUI").hide();
                aviewer.fabricCanvas.renderAll();
                aviewer.modifyImageUI.penOptions.$.show();
            };
            aviewer.modifyImageUI.find(".penObject").click(aviewer.modifyImageUI.action_penObject);


            aviewer.modifyImageUI.action_imageObject = function () {
                window.ui.modals.info("Select Bubble", '<div style="height:340px;overflow-y:auto;border-radius:12px;border:solid 1px silver"><ul class="list-unstyled"></ul></div>').ready = function () {
                    var md = this;
                    md.$.css("min-width", "320px").css("width", "320px");
                    md.$.find('.ui-ui-modal-ok-button').html("Close");


                    var list = md.$.find(".list-unstyled");
                    for (var i = 1; i < 21; i++) {
                        var tm = $('<li class="imagelist-item media"><img class="mr-3" width="64" height="64" src="' + window.appUrl + '/images/bubbles/' + i + '.png" ></li>');
                        list.append(tm);
                        tm[0].onclick = function () {
                            var img = $(this).find("img")[0];
                            var mg = aviewer.fabricCanvas.newObject({
                                imageObject: true, originX: "center", originY: "center", centeredScaling: true, textAlign: "center",
                                left: 0, top: 0, width: img.width * 3, height: img.height * 3, cornerSize: 40,
                                _render: function (ctx) {
                                    ctx.drawImage(this.img, -this.width / 2, -this.height / 2, this.width, this.height);
                                },
                                ready: function () {
                                    this.img = new Image();
                                    this.img.src = img.src;
                                    var self = this;
                                    this.img.onload = function () {
                                        //self.width = this.width;
                                        // self.height = this.height;
                                    };
                                }
                            });

                            mg.setCoords();
                            mg.sendToBack();
                            aviewer.fabricCanvas.setActiveObject(mg);
                            md.close();
                        };
                    }


                };

            };
            aviewer.modifyImageUI.find(".imageObject").click(aviewer.modifyImageUI.action_imageObject);


            aviewer.modifyImageUI.action_uploadImageObject = function () {
                window.ui.modals.question("Upload Image", '').ready = function () {
                    var md = this;
                    md.$.css("min-width", "330px").css("width", "330px");                
                    md.$.find('.ui-ui-modal-ok-button').addClass('btn-success').html("Upload Image").fileUploadButtonEx({
                        accept: "image/*", onFileData: function (data) {                        
                            window.checkImageSource(data, function () {
                                var mg = aviewer.fabricCanvas.newObject({
                                    imageObject: true, originX: "center", originY: "center", centeredScaling: true, textAlign: "center",
                                    left: 0, top: 0, width: this.width, height: this.height, cornerSize: 40,
                                    _render: function (ctx) {
                                        ctx.drawImage(this.img, -this.width / 2, -this.height / 2, this.width, this.height);
                                    },
                                    ready: function () {
                                        this.img = new Image();
                                        this.img.src = data;

                                        var sw = this.width;
                                        var sh = this.height;
                                        var mw = aviewer.fabricCanvas.resizingBox.width;
                                        var mh = aviewer.fabricCanvas.resizingBox.height;
                                        var scale = 1;

                                        if (sw > sh) {
                                            scale = mw / sw;
                                            sh = sh * scale;
                                            if (sh > mh) scale *= (mh / sh);
                                            sw *= scale;
                                        }
                                        else {
                                            scale = mh / sh;
                                            sw = sw * scale;
                                            if (sw > mw) scale *= (mw / sw);
                                            sh *= scale;

                                        }

                                        this.scaleX = scale;
                                        this.scaleY = scale;


                                    }
                                });
                                mg.setCoords();
                                aviewer.fabricCanvas.resizingBox.bringToFront();
                                aviewer.fabricCanvas.setActiveObject(mg);
                                md.close(false);
                            });
                        }
                    });

                    md.closing = function (res) {
                          return (!res);
                    };



                    md.$.find('.ui-ui-modal-cancel-button').html("Cancel");
                  

                };
            };
            aviewer.modifyImageUI.find(".uploadImageObject").click(aviewer.modifyImageUI.action_uploadImageObject);
            

            aviewer.modifyImageUI.action_emojObject = function () {
                window.ui.modals.question("Select Emoj", '<input type="range" min="0" max="10" value="5" style="width:99%;margin-left:1%" /><div style="height:340px;overflow-y:auto;border-radius:12px;border:solid 1px silver"> <ul class="list-unstyled"></ul></div>').ready = function () {
                    var md = this;
                    md.$.css("min-width", "320px").css("width", "320px");
                    md.$.find('.ui-ui-modal-ok-button').html("Confirm");
                    md.$.find('.ui-ui-modal-cancel-button').html("Close");
                    md.emojSpeed = 100 + (((10 - 5) - 5) * 7);
                    md.emojSpeedValue = 5;
                    md.runEmoj = function (md) {

                        if (md.selectedEmoj) {
                            md.runingEmoj = true;
                            var img = md.selectedEmoj.image;
                            img.totalFrames = img.width / img.height;
                            if (img.frameIndex > img.totalFrames - 1) img.frameIndex = 0;


                            md.emojSpeed = (1500 + (((10 - md.emojSpeedValue) - 5) * 250)) / img.totalFrames;

                            img.style.marginLeft = (-img.frameIndex * img.height) + "px";
                            //console.log("md.emojSpeed", md.emojSpeed);
                            img.frameIndex++;
                            md.runingEmoj = true;
                            if (!md.isClosed) {
                                setTimeout(md.runEmoj, md.emojSpeed, md);
                            }
                        }

                    };


                    md.closing = function (res) {
                        md.isClosed = true;
                        if (res && md.selectedEmoj) {
                            var img = md.selectedEmoj.image;
                            var sz = img.naturalHeight;
                            var mg = aviewer.fabricCanvas.newObject({
                                originX: "center", originY: "center", centeredScaling: true, textAlign: "center",
                                left: 0, top: 0, width: sz, height: sz, cornerSize: 40,
                                _render: function (ctx) {
                                    ctx.drawImage(this.img, 0, 0, this.width, this.height, -this.width / 2, -this.height / 2, this.width, this.height);
                                },
                                ready: function () {
                                    this.img = new Image();
                                    this.img.src = img.src;
                                    var self = this;
                                    this.emoj = {
                                        image: img.src, speed: md.emojSpeed, width: img.naturalWidth, height: img.naturalHeight,

                                    };
                                }
                            });

                            mg.setCoords();
                            mg.bringToFront();
                            aviewer.fabricCanvas.setActiveObject(mg);
                        }
                        return (true);
                    };

                    md.$.find("input")[0].onchange = function () {

                        md.emojSpeedValue = this.value;

                    };

                    var list = md.$.find(".list-unstyled");
                    for (var i = 1; i < 12; i++) {
                        var tm = $('<li class="imagelist-item  media emoj-list-item"><div><img class="mr-3"  height="60" src="' + window.appUrl + '/images/emojs/' + i + '.png" /></div></li>');
                        list.append(tm);
                        tm[0].onclick = function () {
                            list.find(".emoj-list-item").removeClass("selected");
                            $(this).addClass("selected");
                            md.selectedEmoj = this;
                            if (!md.runingEmoj) md.runEmoj(md);
                        };
                        tm.find("img").each(function () {
                            this.frameIndex = 0;
                            tm[0].image = this;
                        });
                    }




                };

            };
            aviewer.modifyImageUI.find(".emojObject").click(aviewer.modifyImageUI.action_emojObject);

        

            
            aviewer.fabricCanvas.renderAll();

            aviewer.fabricCanvas.__onMouseDown = function (e) {
                e = aviewer.fabricCanvas.processMosuedown(e);
                if (aviewer.fabricCanvas.drawingMode) {
                    return;
                }
                if (aviewer.fabricCanvas.ignoreMousedown) {
                    aviewer.fabricCanvas.ignoreMousedown = false;
                    return;

                }
                return aviewer.fabricCanvas.__onMouseDown_old(e);

            };

            aviewer.modifyImageUI.confirmButton.onclick = function () {
                aviewer.fabricCanvas.resizingBox.visible = false;

                aviewer.fabricCanvas.emojs = [];
                var canvasObjects = 0;
                aviewer.fabricCanvas.forEachObject(function (obj) {
                    if (obj.emoj) {
                        obj.emoj.x = obj.left;
                        obj.emoj.y = obj.top;
                        obj.emoj.sx = obj.scaleX;
                        obj.emoj.sy = obj.scaleY;
                        aviewer.fabricCanvas.emojs.push(obj.emoj);
                        aviewer.fabricCanvas.deleteObject(obj);
                    }
                    else canvasObjects++;
                });
                console.log("canvasObjects", canvasObjects);
                console.log("aviewer.fabricCanvas.emojs", aviewer.fabricCanvas.emojs);

                aviewer.fabricCanvas._discardActiveObject();
                var url = aviewer.fabricCanvas.toDataURL({
                    left: (aviewer.fabricCanvas.resizingBox.left - aviewer.fabricCanvas.pan.x) - aviewer.fabricCanvas.resizingBox.width * 0.5,
                    top: (aviewer.fabricCanvas.resizingBox.top - aviewer.fabricCanvas.pan.y) - aviewer.fabricCanvas.resizingBox.height * 0.5,
                    width: aviewer.fabricCanvas.resizingBox.width, height: aviewer.fabricCanvas.resizingBox.height,                    
                });
                
                aviewer.fabricCanvas.resizingBox.visible = true;
              
                if (canvasObjects > 2) {
                    window.checkImageSource(url, function () {
                        console.log("image updated");
                        aviewer.fabricCanvas.resCanv.setSize(aviewer.fabricCanvas.sww, aviewer.fabricCanvas.shh);
                        aviewer.fabricCanvas.resCanv.ctx.drawImage(this, 0, 0, this.width, this.height, 0, 0, aviewer.fabricCanvas.sww, aviewer.fabricCanvas.shh);
                        if (aviewer.fabricCanvas.modifyImageComplete) {
                            aviewer.fabricCanvas.modifyImageComplete(aviewer.fabricCanvas.resCanv.toDataURL("image/png"), aviewer.fabricCanvas.emojs);
                            aviewer.modifyImageUI.hide();
                        }
                    });
                }
                else {
                    aviewer.fabricCanvas.resCanv.setSize(aviewer.fabricCanvas.sww, aviewer.fabricCanvas.shh);
                    if (aviewer.fabricCanvas.modifyImageComplete) {
                        aviewer.fabricCanvas.modifyImageComplete(aviewer.fabricCanvas.resCanv.toDataURL("image/png"), aviewer.fabricCanvas.emojs);
                        aviewer.modifyImageUI.hide();
                    }
                }
               

             
               
            };
            aviewer.modifyImageUI.cancelButton.onclick = function () {

                aviewer.modifyImageUI.hide(); 
                if (aviewer.fabricCanvas.modifyImageCancel) aviewer.fabricCanvas.modifyImageCancel();
            };
        }
        else {
            aviewer.fabricCanvas.forEachObject(function (obj) {
                if (!obj.resizingBox) {
                    aviewer.fabricCanvas.deleteObject(obj);
                }
            });
            $(".hideWrittingUI").show();
            aviewer.modifyImageUI.penOptions.$.hide();
            aviewer.fabricCanvas.drawingMode = false;
            aviewer.fabricCanvas.drawing.reset();
            aviewer.modifyImageUI.show();
        }
         if (modifyImageAction.defaultAction == "Emoji") {
             aviewer.modifyImageUI.action_emojObject();
         }
         else if (modifyImageAction.defaultAction == "Text") {
             aviewer.fabricCanvas.editTextBox(aviewer.fabricCanvas.addTextBox("Text field"));
             aviewer.fabricCanvas.renderAll();
         }
         else if (modifyImageAction.defaultAction == "Image") {
             aviewer.modifyImageUI.action_uploadImageObject();
         }
         else if (modifyImageAction.defaultAction == "Pen") {
             aviewer.modifyImageUI.action_penObject();
         }

         aviewer.modifyImageUI.editTitle.$.html(editTitle);
         aviewer.fabricCanvas.modifyImageComplete = modifyImageComplete;
         aviewer.fabricCanvas.modifyImageCancel = modifyImageCancel;
         aviewer.fabricCanvas.sww = sww;
         aviewer.fabricCanvas.shh = shh;

        var sw = sww;
        var sh = shh;
        var mw = aviewer.fabricCanvas.width - 50;
        var mh = aviewer.fabricCanvas.height - 50;
        var scale = 1;

        if (sw > sh) {
            scale = mw / sw;
            sh = sh * scale;
            if (sh > mh) scale *= (mh / sh);
           sw *= scale;
        }
        else {
            scale = mh / sh;
            sw = sw * scale;
            if (sw > mw) scale *= (mw / sw);
            sh *= scale;

        }
        aviewer.fabricCanvas.drawing.reset();
        aviewer.fabricCanvas.resizingBox.width = sww * scale;
        aviewer.fabricCanvas.resizingBox.height = shh * scale;

        aviewer.fabricCanvas.scale = scale;
        aviewer.fabricCanvas.resizingBox.setCoords();
        aviewer.fabricCanvas.renderAll();

        console.log("aviewer.fabricCanvas.scale", aviewer.fabricCanvas.scale);

       
    }
    window.loadJSFile(document, window.appUrl + "/fabric.min.js").onload = function () {
        //setTimeout(function () { aviewer.modifyImage(false, 300, 400); }, 200);
    };


    window.loadJSFile(document, window.appUrl + "/lame.min.js").onload = function () { };

    
    if (!window.audioinput) {
        /*
        window.loadJSFile(document, window.appUrl + "/audioInputCapture.js").onload = function () {

            console.log("define window.audioinput", audioinput);
            audioinput._initWebAudio();

        };
        */

    }


    if (!window.isMobileDevice) {
        window.mainContainer.css("width", "100%").css("left", "0%").css("margin-left", "0");
    }
   
    aviewer.showUserMenu = function (icon) {
        $(icon).parent().append(aviewer.userMenu);
        aviewer.userMenu.toggleClass('show');

    };
    aviewer.userLoginLink = function () {
        
        aviewer.app.loginUser(function (user) {
            $(document.body).addClass('userIsLoggedIn');

        });

    };

    aviewer.userLogout = function () {
        $(document.body).removeClass('userIsLoggedIn');
        aviewer.app.logoutUser();

    };
    


    if (!window.isMobileDevice) {
       

    }


    window.trim_string = function (str, length) {
        var s = str.toString();
        if (s.length > length)
            return (s.substr(0, length) + "...");
        else
            return (s);
    };
</script>
<style>
    .ui-ui-modal-action-buttons1 button {
        margin-left:-65px !important;
    }
    .form-control {
        
        background-color: #eeeeee;border-radius: 10px;line-height: 1.65;
        margin-bottom:10px;margin-top:10px;
        
    }
  .likeButton.liked {

  }
    body, body * {
           font-family: 'Open Sans', sans-serif;
        }
     h1,h2,h3,h4,h5,h6 {
         text-transform:none !important;
     }
    .box-shadow-menu:before {
        background: #d71a1a !important;
        box-shadow: 0 0.3em 0 0 #d71a1a, 0 0.6em 0 0 #d71a1a !important;
    }

    .listItemTemplate .imgWrapper {
        width: 142px;
        height: 92px;
        overflow: hidden;
        margin:10px;
        background-color:#f1f1f1;
    }

    .listItemTemplate {
        border-bottom: solid 1px #f3f3f3;
        margin-bottom: 2px;
    }
    .listItemTemplate .media-body {
        margin-top:20px;
    }

    

        .listItemTemplate h3,.listItemTemplate h4,.listItemTemplate h5 {
            color: black;
            text-transform:none;
        }
         .listItemTemplate  h3 {
        font-weight:600;
        font-size:14px;
        }

         .listItemTemplate  h5 {
        font-weight:300;
        font-size:14px;
        color:gray;
        }

          .listItemTemplate  h4 {
        font-weight:400;
        font-size:14px;
        color:gray;
        }


    
    .listItemTemplate:hover,.listItemTemplate:active {
        background-color:#ebebeb;
    }
    .buttonRadius {
        border-radius:18px;
    }

    .listOfItemsArea {
        padding:0; position:absolute;top:50px;bottom:0px;left:0;right:0;width:100%;height:calc(100% - 50px);overflow-y:auto;overflow-x:hidden;border-top:solid 1px #f3f3f3

    }
    .listOfItems {
        display: inline-block;
        width: 100%;
    }
    .btn {
        border-radius:1px;
         
    }
    .ui-ui-modal .btn ,.btn.withShadow{
        -webkit-box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.43);
                -moz-box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.43);
                box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.43);
                    font-size: 0.8rem;
                    background-color:#c4c4c4;
                    border-color: #c4c4c4;
                        text-transform: uppercase;
                        color:white !important;
                        width: 130px;
    }
    .btn-primary,.btn-primary:disabled {
       
         background-color: #0068c8;
        border-color: #0068c8;
    }


    .btn-success,.btn-success:disabled {

        background-color: #3ab100;
        border-color: #3ab100;
    }

    .btn-danger,.btn-danger:disabled {
        

        background-color: #ec4534 !important;
        border-color: #ec4534  !important;
    }
    .btn-default,.btn-default:disabled {
        color:white;
        background-color: #8d8d8d;
        border-color: #8d8d8d;
    }
     .btn-default2,.btn-default2:disabled {
        color:white;
        background-color: #434343;
        border-color: #434343;
    }
    

    .sz100P {
        width:100%;
    }

    @media (min-width: 900px) {
        
        .listItemTemplate {
            width:50%;
            float:left;

        }

         .listItemTemplate .media-body {
            transform:scale(0.9);
            transform-origin:left top;
        }

        .listOfItems,.ugcListPageTop {
           position:absolute;
           left:50% !important;
           width:900px !important;
           margin-left:-450px !important;
           border-left:solid 1px #e0e0e0;
           border-right:solid 1px #e0e0e0;
          


        }

    }

     @media (min-width: 11200px) {
       
        .listItemTemplate {
            width:33.33%;
            float:left;
            
        }
        .listItemTemplate .media-body {
            transform:scale(0.85);
            transform-origin:left top;
        }

         .listOfItems,.ugcListPageTop {
           position:absolute;
           left:50%;
           width:1200px;
           margin-left:-600px;
        }

    }

    .header-button {
        position: absolute;
        font-size: 120%;
        color: #fff;
        bottom: 8px;
    }
 
    .ui-ui-modal {
        position: absolute;
        left: 50%;
        top: 50%;
        font-family: inherit;
        border-radius: 0;
        background-color: white;
        -webkit-box-shadow: 0px 0px 17px 0px rgba(0,0,0,0.53);
                -moz-box-shadow: 0px 0px 17px 0px rgba(0,0,0,0.53);
                box-shadow: 0px 0px 17px 0px rgba(0,0,0,0.53);
                border:0 !important;
    }
    .popover-body {
        padding: 9px 14px;
        color: #212529;
         margin-bottom: 0;
         padding-bottom:25px;
    }
    .popover-header {
        padding: 8px 14px;
        margin-bottom: 0;
        font-size: 1rem;
        color: white;
        background-color: #ec4534;
        border-bottom:none;
      border-top-left-radius:0;
        border-top-right-radius: 0;
    }
    

    .ui-ui-modal-title-span {
        font-weight:700;
    }
    .badge {
        width: 48px;
        height: 48px;
        padding-top: 5px;
        border-radius: 100%;
    }

    .custom-control-input:active ~ .custom-control-indicator {
        color: #fff;
        background-color: #d71a1a;
    }


    .custom-checkbox .custom-control-indicator {
        border-radius: .25rem;
    }
    .custom-control-input:checked ~ .custom-control-indicator {
        color: #fff;
        background-color: #d71a1a;
    }
     .custom-control-indicator {
        position: absolute;
        top: .25rem;
        left: 0;
        display: block;
        width: 1rem;
        height: 1rem;
        pointer-events: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        background-color: #d71a1a;
        background-repeat: no-repeat;
        background-position: center center;
        background-size: 50% 50%;
    }
    .custom-control-input:checked ~ .custom-control-indicator {
        color: #fff;
        background-color: #d71a1a;
    }

    .imagelist-item {
        float:left;
        margin:2px;
        width:62px;
        height:62px;
        padding:1px;
    }
    .imagelist-item:hover {
        border:solid 1px gray;
    }
    .imagelist-item img {
        width:100%;
        height:100%;
    }
    .ui-ui-modal-title {
        text-align: center;
    font-size: 130%;
        color: #e3e3e3;
    }
</style>

<style>
    body .userMenu .userLinks {
         display:none !important; 
    }
    body.userIsLoggedIn .userMenu .userLinks {
        display:inherit !important;
    }
    body.userIsLoggedIn .userMenu .userLoginLink {
        display:none !important;
    }
     

</style>

<div data-bind="appView" style="position:absolute;left:0;top:0px;right:0;height:100%; overflow:hidden;">
    <input data-bind="copyURLText" type="text" class="form-control" style="display:none;margin-bottom:20px; width:100%" />
    
</div>


<script type="text/html" data-execute="aviewer.userMenu=$($(this).html())">
    <div  onclick="$(this).removeClass('show');" class="dropdown-menu userMenu" style="right:0;left:unset">
        <a class="dropdown-item userLoginLink" onclick="aviewer.userLoginLink(); return (false);" href="#">Login</a>
        <a class="dropdown-item myUGCListLink userLinks" onclick="aviewer.app.showMyUGCList();return (false);" href="#">My UGC List</a>
        <a class="dropdown-item userSettingsLink userLinks" onclick="aviewer.app.userSettings(); return (false);" href="#">Settings</a>
        <a class="dropdown-item userLogoutLink userLinks"  onclick="aviewer.userLogout(); return (false);" href="#">Logout</a>
        
    </div>

</script>


<script type="text/html" data-execute="aviewer.maskingImageFiltersUI=$(this).html()">
    <div style="position:absolute;left:0;top:0;width:100%;height:100%;background-color:white; pointer-events:fill">
        <style>
            .filtersTab ul  {
                padding-left:5px;
                padding-right:5px;
                position:absolute;
                left:0;right:0;top:-5px;
            }

            .filtersTab ul li {
                width:33.3%;
            }
            .filtersTab ul li a {
                display:block;
                width:100%;
                color: white;
                background-color: #dadada;
                border-color: #dadada;
                border-top-left-radius:10px;
                border-top-right-radius:10px;
                padding-top:8px;
                padding-bottom:8px;
            }
            .filtersTab ul li.active a {
                display:block;
                width:100%;
                color: white;
                background-color: #676767;
                border-color: #676767;
            }

            .filtersTab .tab-pane {
                 position:absolute;
                left:0;right:0;bottom:0;
                top:30px;
                 background-color: #676767;
                 overflow-x:auto;
                 padding:5px;                     
            }
            .filtersTab .tab-pane button {
                float:left;
                margin:3px;
                border-radius:8px;
                padding:8px;
                background-color: #a5a5a5;
                border-color: #a5a5a5;
                color:#f3f3f3;
            }

            .filtersTab .tab-pane button.active {               
                background-color: #d0d0d0;border-color: #d0d0d0;
                color:#f3f3f3;
            }

        </style>
      
        <div class="filtersTab" style="position:absolute;left:0;right:0;bottom: 50px; height: 130px;">
            <ul class="nav nav-tabs " role="tablist" style="">
                <li class="active">
                    <a href="#firstFilter" class="btn btn-default btn-sm">First Filter</a>
                </li>
                <li>
                    <a href="#SecondFilter" class="btn btn-default btn-sm" >Second Filter</a>
                </li>
                <li>
                    <a href="#thirdFilter" class="btn btn-default btn-sm">Third Filter</a>
                </li>
            </ul>
            <div class="tab-pane firstFilter"></div>
            <div class="tab-pane SecondFilter"></div>
            <div class="tab-pane thirdFilter"></div>
        </div>
     
        

        <div style="position:absolute;left:0;right:0;height:50px;bottom:0;background-color:white;padding-top:8px">
            <button class="maskingImageConfirmButton btn btn-success withShadow" style="background-color: #ec4534;border-color: #ec4534; pointer-events:fill;position:absolute;right:10px;width:100px">Next >></button>
            <button class="maskingImageCancelButton btn btn-default withShadow" style="pointer-events:fill;position:absolute;left:10px; width:100px">Cancel</button>

        </div>
     </div>
</script>

<script type="text/html" data-execute="aviewer.maskingImageManipulatorUI=$(this).html()">
    <div style="position:absolute;left:0;top:0;width:100%;height:100%; pointer-events:none">
        <h5 class="maskingImageManipulatorTitle" style="position:absolute;left:0;right:0;top:5px;padding:5px;text-align:center">Edit Masking</h5>
        <i class="fa fa-repeat" style="position:absolute;left:50%;top:40px;margin-left:-16px;font-size:32px;color:white"></i>
        <input class="maskingImageRotator" type="range" min="-180" max="180" value="0" style="pointer-events:fill; position:absolute;left:20px;top:80px;width:calc(100% - 40px)" />
       
        <i style="font-size:32px;color:white;position:absolute;right:8px;top:50%" class="maskingImageScalerPOS fa fa-minus "></i>
        <i style="font-size:32px;color:white;position:absolute;right:8px;top:50%" class="maskingImageScalerPOS fa fa-plus"></i>

        <input class="maskingImageScalerPOS maskingImageScaler" type="range" min="1" max="100" value="50"  style="pointer-events:fill; position:absolute;left:calc(100% - 30px);transform-origin:left top;top:50%;width:calc(100% - 40px);transform:rotate(-90deg)" />

        <button class="maskingImageConfirmButton btn btn-success withShadow" style=" pointer-events:fill;position:absolute;right:10px;bottom:10px; width:100px">Confirm</button>
        <button class="maskingImageCancelButton btn btn-default withShadow" style="pointer-events:fill;position:absolute;left:10px;bottom:10px; width:100px">Cancel</button>
    </div>
</script>


    <script type="text/html" data-execute="aviewer.motionBooksUI=$(this).html()">
        <div class="ui-views-fullscreen-view mainScreenView">
            <div class="header-bar" >
                <div class="logo" style="width:100%;text-align:center;">
                    <img data-bind="anipartiLogo" src="http://mad.aniparti.com/global/img/logo-aniparti-plain-white-shadow.png" height="30" style="margin-top:11px">
                </div>

                <div class="header-button" style="right:10px;top:10px;">
                    <i class="fa fa-navicon" onclick="aviewer.showUserMenu(this);"></i>
                </div>



            </div>

            <div data-bind="listArea" class="container-fluid listOfItemsArea" style="top:50px;bottom:0px;height:calc(100% - 50px);">

                <div data-bind="listItems" class="listOfItems"></div>

            </div>
        </div>
    </script>

    <style>
        .loginUserUI p {
            margin-top:6px;
            margin-bottom:6px;
        }
         .loginUserUI input {
             border:none;
             border-bottom:solid 2px black;
             text-align:left;
             border-radius:unset;
             font-size:110%;
         }
         .loginUserUI button {
             width:80%;
             margin-top:5px;
             border-radius:20px;
             font-size:110%;
             font-weight:bold;
         }
         .loginUserUI label{
             float:left;
         }
    </style>
    <script type="text/html" data-execute="aviewer.loginUserUI=$(this).html()">
        <div class="ui-views-fullscreen-view loginUserUI" style="text-align:center;padding:20px;overflow-x:hidden;overflow-y:auto">
            <a class="header-button" onclick="aviewer.app.popView()" style="left:10px;top:10px;"><i class="fa fa-arrow-left"></i></a>

            <p>
                <img src="http://mad.aniparti.com/global/img/logo-aniparti.png" height="130" />

            </p>
            <p>
                <h5 style="color:black;padding:20px;font-weight:bold">Share <br /> your motions comics to the world!</h5>
            </p>
            <div style="width:300px;position:absolute;left:50%;margin-left:-150px;">
                <div class="form-group">
                    <input type="text" data-bind="userName" class="form-control" placeholder="ID">
                </div>
                <div class="form-group">
                    <input type="password" data-bind="userPassword" class="form-control" placeholder="Password">
                </div>

                <div class="form-group">
                    <p>
                        <button data-bind="signInButton" class="btn btn-danger">Sign In</button>
                        
                        <button data-bind="signUpButton" type="button" class="btn btn-link">Sign Up</button>
                        <button type="button" class="btn btn-link">Forgot your password?</button>
                    </p>

                    <p style="margin:20px;">
                        <img src="http://mad.aniparti.com/global/img/cparti-logo.png" height="40" />
                    </p>
                    <p>
                        <label style="font-size:80%;width:100%;text-align:center">CrowdParti Co., Ltd. All rights Reserved</label>

                    </p>

                </div>
            </div>

        </div>
    </script>



<script type="text/html" data-execute="aviewer.registerUserUI=$(this).html()">
    <div class="ui-views-fullscreen-view loginUserUI registerUserUI" style="text-align:center;padding:20px;overflow-x:hidden;overflow-y:auto">
        <a class="header-button" onclick="aviewer.app.popView()" style="left:10px;top:10px;color:#ec4534"><i class="fa fa-arrow-left"></i></a>
        <p data-bind="userPicture">
            <img  src="http://mad.aniparti.com/global/img/large-user-avatar.png" height="130" />

        </p>
        <div style="width:300px;position:absolute;left:50%;margin-left:-150px;margin-top:20px;">
            <div class="form-group">
               
                <input type="text" data-bind="userName" value1="asif1001" class="form-control" placeholder="Username">
            </div>
            <div class="form-group">
                
                <input type="email" data-bind="userEmail" value1="asif1001@hotmail.com" class="form-control" placeholder="Email">
            </div>
            <div class="form-group">
              
                <input type="password" data-bind="userPassword" value1="Vtech123" class="form-control" placeholder="Password">
            </div>
            <div class="form-group">
               
                <input type="password" data-bind="userCPassword" value1="Vtech123" class="form-control" placeholder="Confirm Password">
            </div>

            <div class="form-group" style="margin-top:20px">
                <p>
                    <button data-bind="signUpButton" class="btn btn-danger">Sign Up</button>
                   

                </p>

                <p style="margin:20px;">
                    <img src="http://mad.aniparti.com/global/img/cparti-logo.png" height="40" />
                </p>
                <p>
                    <label style="font-size:80%;float:none">CrowdParti Co., Ltd. All rights Reserved</label>

                </p>

            </div>
        </div>


        <div style="position:absolute;left:0;top:0;right:0;bottom:0px; display:none;overflow:hidden" data-bind="imageCropper">
            <a class="header-button" data-bind="cancelImageCropper" style="left:10px;top:10px;"><i class="fa fa-arrow-left"></i></a>
            <a class="header-button" data-bind="doneImageCropper" style="right:10px;top:10px;"><i class="fa fa-check"></i></a>

            <div style="position:absolute;left:0;top:50px;right:0;bottom:110px;" data-bind="imageCropperDiv">


            </div>
        </div>
    </div>
</script>
<style>
    .header-bar{
        height:50px;left:0;top:0;right:0;position:absolute;background-color:#ec4534;
    }
    .header-bar  >a {
        color:white !important;
    }
</style>
<script type="text/html" data-execute="aviewer.userSettingsUI=$(this).html()">
    <div class="ui-views-fullscreen-view loginUserUI registerUserUI" style="text-align:center;padding:20px;overflow-x:hidden;overflow-y:auto;padding-top:50px;">
        <div class="header-bar">
            <a class="header-button" onclick="aviewer.app.popView()" style="left:10px;top:10px;color:#ec4534"><i class="fa fa-arrow-left"></i></a>
           
        </div>
        <div style="width:300px;position:absolute;left:50%;margin-left:-150px;margin-top:20px;">
            <p data-bind="userPicture">
                <img src="http://mad.aniparti.com/global/img/large-user-avatar.png" height="130" style="border-radius:100%" />

            </p>
            <table style="width:100%">
                <tr>
                    <td><label style="font-weight:bold">NAME&nbsp;</label></td>
                    <td><label>{{aviewer.user.username}}</label></td>
                </tr>
                <tr>
                    <td><label style="font-weight:bold">EMAIL&nbsp;</label></td>
                    <td><label>{{aviewer.user.email}}</label></td>
                </tr>
                <tr><td>&nbsp;</td></tr>
                <tr><td colspan="2" align="center"><button class="btn btn-default sz100P" style="color:white">Change Password</button></td></tr>
            </table>
          
        </div>
    </div>
</script>

<style>
    .playBookUI .navigationBar {
        position:absolute;left:0;right:0;bottom:0;height:50px;
        opacity:0.9;
        background-color:#c7c7c7;
    }
    .playBookUI .navigationBar i {
        font-size:38px;
        position:absolute;
        top:5px;
        color:gray;
    }
    .playBookUI .navigationBar i.fa-refresh {
        left:2%;
    }
    .playBookUI .navigationBar i.fa-cloud-upload {
        right:2%;
        color1:#0068c8;
         display:none;
    }

    .playBookUI .navigationBar i.likeButton {
        left:30%;
        color1:#d71a1a;
        display:none;
    }


    .playBookUI .navigationBar i.fa-chevron-up {
        left:calc(50% - 30px);
    }

     .playBookUI .navigationBar i.fa-chevron-down {
        right:2%;
    }

     

    .playBookUI .navigationBar i.likeButton:before {
            content: "\f08a";
    }

    .playBookUI .navigationBar i.likeButton.liked:before {
            content: "\f004";
    }


    .likeSupport .navigationBar i.likeButton {       
        display:inherit;
    }

     .likeSupport .navigationBar i.fa-chevron-up {
        left:60%
    }

     .likeSupport .navigationBar i.fa-chevron-down {
        right:2%;
    }

     .shareSupport .navigationBar i.fa-cloud-upload {
       display:inherit;
    }

     .shareSupport .navigationBar i.fa-chevron-up {
        left:30%
    }

     .shareSupport .navigationBar i.fa-chevron-down {
        left:60%;
    }

    .navigationBar .pageDisplay1 {
            color:black;
            position:absolute;
            left:0;top:-20px;
            border-radius:20px;
            background-color:#c7c7c7;
        
                padding-bottom:20px;
                padding-left:10px;
                padding-right:10px;
            text-align:center;
            pointer-events:none;
            text-transform:uppercase;
              font-size:80%;
              width:100px;
        }

     .navigationBar .loadingText {
            color:black;
            position:absolute;
            left:50%;top:-20px;
            width:80px;
            margin-left:-40px;
           
             text-align:center;
            pointer-events:none;
            font-size:70%;
            text-transform:uppercase;

        }


</style>
    <script type="text/html" data-execute="aviewer.playBookUI=$(this).html()">
        <div class="ui-views-fullscreen-view playBookUI" ></div>
    </script>

    <script type="text/html" data-execute="aviewer.saveAndPublishUI=$(this).html()">


        <div class="form-group" style="min-height:160px;position:relative">
            <h6 style="color:gray;margin-top:15px">Set title:</h6>
            <input type="text" data-bind="publishTitle" class="form-control" style="background-color: #eeeeee;border-radius: 10px;line-height: 1.65;">
            <label style="position:absolute;left:70px;top:100px;"><input type="radio" name="publishMode" checked data-bind="publishModePublic" style="margin-right:20px"  />For the public</label>

             <label style="position:absolute;left:70px;top:130px;"><input type="radio" name="publishMode" data-bind="publishModePrivate" style="margin-right:20px" />Private only</label>
           

        </div>
    </script>



<script type="text/html" data-execute="aviewer.shareUGCUI=$(this).html()">
    <div style="text-align:center;padding:5px;">
        <h4 style="color:black;text-decoration:underline">How to share</h4><br />
        <input type="text" contenteditable="true" style="position:absolute;width:100px;left:-1000px" class="copyUrlText" />
        <p><button class="btn btn-default2 buttonRadius sz100P copyByUrl"><i style="color:#858687" class="fa fa-link"></i> Copy URL</button></p> 
        <p><button class="btn btn-primary buttonRadius sz100P" disabled>Share to QQ</button></p>
        <p><button class="btn btn-success buttonRadius sz100P" disabled>Share to WeChat</button></p>
        <p><button class="btn btn-default buttonRadius  ui-ui-modal-cancel-button">Ok</button></p> 
    </div>
    
    

</script>



    <script type="text/html" data-execute="aviewer.dubAudioUI=$(this).html()">
        <table style="width:100%;" >
            <tr>
                <td><a href="#" class="badge badge-pill badge-danger pull-left"><i class="fa fa-3x fa-close"></i></a></td>
                <td><h3 style="color:silver;text-align:center;font-size:48px" class="recordingTimeDisplay">00:00</h3></td>
                <td><a href="#" style="padding-top:11px;padding-left:10px" class="badge badge-pill badge-success pull-right"><i class="fa fa-2x fa-play"></i></a></td>
                

            </tr>
            <tr><td>&nbsp;</td></tr>
        </table>
        <div style="position:absolute;width:80%;height:1px;background-color:#8d8d8d;bottom:20px;left:10%"></div>
    </script>
<style>
       .motionBookItemTemplate .media-body a {
                    display: inline-block;
                    min-width: 40px;
                }

            .motionBookItemTemplate h3 {
                margin-bottom: 10px;
            }

            .motionBookItemTemplate h5 {
               

            }

            .motionBookItemTemplate h4 {
                

                margin-bottom:10px;
            }

            .motionBookItemTemplate .fa-heart-o {
                color: #ec4534;
            }
            

</style>

    <script type="text/html" data-execute="aviewer.motionBookItemTemplate=$(this).html()">
        <div class="media listItemTemplate motionBookItemTemplate">
            <div class="imgWrapper">
                <img class="d-flex mr-3" height="92" src="{{aviewer.serverUrl+item.repo_path}}" alt="image">

            </div>
            <div class="media-body">
                <h3 class="mt-0">{{window.trim_string(item.name,20)}} </h3>
                <h4>{{Date.fromatFromTime(item.created_date,"yyyy.mm.dd")}}</h4>
               
            </div>
        </div>


    </script>

    <script type="text/html" data-execute="aviewer.userGeneratedBooksUI=$(this).html()">
        <div class="ui-views-fullscreen-view">
            <div class="header-bar">
                <div class="logo" style="width:100%;text-align:center;">
                    <img data-bind="anipartiLogo" src="http://mad.aniparti.com/global/img/logo-aniparti-plain-white-shadow.png" height="30" style="margin-top:11px">

                </div>

                <div class="header-button" style="right:10px;top:10px;">
                    <i class="fa fa-navicon" onclick="aviewer.showUserMenu(this);"></i>
                </div>

                <a class="header-button" data-bind="backToListButton" onclick="aviewer.app.popView();history.pushState(null, null, 'ugc');" style="left:10px;top:10px;"><i class="fa fa-arrow-left"></i></a>

            </div>
            <div class="container-fluid ugcListPageTop" style="padding:0; position:absolute;top:50px;height:250px;left:0;right:0;width:100%;border-top:solid 1px #f3f3f3">
                
                <h3 style="font-size:110%;color:#ec4534;padding-left:10px;padding-top:10px">&nbsp;{{mainBook.name}}</h3>
                <div class="media listItemTemplate ugcListPageTop">
                    <div class="imgWrapper" style="height:150px;width:108px;">
                        <img data-bind="mainBookImage" class="d-flex mr-3" height="150"  alt="image">

                    </div>
                    <div class="media-body" style="height:149px;position:relative">
                        <h4>Published on <span style="color:#ec4534;"> {{Date.fromatFromTime(mainBook.modified_date,"ddd mmm dd yyyy")}} </span></h4>                        
                        <button data-bind="readOriginalButton" class="btn btn-sm btn-warning" style="border-radius:10px; position:absolute;left:0px;width:130px; bottom:10px;color:white">View Original</button>
                    </div>
                </div>
                <div style="position:absolute;left:10px;top:200px;right:10px;">
                    <a style="position: absolute;left: 10px;top: 10px;font-weight: bold;text-shadow: 1px 2px 4px #8d8d8d;font-size: 140%;color: white;" data-bind="refreshItemsLink"><i class="fa fa-refresh"></i></a>
                    <input placeholder="'title' or 'name'" data-bind="searchItemText" type="text" style="font-size: 90%;color: #a6a6a6;position: absolute;padding: 4px;left: 50px;top: 12px;width: calc(100% - 95px);border: solid 1px #e0e0e0;background-color: #e0e0e0;border-radius: 12px;padding-left: 20px;" />
                    <a style="position: absolute;right: 10px;top: 10px;font-weight: bold;text-shadow: 1px 2px 4px #8d8d8d;font-size: 140%;color: white;" data-bind="searchItemLink"><i class="fa fa-search"></i></a>
                </div>
            </div>
            <div data-bind="listArea" class="container-fluid listOfItemsArea" style="padding:0; position:absolute;top:300px;bottom:0px;left:0;right:0;width:100%;height:calc(100% - 300px);overflow-y:auto;overflow-x:hidden;border-top:solid 1px #f3f3f3">

                <div data-bind="listItems" class="listOfItems"></div>

            </div>
        </div>
    </script>
    <style>
        .userGeneratedBookItem {
            padding-right: 5px;
            position: relative;
        }

            .userGeneratedBookItem .imgWrapperUser {
                width: 48px;
                height: 48px;
                border-radius: 100%;
                margin-right: 20px;
            }

            .userGeneratedBookItem .media-body {
                margin-top: 10px;
            }

                .userGeneratedBookItem .media-body a {
                    display: inline-block;
                    min-width: 70px;
                }

            .userGeneratedBookItem h3 {
                margin-bottom: 8px;
                color:#ec4534;
                font-weight: 500;

            }

            .userGeneratedBookItem h5 {
               position:absolute;
               right:8px;
               top:12px;
               display:none;
            }

            .userGeneratedBookItem h4 {
                float: left;
                margin-top:0px;
            }

            .userGeneratedBookItem .fa {
                color: #ec4534;
                font-size:150%;
                font-weight:600;
            }

            .userGeneratedBookItem .imgWrapperUser .fa-play {
                position: absolute;
                left: 24px;
                top: 16px;
                font-size: 34px;
                color: #aba6a6;
                opacity: 0.7;
                visibility: hidden;
            }

            .userGeneratedBookItem:hover .imgWrapperUser .fa-play {
                visibility: visible;
            }
            .userGeneratedBookItem .media-body a.views {
                    float:right;
                    margin-right:5px;
                }
    </style>
    <script type="text/html" data-execute="aviewer.userGeneratedBookItemTemplate=$(this).html()">
        <div class="media listItemTemplate userGeneratedBookItem">
            <div class="imgWrapper imgWrapperUser">
                <img class="d-flex mr-3" height="48"  src="{{aviewer.serverUrl+'/assets/user_'+item.usid}}" alt="image">                
            </div>
            <div class="media-body">
                <h3 class="mt-0">{{window.trim_string(item.name,30)}} </h3>
                <h4>
                    <a><i class="fa fa-heart-o"></i> {{item.likes}}</a>
                    <a><i class="fa fa-comment-o"></i> {{item.comments}}</a>
                    <a><i class="fa fa-rss"></i> {{item.views}}</a>                   
                </h4>
                <h5>{{Date.fromatFromTime(item.created_date,"yyyy.mm.dd")}}</h5>
            </div>
        </div>


    </script>





<script type="text/html" data-execute="aviewer.myUGCListUI=$(this).html()">
    <div class="ui-views-fullscreen-view">
        <div class="header-bar">
            <div class="logo" style="width:100%;text-align:center;">
                <img data-bind="anipartiLogo" src="http://mad.aniparti.com/global/img/logo-aniparti-plain-white-shadow.png" height="30" style="margin-top:11px">
            </div>
            <a class="header-button" onclick="aviewer.app.popView(); " style="left:10px;top:10px;"><i class="fa fa-arrow-left"></i></a>

        </div>
         <div data-bind="listArea" class="container-fluid listOfItemsArea" style="padding:0; position:absolute;top:50px;bottom:0px;left:0;right:0;width:100%;height:calc(100% - 50px);overflow-y:auto;overflow-x:hidden;border-top:solid 1px #f3f3f3">
            <div data-bind="listItems" class="listOfItems"></div>

        </div>
    </div>
</script>

<style>
    .myUGCItemTemplate h4 {
        margin-top:10px;
    }


    .myUGCItemTemplate .actionButtons {
        display:none;
        position:absolute;
        bottom:5px;
        left:148px;
        right:5px;
    }
    .myUGCItemTemplate:hover .actionButtons {
        display:inherit;
    }
    .myUGCItemTemplate:hover  {
        height:140px;
    }
    .myUGCItemTemplate .imgWrapper .fa-play {
                position: absolute;
                left: 62px;
                top: 34px;
                font-size: 34px;
                color: #656565;
                opacity: 0.8;
                visibility: hidden;
            }

            .myUGCItemTemplate:hover .imgWrapper .fa-play {
                visibility: visible;
            }
            .actionButtons .btn-danger {
                position:absolute;
                right:20px;
                top:0;
            }
            .actionButtons .custom-checkbox{
                width:35%;
            }
</style>


<script type="text/html" data-execute="aviewer.myUGCItemTemplate=$(this).html()">
    <div class="media listItemTemplate userGeneratedBookItem myUGCItemTemplate">
        <div class="imgWrapper" style="height:82px;width:128px">
            <img class="d-flex mr-3" height="82" src="{{aviewer.serverUrl+item.repo_path}}" alt="image">
            <i class="fa fa-play"></i>
        </div>
        <div class="media-body">
            <h3 class="mt-0">{{item.name}} </h3>
            <h4>
                <a><i class="fa fa-heart-o"></i> {{item.likes}}</a>
                <a><i class="fa fa-share-alt"></i> </a>
                <a class="views"> {{item.views}} views</a>
            </h4>
            <h5>{{Date.fromatFromTime(item.created_date,"yyyy.mm.dd")}}</h5>
            
        </div>

        <div class="actionButtons">
            <label class="custom-control custom-checkbox pull-left">
                <input type="checkbox" {{item.scope==100 ? 'checked' : '';}} class="custom-control-input privatePublicCheckbox">
                <span class="custom-control-indicator"></span>
                <span class="custom-control-description ">Public</span>
            </label>
            &nbsp;|&nbsp;
            <button class="btn btn-sm btn-danger deleteButton">Delete</button>
        </div>
    </div>


</script>


<style>
    .emoj-list-item:hover {
        border:none;
        
    }

    .emoj-list-item {
        border:solid 1px transparent;
        
    }
    .emoj-list-item div {
        height:60px;
        width:60px;
        overflow:hidden;
        
    }
    .emoj-list-item.selected  {
         border:solid 1px silver;
    }
    .emoj-list-item img {
        width:auto;
    }
</style>
<script type="text/html" data-execute="aviewer.modifyImageUI=$($(this).html())">
    

    <div style="position:absolute;left:0;top:0;right:0;bottom:0;border:solid 0px red;background-color:#f5f5f5">
        <div style="position:absolute;left:0;top:0;right:0;bottom:0;">
            <canvas id="modifyImageCanvas" style="position:absolute;left:0;right:0;top:0;bottom:0"></canvas>
        </div>
        <h5 style="color:black;position:absolute;left:0;top:5px;right:0;text-align:center;pointer-events:none" data-bind="editTitle"></h5>
        <button data-bind="cancelButton" class="btn  btn-default hideWrittingUI" style="position:absolute;left:8px;bottom:8px;">Cancel</button>
        <button data-bind="confirmButton"  class="btn  btn-danger hideWrittingUI" style="position:absolute;right:8px;bottom:8px;">Confirm</button>
        
         <table data-bind="penOptions" cellpadding="2" width="100%" style="position:absolute;top:0;left:0;right:0;background-color:#f5f5f5;display:none;margin-top:5px">
            <tr>
                
                <td><div class="hideInput" data-bind="penSize"></div></td>
                <td><div style="border:solid 1px gray;border-radius:6px"><div data-bind="penSizeBall" style="transform:scale(0.5); width:18px;height:18px;border-radius:100%;background-color:black;margin:2px"></div></div></td>
                <td><div style="width:24px;height:24px;background-color:black;border-radius:6px" data-bind="penColor"></div></td>
                <td>&nbsp;</td>
                <td>
                    <button data-bind="penOkButton" class="btn btn-danger btn-sm">Ok</button>
                    
                </td>
                <td>
                    <button data-bind="penCancelButton" class="btn btn-default btn-sm">Cancel</button>
                </td>
            </tr>
        </table>
        <div class="ui-canvas-ItemEdit itemEditOptions" style="display:none">
            <a class="deleteObject btn btn-default" title="Delete object">
                <i class="fa fa-times"></i>
            </a>
            <a data-bind="editObjectButton" class="editObject btn btn-default" title="Edit" >
                <i class="fa fa-pencil"></i>
            </a>           
            <a class="duplicateObject btn btn-default" title="Duplicate object" style="display:none">
                <i class="fa fa-copy"></i>
            </a>

            <a class="sendToBack btn btn-default" style="display:none">
                <i class="fa fa-arrow-up"></i>
            </a>
           <a class="bringToFront btn btn-default"  style="display:none">
                <i class="fa fa-arrow-down"></i>
            </a>
        </div>

        <div class="ui-canvas-ItemEdit hideWrittingUI"  style="right:0;top:10%;">
            <a class="imageObject btn btn-default" >
                <i class="fa fa-comment-o"></i>
            </a>
            <a class="textObject btn btn-default" >
                <i class="fa fa-font"></i>
            </a>
            
            <a class="penObject btn btn-default"  >
                <i class="fa fa-paint-brush"></i>
            </a>

            <a class="emojObject btn btn-default">
                <i class="fa fa-smile-o"></i>
            </a>

            <a class="uploadImageObject btn btn-default">
                <i class="fa fa-picture-o"></i>
            </a>
        </div>
    </div>
   
</script>



<style>
    


    

    .userGeneratedBookCommentTemplate .imgWrapperUser {
        width: 48px;
        height: 48px;
        border-radius: 100%;
        margin-right: 15px;
    }
  

    .userGeneratedBookCommentTemplate .media-body h4 {
        padding-right:30px;
        font-size:11px;
        line-height:1.5;
        text-justify:distribute-all-lines;
        text-align:justify;

    }
    .userGeneratedBookCommentTemplate .media-body h3 {
        color:#434343;
    }
    .userGeneratedBookCommentTemplate .media-body h5 {
        display:block;
        font-size:70%;
        font-weight:500;
        color:#c3c3c3;
    }
</style>
<script type="text/html" data-execute="aviewer.userGeneratedBooksCommentsUI=$(this).html()">
    <div class="ui-views-fullscreen-view">
        <div class="header-bar" style="background-color:#dcd9d9;">
            <h5 style="color:#8d8d8d;padding-top:15px;text-align:center;font-size:100%">COMMENTS</h5> 


            <a class="header-button" data-bind="backToListButton" onclick="aviewer.app.popView();" style="right:10px;top:10px;"><i style="color:#646464" class="fa fa-times"></i></a>

        </div>

        <div data-bind="listArea" class="container-fluid listOfItemsArea" style="padding:0; position:absolute;top:50px;bottom:50px;left:0;right:0;width:100%;height:calc(100% - 100px);overflow-y:auto;overflow-x:hidden;border-top:solid 1px #f3f3f3">
            <a data-bind="viewPreviousCommentsLink" style="text-decoration: underline;color: #00417d;margin: 12px;display: block;padding: 5px;">View previous comments</a>
            <div data-bind="listItems" class="listOfItems">
                
            </div>

        </div>
        <div class="header-bar" style="background-color:#dcd9d9;top:auto;bottom:0">
            <input data-bind="postCommentText" type="text" style="position:absolute;padding:5px; left:7px;top:7px;width:calc(100% - 75px); border:solid 1px #ffffff ;background-color:#ffffff;border-radius:12px;" />
            <a style="position:absolute;right:15px;top:12px;font-weight:bold; text-shadow:2px 3px 12px #8d8d8d" data-bind="postCommentLink" >POST</a>
        </div>
    </div>
</script>

<script type="text/html" data-execute="aviewer.userGeneratedBookCommentTemplate=$(this).html()">
    <div class="media listItemTemplate userGeneratedBookItem userGeneratedBookCommentTemplate">
        <div class="imgWrapper imgWrapperUser">
            <img class="d-flex mr-3" height="48" src="{{aviewer.serverUrl+'/assets/user_'+item.usid}}" alt="image">            
        </div>
        <div class="media-body">
            <h3 class="mt-0">{{window.trim_string(item.username,20)}} </h3>
            <h4>{{item.data_text}}</h4>
            <h5>{{Date.fromatFromTime(item.data_time,"ddd mmm dd yyyy HH:MM:ss")}}</h5>
        </div>
    </div>


</script>
<script>
    aviewer = _phonegap;
    //aviewer.serverUrl = "http://aniparti.lianxi.cn";
  // aviewer.serverUrl = "http://pixi.aniparti.pk";

  // aviewer.serverUrl = "http://" + window.domainName;
aviewer.serverUrl = "http://mad.aniparti.com";


    window.WebGLImageFilter = function () { var r = null, t = 0, e = null, o = !1, i = -1, a = [null, null], n = [], u = -1, c = -1, v = null, l = null, x = document.createElement("canvas"); if (!(r = x.getContext("webgl") || x.getContext("experimental-webgl"))) throw "Couldn't get WebGL context"; this.addFilter = function (r) { var t = Array.prototype.slice.call(arguments, 1), e = R[r]; n.push({ func: e, args: t }) }, this.reset = function () { n = [] }, this.apply = function (i) { if (E(i.width, i.height), t = 0, e = r.createTexture(), r.bindTexture(r.TEXTURE_2D, e), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_WRAP_S, r.CLAMP_TO_EDGE), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_WRAP_T, r.CLAMP_TO_EDGE), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_MIN_FILTER, r.NEAREST), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_MAG_FILTER, r.NEAREST), r.texImage2D(r.TEXTURE_2D, 0, r.RGBA, r.RGBA, r.UNSIGNED_BYTE, i), 0 == n.length) return T(p.FRAGMENT_IDENTITY), g(), x; for (var a = 0; a < n.length; a++) { o = a == n.length - 1; var u = n[a]; u.func.apply(this, u.args || []) } return x }; var E = function (t, e) { if (t != u || e != c) { if (x.width = u = t, x.height = c = e, !v) { var o = new Float32Array([-1, -1, 0, 1, 1, -1, 1, 1, -1, 1, 0, 0, -1, 1, 0, 0, 1, -1, 1, 1, 1, 1, 1, 0]); v = r.createBuffer(), r.bindBuffer(r.ARRAY_BUFFER, v), r.bufferData(r.ARRAY_BUFFER, o, r.STATIC_DRAW), r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL, !0) } r.viewport(0, 0, u, c), a = [null, null] } }, m = function (r) { return a[r] = a[r] || f(u, c), a[r] }, f = function (t, e) { var o = r.createFramebuffer(); r.bindFramebuffer(r.FRAMEBUFFER, o); var i = r.createRenderbuffer(); r.bindRenderbuffer(r.RENDERBUFFER, i); var a = r.createTexture(); return r.bindTexture(r.TEXTURE_2D, a), r.texImage2D(r.TEXTURE_2D, 0, r.RGBA, t, e, 0, r.RGBA, r.UNSIGNED_BYTE, null), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_MAG_FILTER, r.LINEAR), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_MIN_FILTER, r.LINEAR), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_WRAP_S, r.CLAMP_TO_EDGE), r.texParameteri(r.TEXTURE_2D, r.TEXTURE_WRAP_T, r.CLAMP_TO_EDGE), r.framebufferTexture2D(r.FRAMEBUFFER, r.COLOR_ATTACHMENT0, r.TEXTURE_2D, a, 0), r.bindTexture(r.TEXTURE_2D, null), r.bindFramebuffer(r.FRAMEBUFFER, null), { fbo: o, texture: a } }, g = function (a) { var n = null, u = null, c = !1; n = 0 == t ? e : m(i).texture, t++, !o || a & _.INTERMEDIATE ? u = m(i = (i + 1) % 2).fbo : (u = null, c = t % 2 == 0), r.bindTexture(r.TEXTURE_2D, n), r.bindFramebuffer(r.FRAMEBUFFER, u), r.uniform1f(l.uniform.flipY, c ? -1 : 1), r.drawArrays(r.TRIANGLES, 0, 6) }, T = function (t) { if (t.__program) return l = t.__program, r.useProgram(l.id), l; l = new function (r, t, e) { var o = function (r, t, e) { var o = new RegExp("\\b" + t + " \\w+ (\\w+)", "ig"); r.replace(o, function (r, t) { return e[t] = 0, r }) }, i = function (r, t, e) { var o = r.createShader(e); return r.shaderSource(o, t), r.compileShader(o), r.getShaderParameter(o, r.COMPILE_STATUS) ? o : (console.log(r.getShaderInfoLog(o)), null) }; this.uniform = {}, this.attribute = {}; var a = i(r, t, r.VERTEX_SHADER), n = i(r, e, r.FRAGMENT_SHADER); this.id = r.createProgram(), r.attachShader(this.id, a), r.attachShader(this.id, n), r.linkProgram(this.id), r.getProgramParameter(this.id, r.LINK_STATUS) || console.log(r.getProgramInfoLog(this.id)), r.useProgram(this.id), o(t, "attribute", this.attribute); for (var u in this.attribute) this.attribute[u] = r.getAttribLocation(this.id, u); o(t, "uniform", this.uniform), o(e, "uniform", this.uniform); for (var c in this.uniform) this.uniform[c] = r.getUniformLocation(this.id, c) }(r, p.VERTEX_IDENTITY, t); var e = Float32Array.BYTES_PER_ELEMENT, o = 4 * e; return r.enableVertexAttribArray(l.attribute.pos), r.vertexAttribPointer(l.attribute.pos, 2, r.FLOAT, !1, o, 0 * e), r.enableVertexAttribArray(l.attribute.uv), r.vertexAttribPointer(l.attribute.uv, 2, r.FLOAT, !1, o, 2 * e), t.__program = l, l }, _ = { INTERMEDIATE: 1 }, p = {}; p.VERTEX_IDENTITY = ["precision highp float;", "attribute vec2 pos;", "attribute vec2 uv;", "varying vec2 vUv;", "uniform float flipY;", "void main(void) {", "vUv = uv;", "gl_Position = vec4(pos.x, pos.y*flipY, 0.0, 1.);", "}"].join("\n"), p.FRAGMENT_IDENTITY = ["precision highp float;", "varying vec2 vUv;", "uniform sampler2D texture;", "void main(void) {", "gl_FragColor = texture2D(texture, vUv);", "}"].join("\n"); var R = { colorMatrix: function (t) { var e = new Float32Array(t); e[4] /= 255, e[9] /= 255, e[14] /= 255, e[19] /= 255; var o = 1 == e[18] && 0 == e[3] && 0 == e[8] && 0 == e[13] && 0 == e[15] && 0 == e[16] && 0 == e[17] && 0 == e[19] ? R.colorMatrix.SHADER.WITHOUT_ALPHA : R.colorMatrix.SHADER.WITH_ALPHA, i = T(o); r.uniform1fv(i.uniform.m, e), g() } }; R.colorMatrix.SHADER = {}, R.colorMatrix.SHADER.WITH_ALPHA = ["precision highp float;", "varying vec2 vUv;", "uniform sampler2D texture;", "uniform float m[20];", "void main(void) {", "vec4 c = texture2D(texture, vUv);", "gl_FragColor.r = m[0] * c.r + m[1] * c.g + m[2] * c.b + m[3] * c.a + m[4];", "gl_FragColor.g = m[5] * c.r + m[6] * c.g + m[7] * c.b + m[8] * c.a + m[9];", "gl_FragColor.b = m[10] * c.r + m[11] * c.g + m[12] * c.b + m[13] * c.a + m[14];", "gl_FragColor.a = m[15] * c.r + m[16] * c.g + m[17] * c.b + m[18] * c.a + m[19];", "}"].join("\n"), R.colorMatrix.SHADER.WITHOUT_ALPHA = ["precision highp float;", "varying vec2 vUv;", "uniform sampler2D texture;", "uniform float m[20];", "void main(void) {", "vec4 c = texture2D(texture, vUv);", "gl_FragColor.r = m[0] * c.r + m[1] * c.g + m[2] * c.b + m[4];", "gl_FragColor.g = m[5] * c.r + m[6] * c.g + m[7] * c.b + m[9];", "gl_FragColor.b = m[10] * c.r + m[11] * c.g + m[12] * c.b + m[14];", "gl_FragColor.a = c.a;", "}"].join("\n"), R.brightness = function (r) { var t = (r || 0) + 1; R.colorMatrix([t, 0, 0, 0, 0, 0, t, 0, 0, 0, 0, 0, t, 0, 0, 0, 0, 0, 1, 0]) }, R.saturation = function (r) { var t = 2 * (r || 0) / 3 + 1, e = -.5 * (t - 1); R.colorMatrix([t, e, e, 0, 0, e, t, e, 0, 0, e, e, t, 0, 0, 0, 0, 0, 1, 0]) }, R.desaturate = function () { R.saturation(-1) }, R.contrast = function (r) { var t = (r || 0) + 1, e = -128 * (t - 1); R.colorMatrix([t, 0, 0, 0, e, 0, t, 0, 0, e, 0, 0, t, 0, e, 0, 0, 0, 1, 0]) }, R.negative = function () { R.contrast(-2) }, R.hue = function (r) { r = (r || 0) / 180 * Math.PI; var t = Math.cos(r), e = Math.sin(r), o = .213, i = .715, a = .072; R.colorMatrix([o + .787 * t + e * -o, i + t * -i + e * -i, a + t * -a + .928 * e, 0, 0, o + t * -o + .143 * e, i + t * (1 - i) + .14 * e, a + t * -a + -.283 * e, 0, 0, o + t * -o + -.787 * e, i + t * -i + e * i, a + .928 * t + e * a, 0, 0, 0, 0, 0, 1, 0]) }, R.desaturateLuminance = function () { R.colorMatrix([.2764723, .929708, .0938197, 0, -37.1, .2764723, .929708, .0938197, 0, -37.1, .2764723, .929708, .0938197, 0, -37.1, 0, 0, 0, 1, 0]) }, R.sepia = function () { R.colorMatrix([.393, .7689999, .18899999, 0, 0, .349, .6859999, .16799999, 0, 0, .272, .5339999, .13099999, 0, 0, 0, 0, 0, 1, 0]) }, R.brownie = function () { R.colorMatrix([.5997023498159715, .34553243048391263, -.2708298674538042, 0, 47.43192855600873, -.037703249837783157, .8609577587992641, .15059552388459913, 0, -36.96841498319127, .24113635128153335, -.07441037908422492, .44972182064877153, 0, -7.562075277591283, 0, 0, 0, 1, 0]) }, R.vintagePinhole = function () { R.colorMatrix([.6279345635605994, .3202183420819367, -.03965408211312453, 0, 9.651285835294123, .02578397704808868, .6441188644374771, .03259127616149294, 0, 7.462829176470591, .0466055556782719, -.0851232987247891, .5241648018700465, 0, 5.159190588235296, 0, 0, 0, 1, 0]) }, R.kodachrome = function () { R.colorMatrix([1.1285582396593525, -.3967382283601348, -.03992559172921793, 0, 63.72958762196502, -.16404339962244616, 1.0835251566291304, -.05498805115633132, 0, 24.732407896706203, -.16786010706155763, -.5603416277695248, 1.6014850761964943, 0, 35.62982807460946, 0, 0, 0, 1, 0]) }, R.technicolor = function () { R.colorMatrix([1.9125277891456083, -.8545344976951645, -.09155508482755585, 0, 11.793603434377337, -.3087833385928097, 1.7658908555458428, -.10601743074722245, 0, -70.35205161461398, -.231103377548616, -.7501899197440212, 1.847597816108189, 0, 30.950940869491138, 0, 0, 0, 1, 0]) }, R.polaroid = function () { R.colorMatrix([1.438, -.062, -.062, 0, 0, -.122, 1.378, -.122, 0, 0, -.016, -.016, 1.483, 0, 0, 0, 0, 0, 1, 0]) }, R.shiftToBGR = function () { R.colorMatrix([0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0]) }, R.convolution = function (t) { var e = new Float32Array(t), o = 1 / u, i = 1 / c, a = T(R.convolution.SHADER); r.uniform1fv(a.uniform.m, e), r.uniform2f(a.uniform.px, o, i), g() }, R.convolution.SHADER = ["precision highp float;", "varying vec2 vUv;", "uniform sampler2D texture;", "uniform vec2 px;", "uniform float m[9];", "void main(void) {", "vec4 c11 = texture2D(texture, vUv - px);", "vec4 c12 = texture2D(texture, vec2(vUv.x, vUv.y - px.y));", "vec4 c13 = texture2D(texture, vec2(vUv.x + px.x, vUv.y - px.y));", "vec4 c21 = texture2D(texture, vec2(vUv.x - px.x, vUv.y) );", "vec4 c22 = texture2D(texture, vUv);", "vec4 c23 = texture2D(texture, vec2(vUv.x + px.x, vUv.y) );", "vec4 c31 = texture2D(texture, vec2(vUv.x - px.x, vUv.y + px.y) );", "vec4 c32 = texture2D(texture, vec2(vUv.x, vUv.y + px.y) );", "vec4 c33 = texture2D(texture, vUv + px );", "gl_FragColor = ", "c11 * m[0] + c12 * m[1] + c22 * m[2] +", "c21 * m[3] + c22 * m[4] + c23 * m[5] +", "c31 * m[6] + c32 * m[7] + c33 * m[8];", "gl_FragColor.a = c22.a;", "}"].join("\n"), R.detectEdges = function () { R.convolution.call(this, [0, 1, 0, -3, 1, 0, 1, 0]) }, R.sobelX = function () { R.convolution.call(this, [-1, 0, 1, -2, 0, 2, -1, 0, 1]) }, R.sobelY = function () { R.convolution.call(this, [-1, -2, -1, 0, 0, 0, 1, 2, 1]) }, R.sharpen = function (r) { var t = r || 1; R.convolution.call(this, [0, -1 * t, 0, -1 * t, 1 + 4 * t, -1 * t, 0, -1 * t, 0]) }, R.emboss = function (r) { var t = r || 1; R.convolution.call(this, [-2 * t, -1 * t, 0, -1 * t, 1, 1 * t, 0, 1 * t, 2 * t]) }, R.blur = function (t) { var e = t / 7 / u, o = t / 7 / c, i = T(R.blur.SHADER); r.uniform2f(i.uniform.px, 0, o), g(_.INTERMEDIATE), r.uniform2f(i.uniform.px, e, 0), g() }, R.blur.SHADER = ["precision highp float;", "varying vec2 vUv;", "uniform sampler2D texture;", "uniform vec2 px;", "void main(void) {", "gl_FragColor = vec4(0.0);", "gl_FragColor += texture2D(texture, vUv + vec2(-7.0*px.x, -7.0*px.y))*0.0044299121055113265;", "gl_FragColor += texture2D(texture, vUv + vec2(-6.0*px.x, -6.0*px.y))*0.00895781211794;", "gl_FragColor += texture2D(texture, vUv + vec2(-5.0*px.x, -5.0*px.y))*0.0215963866053;", "gl_FragColor += texture2D(texture, vUv + vec2(-4.0*px.x, -4.0*px.y))*0.0443683338718;", "gl_FragColor += texture2D(texture, vUv + vec2(-3.0*px.x, -3.0*px.y))*0.0776744219933;", "gl_FragColor += texture2D(texture, vUv + vec2(-2.0*px.x, -2.0*px.y))*0.115876621105;", "gl_FragColor += texture2D(texture, vUv + vec2(-1.0*px.x, -1.0*px.y))*0.147308056121;", "gl_FragColor += texture2D(texture, vUv                             )*0.159576912161;", "gl_FragColor += texture2D(texture, vUv + vec2( 1.0*px.x,  1.0*px.y))*0.147308056121;", "gl_FragColor += texture2D(texture, vUv + vec2( 2.0*px.x,  2.0*px.y))*0.115876621105;", "gl_FragColor += texture2D(texture, vUv + vec2( 3.0*px.x,  3.0*px.y))*0.0776744219933;", "gl_FragColor += texture2D(texture, vUv + vec2( 4.0*px.x,  4.0*px.y))*0.0443683338718;", "gl_FragColor += texture2D(texture, vUv + vec2( 5.0*px.x,  5.0*px.y))*0.0215963866053;", "gl_FragColor += texture2D(texture, vUv + vec2( 6.0*px.x,  6.0*px.y))*0.00895781211794;", "gl_FragColor += texture2D(texture, vUv + vec2( 7.0*px.x,  7.0*px.y))*0.0044299121055113265;", "}"].join("\n") };

    window.anipartiBaseURL = aviewer.serverUrl;
   
    aviewer.api = function (api, data, success, failed, binary) {


        var request = {
            url: aviewer.serverUrl + '/aniparti/' + api, method: "POST", data: data, dataType: "json",
            success: function (res) {
                success(res);

            },
            error: function (err) {
                window.ui.hideProcessing();
                if (failed)failed(err.responseJSON); else console.error(err);
            },

        };
        if (binary) {
            request.contentType = false;
            request.processData = false;
            delete request.dataType;
        }
        if (aviewer.userAccessToken) {
            console.log("aviewer.userAccessToken", aviewer.userAccessToken);
            request.beforeSend = function (xhr, settings) {
                
                xhr.setRequestHeader('Authorization', 'Bearer ' + aviewer.userAccessToken);
            }
        }


        $.ajax(request);

    };
   

    aviewer.uploadFile = function (file, done, qry) {
        var fd = new FormData();
        fd.append("file", file);
        aviewer.api('upload_file_av' + (qry ? '?' + qry : ''), fd, function (res) {
            if (done) done(res.url);
        }, false, true);

    };

  

    aviewer.viewerArea = $("#viewerArea");
    //aviewer.viewerArea.hide();

   
    $(".sidebarButton").parent().remove();
    $(".list-title").css("font-size", "14px");

    window.convertoFloat32ToInt16 = function (buffer) {
        var l = buffer.length;  //Buffer
        var buf = new Int16Array(l / 1);
        while (l--) {
            s = Math.max(-1, Math.min(1, buffer[l]));
            buf[l] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }


        return buf;
    };

    aviewer.dubbedSounds = {};
    aviewer.dubbedImages = {};
    aviewer.dubbedObjects = {};
    window.anipartiViewerOverride = window.anipartiViewerOverride || [];
    aviewer.userDubbedSounds = {};
    aviewer.userDubbedSoundsApplied = {};
    Math.dist = function (x1, y1, x2, y2) { return Math.abs(Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1))); };

    window.anipartiViewerOverride.push(function (viewer) {
        console.log("viewer", viewer);
        viewer.PIXI = viewer.getPIXI();

      
        viewer.isUGCVersion = aviewer.isUGCVersion;

        viewer.actions["SaveAndShareUGC"] = function (slide, action) {
            aviewer.app.saveAndShareUGC(true);
        };

        viewer.actions["SoundDubbing"] = function (slide, action) {

            console.log("action.soundMappingName", action.soundMappingName);
            if (action.soundMappingName == "") return;

            var mp = slide.mappingNames[action.soundMappingName];
            
            if (mp && mp.soundBuffer) {
                var destAudio = viewer.soundManager.buffers[mp.soundBuffer];
                aviewer.dubAudio(function (data) {

                    var numChannels = audioinput._cfg.channels;
                    var audioBuffer = viewer.soundManager.context.createBuffer(numChannels, (data.length / numChannels), audioinput._cfg.sampleRate);

                    var i, index = 0, channel;
                    for (i = 0; i < numChannels; i++) {
                        channels = audioBuffer.getChannelData(i);
                        while (index < data.length) {
                            channels[index] = data[index + i];
                            index += numChannels;
                        }
                    }
                    destAudio.ab = audioBuffer;
                    aviewer.dubbedSounds[mp.soundBuffer] = { buff: audioBuffer, data: data };
                    ui.modals.info("Dubbing Audio", "<h4 style='color:black'>Audio has been updated</h4>");
                    console.log("audioBuffer", audioBuffer);


                });


            }




        };

        viewer.actions["OpenProjectById"] = function (slide, action) {
            window.ui.showProcessing();
            aviewer.api("get_repo_public", { id: window.parseItemTags(action.projectId, function (k) { return (eval(k));}) }, function (res) {
                window.ui.hideProcessing();
                window.loadContent(res.data.content);
            });
        };

        viewer.actions["QRCodeActions"] = function (slide, action) {
            console.log(action);
            cordova.plugins.barcodeScanner.scan(
               function (result) {

                   if (!result.cancelled) {
                       viewer.QRCodeText = result.text;
                       
                       action.ActionsList.forEach(function (item) {
                           slide.executeAction(item.action);
                       });
                   }
                

               },
               function (error) {
                   alert("Scanning failed: " + error);
               },
               {
                   preferFrontCamera: false, // iOS and Android
                   showFlipCameraButton: true, // iOS and Android
                   showTorchButton: true, // iOS and Android
                   torchOn: false, // Android, launch with the torch switched on (if available)
                   saveHistory: true, // Android, save scan history (default false)
                   prompt: "Place a barcode inside the scan area", // Android
                   resultDisplayDuration: 500, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
                   formats: "QR_CODE,PDF_417", // default: all but PDF_417 and RSS_EXPANDED
                   orientation: "portrait", // Android only (portrait|landscape), default unset so it rotates with the device
                   disableAnimations: true, // iOS
                   disableSuccessBeep: false // iOS and Android
               }
            );

        };

    
        viewer.events("SlideLoading", function (slide) {
            if (!aviewer.userDubbedImages) aviewer.userDubbedImages = {};
            slide.layers.forEach(function (layer) {
                layer.objects.forEach(function (obj) {
                    if (aviewer.userDubbedImages[slide.uuid + "." + obj.uuid]) {
                        var mm = aviewer.userDubbedImages[slide.uuid + "." + obj.uuid];
                       
                        if (mm.action == "ModifyMaskingImage") {
                            obj.component.backImage = mm.uploaded;
                            slide.preloading.push({ imageUrl: obj.component.backImage });
                        }
                        else {
                            obj.imageUrl = mm.uploaded;
                            slide.preloading.push({ imageUrl: obj.imageUrl });
                        }
                      
                        
                        if (mm.emojs) {
                            mm.emojs.forEach(function (emoj) {
                               // emoj.image = emoj.image.replace(viewer.resourceUrl, "");
                                slide.preloading.push({ imageUrl: emoj.image });
                            });
                        }
                    }
                });
            });
            slide.preloading.forEach(function (item) {
                if (item.soundBuffer) {
                    if (aviewer.userDubbedSounds[item.soundBuffer]) {
                        aviewer.userDubbedSoundsApplied[aviewer.userDubbedSounds[item.soundBuffer]] = item.soundBuffer;
                        item.soundBuffer = aviewer.userDubbedSounds[item.soundBuffer];
                    }
                }

            });
        });

        viewer.events("SlideLoaded", function (slide) {
            var PIXI = viewer.getPIXI();
            
           
            if (slide.uuid == "MainSlide") {

                
            } else {
                for (var s in aviewer.userDubbedSoundsApplied) {
                    viewer.soundManager.buffers[aviewer.userDubbedSoundsApplied[s]] = viewer.soundManager.buffers[s];
                }

                slide.layers.forEach(function (layer) {
                    layer.objects.forEach(function (obj) {
                        if (aviewer.userDubbedImages[slide.uuid + "." + obj.uuid]) {
                            var mm = aviewer.userDubbedImages[slide.uuid + "." + obj.uuid];
                            console.log("dubb mm", mm);
                            console.log("dubb image", obj);
                            var emojs = mm.emojs;
                            if (emojs) {
                                emojs.forEach(function (emoj) {
                                    if (!viewer.emojs[emoj.image]) {
                                        var tex = viewer.getTexture(emoj.image); // PIXI.Texture.fromImage(emoj.image);
                                        // tex.baseTexture.width = emoj.width;
                                        // tex.baseTexture.height = emoj.height;
                                        viewer.emojs[emoj.image] = new viewer.spriteSheet(tex, { rows: 1, cols: emoj.width / emoj.height }, slide);

                                    }
                                    var s = viewer.emojs[emoj.image].createInstance();
                                    s.slide = slide;
                                    s.x = emoj.x;
                                    s.y = emoj.y;
                                    s.scale.x = emoj.sx; s.scale.y = emoj.sy;
                                    s.startSprite(emoj.speed * (emoj.width / emoj.height));
                                    obj.pixi.addChild(s);
                                });
                            }

                            if (mm.action == "ModifyMaskingImage") {
                            

                                obj.pixi.backImage.scale.x = parseFloat(mm.scaleX);
                                obj.pixi.backImage.scale.y = parseFloat(mm.scaleY);
                                obj.pixi.backImage.rotation = parseFloat(mm.rotation);

                                obj.pixi.backImage.anchor.x = parseFloat(mm.anchorX);
                                obj.pixi.backImage.anchor.y = parseFloat(mm.anchorY);

                                console.log("ModifyMaskingImage");
                            }

                        }
                    });
                });

            }


        });
        window.sideBarButton = $(".sidebarButton");
        viewer.events("RenderEventTime", function () {
            window.sideBarButton.show();
        });
       
        viewer.emojs = {};
       
        viewer.actions["MoveToNextSlide"] = function (slide, action) {
            slide.readyToMoveNextSlide = true;
            console.log("MoveToNextSlide");
        };

      

        viewer.actions["ModifyMaskingImage"] = function (slide, action) {

            aviewer.maskingImageAction = action;
            aviewer.maskingImageSlide = slide;
            var startMaskingImageEditor = function (userimage) {
                var pixi = slide.objects[action.imageName];
                aviewer.maskingImageSlide.pause();
                $(".navigationBar").hide();
                var PIXI = viewer.getPIXI();
         

                var mw = viewer.width(), mh = viewer.height();
                var mw2 = mw / 2;
                var mh2 = mh / 2;

                var canv = aviewer.app.dubImagCanv;


               var sw = pixi.maskingImage.texture.baseTexture.width;
               var sh = pixi.maskingImage.texture.baseTexture.height;

                canv.setSize(sw, sh * 2);


                canv.ctx.fillStyle = "transparent";
                canv.ctx.fillRect(0, 0, sw, sh*2);

                canv.ctx.drawImage(pixi.maskingImage.texture.baseTexture.source, (canv.width / 2) - (sw / 2), (canv.height / 2) - (sh / 2));



                var imageData = canv.ctx.getImageData(0, 0, canv.width, canv.height);
                var data = imageData.data;
                for (var p = 0, len = data.length; p < len; p += 4) {
                    data[p + 0] = 1; data[p + 1] = 1; data[p + 2] = 1;
                    if (data[p + 3] == 0) {
                        data[p + 3] = 200;
                    }
                    else if (data[p + 3] == 255) {
                        data[p + 3] = 0;
                    }
                   

                }
                canv.ctx.putImageData(imageData, 0, 0);


                var scale = mw / sw

                window.ui.hideProcessing();

               
                var pixiContainer = viewer.maskingImageContainer;
                if (!pixiContainer) {
                    pixiContainer = new PIXI.Container();
                    viewer.pixiStage.addChild(pixiContainer);

                    var backDrop = new PIXI.Sprite(PIXI.Texture.WHITE);
                    pixiContainer.addChild(backDrop);
                    backDrop.anchor.set(0.5);
                    backDrop.scale.set(100);

                    pixiContainer.maskingImage = new PIXI.Sprite(PIXI.Texture.WHITE);
                    pixiContainer.maskingImage.anchor.set(0.5);

                    pixiContainer.backImage = new PIXI.Sprite(PIXI.Texture.WHITE);

                    pixiContainer.frontImage = new PIXI.Sprite(PIXI.Texture.WHITE);
                    pixiContainer.addChild(pixiContainer.backImage);
                    pixiContainer.addChild(pixiContainer.maskingImage);
                    pixiContainer.addChild(pixiContainer.frontImage);

                    pixiContainer.backImage.interactive = true;
                    pixiContainer.backImage.on('pointerdown', function (event) {
                        this.lx = event.data.global.x;
                        this.ly = event.data.global.y;
                        this.dragging = true;
                    });

                    pixiContainer.backImage.on('pointerup', function (event) {
                        this.dragging = false;
                    });

                    pixiContainer.backImage.on('pointermove', function (event) {
                        if (this.dragging) {

                            var dx = ((event.data.global.x - this.lx) );
                            var dy = ((event.data.global.y - this.ly) );

                            var cos = Math.cos(this.rotation);
                            var sin = Math.sin(this.rotation);

                            var dxx = ((cos * dx) + (sin * dy));
                            var dyy = ((cos * dy) - (sin * dx));

                            this.ax += dxx;
                            this.ay += dyy;



                            this.anchor.x = 0.5 - (this.ax / this.texture.baseTexture.width);
                            this.anchor.y = 0.5 - (this.ay / this.texture.baseTexture.height);



                            this.lx = event.data.global.x;
                            this.ly = event.data.global.y;
                        }
                        event.stopPropagation();
                    });

                    viewer.maskingImageContainer = pixiContainer;
                }

                pixiContainer.maskingImage.texture = PIXI.Texture.fromImage(canv.toDataURL("image/png"));
                if (pixi.frontImage) {
                    pixiContainer.frontImage.visible = true;
                    pixiContainer.frontImage.texture = pixi.frontImage.texture;
                    pixiContainer.frontImage.anchor.set(0.5);
                    pixiContainer.frontImage.scale.x = pixi.frontImage.scale.x;
                    pixiContainer.frontImage.scale.y = pixi.frontImage.scale.y;
                    pixiContainer.frontImage.x = pixi.frontImage.x;
                    pixiContainer.frontImage.y = pixi.frontImage.y;
                    pixiContainer.frontImage.rotation = pixi.frontImage.rotation;
                }
                else {
                    pixiContainer.frontImage.visible = false;
                }

                var imageWidth = userimage.width;
                var imageHeight = userimage.height;
                var imageSize = sw * 3;
                if (userimage.width > imageSize) {
                    imageHeight *= imageSize / imageWidth;
                    imageWidth = imageSize;
                }

                canv.setSize(imageWidth, imageHeight);
                canv.ctx.drawImage(userimage, 0, 0, userimage.width, userimage.height, 0, 0, imageWidth, imageHeight);
                

                pixiContainer.backImage.texture = PIXI.Texture.fromImage(canv.toDataURL("image/png"));

                pixiContainer.backImage.scale.x = 1;
                pixiContainer.backImage.scale.y = 1;
                pixiContainer.backImage.rotation = 0;

                pixiContainer.backImage.anchor.set(0.5);
                pixiContainer.backImage.ax = 0;
                pixiContainer.backImage.ay = 0;            
                

                pixiContainer.scale.x = scale;
                pixiContainer.scale.y = scale;
                pixiContainer.x = mw2;
                pixiContainer.y = mh2;

                pixiContainer.visible = true;

                aviewer.maskingImageContainer = pixiContainer;
                aviewer.maskingImagePIXI = pixi;
                if (!aviewer.maskingImageManipulator) {

                    aviewer.maskingImageManipulator = $(aviewer.maskingImageManipulatorUI);
                    aviewer.maskingImageManipulator.css("width", mw + "px").css("height", mh + "px");

                    aviewer.maskingImageManipulatorTitle = aviewer.maskingImageManipulator.find(".maskingImageManipulatorTitle");
                  

                    aviewer.maskingImageRotator = aviewer.maskingImageManipulator.find(".maskingImageRotator");

                    aviewer.maskingImageRotator.on("input", function () {
                        aviewer.maskingImageContainer.backImage.rotation = (parseFloat(this.value)) * DEG_TO_RAD_HELP;
                    });

                    aviewer.maskingImageScaler = aviewer.maskingImageManipulator.find(".maskingImageScaler");
                    aviewer.maskingImageManipulator.find(".maskingImageScalerPOS").css("margin-top", (mw / 2) + "px");
                    aviewer.maskingImageManipulator.find(".maskingImageScalerPOS.fa-plus").css("margin-top", -(mw / 2) + "px");
                    
                    aviewer.maskingImageScaler.on("input", function () {
                        var s = 1 * ((parseInt(this.value)) / 50);
                        aviewer.maskingImageContainer.backImage.scale.x = s;
                        aviewer.maskingImageContainer.backImage.scale.y = s;
                    });

                    aviewer.maskingImageConfirmButton = aviewer.maskingImageManipulator.find(".maskingImageConfirmButton");
                    aviewer.maskingImageConfirmButton.on("touchend click", function (e) {
                        e.stopPropagation(); e.preventDefault();
                        var key = aviewer.maskingImageSlide.uuid + "." + aviewer.maskingImageAction.imageName;
                        var item = {
                            key: key, slide: aviewer.maskingImageSlide.uuid, imageName: aviewer.maskingImageAction.imageName, action: aviewer.maskingImageAction.actionName,
                            dataUrl: aviewer.maskingImageContainer.backImage.texture.baseTexture.source.src,
                            scaleX: aviewer.maskingImageContainer.backImage.scale.x.toFixed(3),
                            scaleY: aviewer.maskingImageContainer.backImage.scale.y.toFixed(3),
                            rotation: aviewer.maskingImageContainer.backImage.rotation.toFixed(4),
                            anchorX: aviewer.maskingImageContainer.backImage.anchor.x.toFixed(3),
                            anchorY: aviewer.maskingImageContainer.backImage.anchor.y.toFixed(3)
                        };
                        aviewer.dubbedImages[key] = item;
                        console.log("aviewer.dubbedImages", aviewer.dubbedImages);
                        aviewer.maskingImagePIXI.backImage.texture = PIXI.Texture.fromImage(item.dataUrl);
                        aviewer.maskingImagePIXI.backImage.anchor.x =parseFloat(item.anchorX);
                        aviewer.maskingImagePIXI.backImage.anchor.y = parseFloat(item.anchorY);
                        aviewer.maskingImagePIXI.backImage.scale.x = parseFloat(item.scaleX);
                        aviewer.maskingImagePIXI.backImage.scale.y = parseFloat(item.scaleX);
                        aviewer.maskingImagePIXI.backImage.rotation = parseFloat(item.rotation);

                        aviewer.maskingImageContainer.visible = false;
                        aviewer.maskingImageSlide.resume();
                        $(".navigationBar").show();
                        aviewer.maskingImageManipulator.hide();
                        

                    });
                    

                    aviewer.maskingImageCancelButton = aviewer.maskingImageManipulator.find(".maskingImageCancelButton");
                    aviewer.maskingImageManipulator.append(aviewer.maskingImageCancelButton);
                    aviewer.maskingImageCancelButton.on("click", function (e) {
                        e.stopPropagation(); e.preventDefault();
                        aviewer.maskingImageContainer.visible = false;
                        aviewer.maskingImageSlide.resume();
                        $(".navigationBar").show();
                        aviewer.maskingImageManipulator.hide();

                    });
                }
                window.layoutContainer.append(aviewer.maskingImageManipulator);
                aviewer.maskingImageManipulator.show();
                aviewer.maskingImageRotator.val(0);
                aviewer.maskingImageScaler.val(50);
                aviewer.maskingImageManipulatorTitle.html(aviewer.maskingImageAction.editingTitle);

                //action.editingTitle

            };

          
      
            slide.pause();
            window.ui.modals.question("Upload Image", '').ready = function () {
                var md = this;
                md.$.css("min-width", "330px").css("width", "330px");
                md.$.find('.ui-ui-modal-ok-button').addClass('btn-success').html("Upload Image").fileUploadButtonEx({
                    accept: "image/*", onFileData: function (data) {
                        window.ui.showProcessing();
                        md.forceClose();
                        window.checkImageSource(data, function () {
                            var img = this;
                            $(".navigationBar").hide();
                            var div = $(aviewer.maskingImageFiltersUI);
                            window.layoutContainer.append(div);
                            
                            var canv = window.createCanvasObject(10, 10);
                            var imageWidth = this.width;
                            var imageHeight = this.height;
                            var imageSize = 1280;
                            if (this.width > imageSize) {
                                imageHeight *= imageSize / imageWidth;
                                imageWidth = imageSize;
                            }

                            canv.setSize(imageWidth, imageHeight);
                            canv.ctx.drawImage(this, 0, 0, this.width, this.height, 0, 0, imageWidth, imageHeight);
                            div.prepend(canv);
                            $(canv).css("position", "absolute").css("left", "20px").css("top", "30px")
                                .css("transform-origin","left top")
                                .css("transform", "scale(" + (((window.windowWidth-40) / imageWidth)) + ")");

                            window.ui.hideProcessing();
                            var completedImage = img;
                            img.onload = function () {

                                var filtersPresets = [
                                       { name: 'none', title: 'None' },
                                       { name: 'negative', title: 'Negative' },
                                       { name: 'brightness', args: [1.5], title: 'Brightness' },
                                       { name: 'saturation', args: [1.5], title: 'Saturation' },
                                       { name: 'contrast', args: [1.5], title: 'Contrast' },
                                       { name: 'hue', args: [180], title: 'Hue' },
                                       { name: 'desaturate', title: 'Desaturate' },
                                       { name: 'desaturateLuminance', title: 'Desaturate Luminance' },
                                       { name: 'brownie', title: 'Brownie' },
                                       { name: 'sepia', title: 'Sepia' },
                                       { name: 'vintagePinhole', title: 'Vintage Pinhole' },
                                       { name: 'kodachrome', title: 'Kodachrome' },
                                       { name: 'technicolor', title: 'Technicolor' },
                                       { name: 'detectEdges', title: 'Detect Edges' },
                                       { name: 'sharpen', title: 'Sharpen' },
                                       { name: 'emboss', title: 'Emboss' },
                                       { name: 'blur', args: [7], title: 'Blur' }];

                                var filterObject = new window.WebGLImageFilter();

                                var applyFilter = function (f) {
                                    if (f.name == 'none') return;
                                    filterObject.addFilter(f.name, f.args);
                                };
                                var filtersTab = div.find(".filtersTab");

                                filtersTab.find(".nav-tabs").find("a").click(function (e) {
                                    filtersTab.find(".nav-tabs").find("li.active").removeClass("active");
                                    $(this.parentNode).addClass("active");
                                    var tab = this.getAttribute("href").replace("#", "");
                                    filtersTab.find(".tab-pane").hide();
                                    filtersTab.find(".tab-pane." + tab).show();
                                    e.stopPropagation(); e.preventDefault();

                                });

                                filtersTab.filterIndex = [filtersPresets[0], filtersPresets[0], filtersPresets[0]];

                                filtersTab.filterButtonClick = function () {

                                    $(this.parentNode).find("button.active").removeClass("active");
                                    $(this).addClass("active");
                                    filtersTab.filterIndex[this.filterIndex] = this.filter;

                                    filterObject.reset();
                                    filtersTab.filterIndex.forEach(function (f) {
                                        applyFilter(f);
                                    });
                                    completedImage = filterObject.apply(img);
                                    canv.ctx.drawImage(completedImage, 0, 0);

                                };
                              

                                var index = 0;
                                filtersTab.find(".tab-pane").each(function () {
                                    var cont = $('<div style="height:100px"></div>');
                                    cont.css("min-width", (window.windowWidth * 4.2) + "px");
                                    for (var i = 0; i < filtersPresets.length; i++) {                                       
                                        var btn = $('<button class="btn btn-sm"></button>');
                                        btn.css("width", (window.windowWidth / 2.3) + "px");
                                        btn.html(filtersPresets[i].title);
                                        cont.append(btn);
                                        btn[0].filter = filtersPresets[i];
                                        btn[0].onclick = filtersTab.filterButtonClick;
                                        btn[0].filterIndex = index;
                                        if (btn[0].filter.name == "none") btn.addClass("active");
                                    }
                                    $(this).append(cont);
                                    index++;
                                });

                                
                            };

                           

                            img.src = canv.toDataURL("image/png");

                            
                           

                            div.find(".maskingImageConfirmButton").on("click",function (e) {
                              
                                delete canv;
                                delete img;
                                div.remove();
                                e.stopPropagation();
                                startMaskingImageEditor(completedImage);
                            });

                            div.find(".maskingImageCancelButton").on("touchend click", function (e) {
                                delete canv;
                                div.remove();
                                slide.resume();
                                e.stopPropagation();
                                $(".navigationBar").show();
                            });
                            
                            
                        });
                    }
                });

                md.closing = function (res) {
                   if(!res) slide.resume();
                    return (!res);
                };



                md.$.find('.ui-ui-modal-cancel-button').html("Cancel");


            };

        };

        viewer.actions["ModifyImage"] = function (slide, action) {
           if (action.actionCompleted) return;

            var pixi = slide.objects[action.imageName];
            slide.pause();
            console.log(pixi);

            //viewer.textures.nextPageImage = PIXI.Texture.fromImage(window.anipartiMainURL + "/global/img/nextPage.jpg");
            aviewer.modifyImage(function (url,emojs) {
                var tx = viewer.PIXI.Texture.fromImage(url);
                pixi.texture = tx;

                pixi.removeChildren();
                if (emojs) {
                    emojs.forEach(function (emoj) {
                        if (!viewer.emojs[emoj.image]) {
                            var tex = viewer.PIXI.Texture.fromImage(emoj.image);
                            tex.baseTexture.width = emoj.width;
                            tex.baseTexture.height = emoj.height;
                            viewer.emojs[emoj.image] = new viewer.spriteSheet(tex, { rows: 1, cols: emoj.width / emoj.height }, slide);
                          
                        }
                        var s = viewer.emojs[emoj.image].createInstance();
                       
                        s.slide = slide;
                        s.x = emoj.x;
                        s.y = emoj.y;
                        s.scale.x = emoj.sx; s.scale.y = emoj.sy;
                        s.startSprite(emoj.speed * (emoj.width / emoj.height));
                        pixi.addChild(s);
                    });
                }
             
                slide.resume();
                setTimeout(function (pixi) {
                    pixi.scale.x = pixi.obj.scaleX * pixi.displayScale;
                    pixi.scale.y = pixi.obj.scaleY * pixi.displayScale;
                    //viewer.resume();
                    if (action.oneTimeAction) action.actionCompleted = true;
                    var key=slide.uuid + "." + action.imageName;
                    aviewer.dubbedImages[key] = {
                        key: key, slide: slide.uuid, imageName: action.imageName, dataUrl: url, emojs: emojs
                    };





                }, 50,pixi);
             
            }, pixi._texture.baseTexture.width, pixi._texture.baseTexture.height, function () {
                slide.resume();
            }, action.editingTitle, action);
        };

        viewer.actions["ModifyDynamicText"] = function (slide, action) {
            var pixi = slide.objects[action.textName];
            slide.pause();
            var maxlength = parseInt("0" + action.maxTextLength);

            if (maxlength < 1) maxlength = 100;

            window.ui.modals.open({
                title: action.editingTitle, element: '<textarea data-bind="textBox" maxlength="'+maxlength+'" style="width:100%;margin-bottom:10px" rows="4"></textarea><h6 style="color:black" data-bind="showTextLength"></h6>',
               
            }).ready = function () {
                var md = this;
                md.setWidth("350px");
                window.bindElements(md.$, md);
                md.$.find(".ui-ui-modal-cancel-button").css("width", "130px");
                md.$.find(".ui-ui-modal-ok-button").css("width", "130px");
                md.textBox.$.val(pixi.pixiText.text);
                md.textBox.$.focus();
                

                md.showTextLength.$.html("more " + (maxlength - md.textBox.$.val().length));
                md.textBox.$.keypress(function () {
                    md.showTextLength.$.html("more " + (maxlength - md.textBox.$.val().length));

                });
                md.closing = function (res) {

                    if (res) {
                        pixi.pixiText.text = md.textBox.$.val();
                        if (window.currentTextDictionary) {
                            if (!window.currentTextDictionary.languages["ugc"]) {
                                window.currentTextDictionary.languages["ugc"] = {};
                                for (var c in window.currentTextDictionary.languages[window.selectedViewerLanguage]) {
                                    window.currentTextDictionary.languages["ugc"][c] = window.currentTextDictionary.languages[window.selectedViewerLanguage][c];

                                }
                                window.selectedViewerLanguage = "ugc";
                                window.currentTextDictionary.currentLanguage = window.currentTextDictionary.languages["ugc"];

                            }
                            window.currentTextDictionary.languages["ugc"][pixi.obj.component.textId] = pixi.pixiText.text;
                        }
                        
                        if (!aviewer.dubbedObjects["ugc_dictionary"]) aviewer.dubbedObjects["ugc_dictionary"] = { defLng: window.selectedViewerLanguage, codes: {}};
                        aviewer.dubbedObjects["ugc_dictionary"].codes[pixi.obj.component.textId] = pixi.pixiText.text;
                        console.log("aviewer.dubbedObjects", aviewer.dubbedObjects);

                    }
                    slide.resume();
                    //pixi.obj.component.textId
                    return (true);
                }
            };

        };

        viewer.actions["EditSmartText"] = function (slide, action) {
            var pixi = slide.objects[action.textName];
            pixi.pixiText = pixi.obj.pixiText;
            slide.pause();
            var maxlength = parseInt("0" + action.maxTextLength);

            if (maxlength < 1) maxlength = 100;

            window.ui.modals.open({
                title: action.editingTitle, element: '<textarea data-bind="textBox" maxlength="' + maxlength + '" style="width:100%;margin-bottom:10px" rows="4"></textarea><h6 style="color:black" data-bind="showTextLength"></h6>',

            }).ready = function () {
                var md = this;
                md.setWidth("350px");
                window.bindElements(md.$, md);
                md.$.find(".ui-ui-modal-cancel-button").css("width", "130px");
                md.$.find(".ui-ui-modal-ok-button").css("width", "130px");
                md.textBox.$.val(pixi.pixiText.text);
                md.textBox.$.focus();

                md.updateTextLengthInfo = function () {
                    md.showTextLength.$.html(md.textBox.$.val().length + "/" + maxlength);
                };
                md.updateTextLengthInfo();
                md.textBox.$.keydown(md.updateTextLengthInfo);
                md.closing = function (res) {


                    if (res) {
                        pixi.pixiText.text = md.textBox.$.val();
                        if (window.currentTextDictionary) {
                            if (!window.currentTextDictionary.languages["ugc"]) {
                                window.currentTextDictionary.languages["ugc"] = {};
                                for (var c in window.currentTextDictionary.languages[window.selectedViewerLanguage]) {
                                    window.currentTextDictionary.languages["ugc"][c] = window.currentTextDictionary.languages[window.selectedViewerLanguage][c];

                                }
                                window.selectedViewerLanguage = "ugc";
                                window.currentTextDictionary.currentLanguage = window.currentTextDictionary.languages["ugc"];

                            }
                            window.currentTextDictionary.languages["ugc"][pixi.obj.component.textId] = pixi.pixiText.text;
                        }

                        if (!aviewer.dubbedObjects["ugc_dictionary"]) aviewer.dubbedObjects["ugc_dictionary"] = { defLng: window.selectedViewerLanguage, codes: {} };
                        aviewer.dubbedObjects["ugc_dictionary"].codes[pixi.obj.component.textId] = pixi.pixiText.text;
                        console.log("aviewer.dubbedObjects", aviewer.dubbedObjects);

                        pixi.pixiText.updateTextTexture();

                    }
                    slide.resume();
                    //pixi.obj.component.textId
                    return (true);
                }
            };

        };

        viewer.improvedResourceLoader = window.improvedResourceLoader;
        viewer.loadSlideResources = function (slide, done) {
            viewer.improvedResourceLoader(slide, done); return;           

        };

        window.afterLanguageChanged = function () {
            window.currentTextDictionary.currentLanguage = window.currentTextDictionary.languages[window.selectedViewerLanguage];
            console.log("window.selectedViewerLanguage", window.selectedViewerLanguage);
            for (var i = 1; i < viewer.usedSlides.length; i++) {
                //console.log("[" + i + "]", viewer.usedSlides[i]);
                for (var o in viewer.usedSlides[i].objects) {
                    var pixi = viewer.usedSlides[i].objects[o];
                    if (pixi.obj && pixi.obj.componentId == "textSprite1.0") {
                        pixi.pixiText.text = window.currentTextDictionary.get(pixi.obj.component.textId);
                    }
                    else if (pixi.obj && pixi.obj.componentId == "smartText1.0") {
                        pixi.pixiText = pixi.obj.pixiText;
                        pixi.pixiText.text = window.currentTextDictionary.get(pixi.obj.component.textId);
                        pixi.pixiText.updateTextTexture();
                    }
                }
            }


            
        };

        if (window.currentTextDictionary1 && window.currentTextDictionary.languages) {
            window.currentTextDictionary.languages["ugc"] = {};
            for (var c in window.currentTextDictionary.currentLanguage) {
                window.currentTextDictionary.languages["ugc"][c] = window.currentTextDictionary.currentLanguage[c];
            }
        }
        if (window.currentTextDictionary) {

            delete window.currentTextDictionary.languages["ugc"];
            window.selectedViewerLanguage = window.realContent.projectSettings.viewerLanguage;
            window.currentTextDictionary.currentLanguage = window.currentTextDictionary.languages[window.selectedViewerLanguage];

        }
        if (aviewer.userDubbedObjects) {
          
            if (window.currentTextDictionary)
            {
                console.log("aviewer.userDubbedObjects", aviewer.userDubbedObjects);
                if (aviewer.userDubbedObjects["ugc_dictionary"]) {
                    
                    var uDict = aviewer.userDubbedObjects["ugc_dictionary"];
                    window.currentTextDictionary.languages["ugc"] = {};
                    for (var c in window.currentTextDictionary.languages[uDict.defLng]) {
                        window.currentTextDictionary.languages["ugc"][c] = window.currentTextDictionary.languages[uDict.defLng][c];
                    }
                    for (var c in uDict.codes) {
                        window.currentTextDictionary.languages["ugc"][c] = uDict.codes[c];
                    }

                    window.selectedViewerLanguage = "ugc";
                    setTimeout(function () { window.afterLanguageChanged(); }, 200);

                    delete aviewer.userDubbedObjects["ugc_dictionary"];
                }

                
            }

           
        }
       
        

    });

 
    aviewer.dubbAudioData = [];
    window.addEventListener("audioinput", function (evt) {
       // console.log("evt.data", evt.data);
        aviewer.dubbAudioData.push(evt.data);

    }, false);

    window.addEventListener("audioinputerror", function (error) {
        alert("onAudioInputError event recieved: " + JSON.stringify(error));
    }, false);
    aviewer.dubAudio = function (done) {
        
        if (!window.audioinput) {
            ui.modals.error("Dubbing Audio", "Not available on Web<br/>Please use App");
            return;
        }
       
        
        aviewer.dubAudioModal = ui.modals.info2("Dubbing Audio", aviewer.dubAudioUI);

        aviewer.dubAudioModal.ready = function () {
            var md = this;
            md.isRecording = false;
            md.recordingButtonClick = function () {
                md.startRecording();
                md.$.find(".badge-success").find("i").removeClass("fa-play").addClass("fa-check");
            };


            md.$.find(".badge-danger").click(function () {
                md.close(false);

            });

            md.$.find(".badge-success").click(function () {
                md.recordingButtonClick();

            });

            md.recordingTime = 0;

            md.recordingTimeDisplay = md.$.find(".recordingTimeDisplay");

            md.startRecording = function () {
                md.recordingStartTime = Date.now();
                md.recordingTimeDisplay.css("color", "black");
                ui.timer(1000, function () {
                    md.recordingTime = (Date.now() - md.recordingStartTime) / 1000;

                    // padString(parseInt((md.recordingTime / 60 / 60) % 60) + '', '00') + ":"
                    md.recordingTimeDisplay.html(

                        padString(parseInt((md.recordingTime / 60) % 60) + '', '00') + ":"
                        + padString(parseInt((md.recordingTime) % 60) + '', '00')
                        );
                    return (md.isRecording);
                });
                aviewer.dubbAudioData = [];
                audioinput.start({
                    sampleRate: audioinput.SAMPLERATE.CD_AUDIO_44100Hz,
                    bufferSize: 16384,
                    channels: audioinput.CHANNELS.MONO,
                    format: audioinput.FORMAT.PCM_16BIT,
                    normalize: true,
                    normalizationFactor: 32767.0,
                    audioSourceType: audioinput.AUDIOSOURCE_TYPE.DEFAULT
                });
                md.isRecording = true;

                md.recordingButtonClick = function () {
                    md.close(true);
                };
            };

            this.closing = function (res) {
                if (md.isRecording) {
                    audioinput.stop();
                }
                md.isRecording = false;
                if (res) {
                    var concatenatedData = [];
                    while (aviewer.dubbAudioData.length !== 0) {
                        if (aviewer.dubbAudioData.length === 0) {
                            break;
                        }
                        concatenatedData = concatenatedData.concat(aviewer.dubbAudioData.shift());
                    }
                    done(concatenatedData);

                }
                aviewer.dubAudioModal = false;
                return (true);
            };
        };



    };

    window.loadStyleSheetFile(document, window.appUrl + "/ui_libs.css?v1.00009");
    window.isOS = function () {
        return navigator.userAgent.match(/ipad|iphone/i);
    };

    window.selectText = function (txb) {
        var range,
            selection;

        if (window.isOS()) {
            range = document.createRange();
            range.selectNodeContents(txb);
            selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            txb.setSelectionRange(0, 999999);
        } else {
            txb.select();
        }
    };


    window.loadJSFile(document, window.appUrl + "/ui_libs.js?v1.00002").onload = function () {

       
        window.bindElements($(document.body), aviewer);
        aviewer.appView.$.uiViews({
            name: "aviewerApp",
            done:function(app) {

                aviewer.app = app;
               
                aviewer.app.toggleSidebar = function () {

                    $('.layout-container').toggleClass('sidebar');
                };
                aviewer.UGCLikes = {};

                app.logoutUser = function () {

                    window.ui.storage.remove("aviewerUser");
                    aviewer.user = null;
                    app.loginUser(function (user) {

                    });
                };

                app.registerUser = function (autoLogin) {
                    app.pushView({

                        html: aviewer.registerUserUI,
                        ready: function (view) {
                            /*
                            view.userPicture.$.fileUploadButtonEx({
                                accept: "image/*", onFileData: function (data) {
                                    view.imageCropper.$.show();
                                    view.imageCropperDiv.$.croppie({
                                        url: data,
                                        showZoomer: false,
                                        viewport: { width: 256, height: 256 },
                                      
                                    }).css("bottom","110px");


                                }
                            });
                            */
                            view.cancelImageCropper.onclick = function () {
                                view.imageCropper.$.hide();

                            };

                            view.doneImageCropper.onclick = function () {
                                view.imageCropper.$.hide();
                                view.imageCropperDiv.$.croppie('result', 'blob').then(function (data) {
                                    console.log(data);
                                });
                            };

                            view.signUpButton.onclick = function () {
                                if (view.userPassword.$.val() != view.userCPassword.$.val()) {
                                    window.ui.modals.error("Sign up failed", "Password do not match");
                                    return (false);
                                }
                                window.ui.showProcessing();
                                aviewer.api("signup", {
                                   
                                    user_title: view.userName.$.val(), user_type: 1000, email: view.userEmail.$.val(),
                                    username: view.userName.$.val(), password: view.userPassword.$.val(),
                                    user_settings: "{}", user_details:"{}"
                                },
                                    function (res) {
                                        window.ui.hideProcessing();
                                        window.ui.modals.info("Sign up success", "Thank you for signing up").closing = function () {

                                            aviewer.app.popView();
                                            if (autoLogin) {
                                                setTimeout(function () {
                                                    app.loginUser(function (user) { });

                                                }, 200);
                                            }
                                            
                                            return (true);
                                        };
                                        
                                    },
                              function (errs) {                               
                                  if (errs.length > 0) {
                                      window.ui.modals.error("Sign up failed", errs[0].field + ':' + errs[0].message);
                                  }
                                 
                              });

                            };


                        }
                    });

                };


                app.loginUser = function (done,emailOnly) {
                    
                    

                    if (aviewer.user) {
                        $(document.body).addClass('userIsLoggedIn');
                        setTimeout(function () { done(aviewer.user); }, 100);
                    }
                    else {

                       

                        aviewer.user = window.ui.storage.get("aviewerUser");

                        if (aviewer.user) {
                            aviewer.user = JSON.parse(aviewer.user);
                            $(document.body).addClass('userIsLoggedIn');
                            setTimeout(function () { done(aviewer.user); }, 100);
                            return;
                        }

                        if (emailOnly) {
                            ui.modals.inputBox({
                                title: "Participate with email",
                                ok: function (value) {

                                    if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(value)) {
                                        done({ id: -1000, username: value, emailOnly: true });
                                        return (true);
                                    }
                                    ui.modals.error("Invalid email", "please enter a valid email address");
                                    return (false);
                                }
                            }).ready = function () {
                                this.$.find("input").addClass("form-control");
                                this.setWidth("350px");
                                this.$.find(".ui-ui-modal-ok-button").addClass("btn-danger").html("NEXT >>");
                                this.$.find(".ui-ui-modal-cancel-button").html("CANCEL");
                            };

                            return;
                        }
                        app.pushView({

                            html: aviewer.loginUserUI,
                            ready: function (view) {
                                view.signUpButton.onclick = function () {
                                    app.registerUser();
                                   

                                };
                                view.signInButton.onclick = function () {
                                    window.ui.showProcessing();
                                    aviewer.api("login_av", { username: view.userName.$.val(), password: view.userPassword.$.val() },
                                        function (res) {
                                            aviewer.userAccessToken = res.access_token;


                                            window.ui.hideProcessing();

                                            aviewer.user = res.user;

                                            aviewer.user.userPassword = view.userPassword.$.val();


                                            window.ui.storage.set("aviewerUser", JSON.stringify(aviewer.user));

                                          
                                            aviewer.app.popView();
                                            $(document.body).addClass('userIsLoggedIn');
                                            setTimeout(function () { done(aviewer.user); }, 100);
                                        },
                                  function (res) {
                                      console.log(res);
                                      window.ui.modals.error("Login failed", "Invalid username or password");
                                  });

                                };


                            }
                        });
                    }


                };

                app.uploadDubbedSounds = function (done) {
                   
                    var sounds = [];
                    for (var s in aviewer.dubbedSounds) {
                        var snd = aviewer.dubbedSounds[s];
                        if (!snd.uploaded) {
                            snd.org = s;
                            sounds.push(snd);

                        }
                    }
                   
                    eachItem(sounds, function (snd, next) {

                        var mp3Data = [];
                        var mp3encoder = new lamejs.Mp3Encoder(1, 44100, 64);
                        var mp3Tmp = mp3encoder.encodeBuffer(window.convertoFloat32ToInt16(snd.data));
                        mp3Data.push(mp3Tmp);
                        var mp3buf = mp3encoder.flush();
                        if (mp3buf.length > 0) {
                            mp3Data.push(new Int8Array(mp3buf));
                        }

                        var blob = new Blob(mp3Data, { type: 'audio/mp3' });
                        aviewer.uploadFile(blob, function (url) {
                            snd.uploaded = url;
                            console.log(snd);
                            next.call();
                        });
                    },


                        function () {
                            
                            done(sounds);
                        });

                   

                };

                app.dubImagCanv = window.createCanvasObject(10, 10);
                app.uploadDubbedImages = function (done) {

                    var images = [];
                    for (var m in aviewer.dubbedImages) {
                        var mm = aviewer.dubbedImages[m];
                        if (!mm.uploaded) {
                            images.push(mm);
                        }
                    }

                    eachItem(images, function (mm, next) {
                        var blob1, blob2;
                        window.checkImageSource(mm.dataUrl, function () {

                            if (window.isMobileDevice) {
                                app.dubImagCanv.setSize(this.width * 2, this.height * 2);
                                app.dubImagCanv.ctx.drawImage(this, 0, 0, this.width * 2, this.height * 2);
                                blob1 = window.dataURLtoBlob(app.dubImagCanv.toDataURL("image/png"));
                                blob2 = window.dataURLtoBlob(mm.dataUrl);
                            }
                            else {
                                app.dubImagCanv.setSize(this.width * 0.5, this.height * 0.5);
                                app.dubImagCanv.ctx.drawImage(this, 0, 0, this.width * 0.5, this.height * 0.5);
                                blob2 = window.dataURLtoBlob(app.dubImagCanv.toDataURL("image/png"));
                                blob1 = window.dataURLtoBlob(mm.dataUrl);
                            }

                            console.log(blob1); console.log(blob2);
                            aviewer.uploadFile(blob1, function (url) {
                                var key = url.replace('/assets/', '') + '_res_2';
                                aviewer.uploadFile(blob2, function (url2) {
                                    mm.uploaded = url;                                 
                                    delete mm.dataUrl;
                                    next.call();
                                }, 'key=' + key);
                            });
                        });

                       

                        
                    },


                        function () {done(images); });



                };


                app.showBookComments = function ( ugcId,exitScreen) {
                    app.pushView({

                        html: window.parseItemTags(aviewer.userGeneratedBooksCommentsUI, function (k) {
                            return (eval(k));
                        }),
                        ready: function (view) {

                            view.dead = function () {
                              
                                if(exitScreen) exitScreen();

                            };
                            view.appendCommentItem = function (item,appendToLast) {
                                var item$ = $(window.parseItemTags(aviewer.userGeneratedBookCommentTemplate, function (k) {
                                    return (eval(k));
                                }));
                                if (appendToLast) view.listItems.$.append(item$); else view.listItems.$.prepend(item$);

                                item$.find("img")[0].onerror = function () {
                                    this.src =aviewer.serverUrl+ "/global/img/large-user-avatar.png";
                                };

                            };
                            view.viewPreviousCommentsLink.onclick = function () {
                                view.getList();

                            };
                            view.getList = function (clear,justRefreshList) {
                                if (clear) view.listItems.$.html("");
                                var start = view.listItems.$.find(".listItemTemplate").length;
                                view.loadingList = true;
                                var q = {
                                    limit: { start: start, count: 10 },
                                    filter: { data_ref: ugcId, data_type: 20 },
                                    order:{data_time:"DESC"},
                                    fetchContent: true
                                };

                                window.ui.showProcessing();
                                aviewer.api("search_data_collection", q, function (res) {
                                    console.log(res);
                                    if (res.data.length < 10)
                                        view.loadingList = true;
                                    else
                                        view.loadingList = false;

                                    res.data.forEach(function (item) {
                                        
                                        view.appendCommentItem(item);
                                    });
                                    view.listItems.$.prepend(view.viewPreviousCommentsLink);
                                    if (res.data.length > 9) {
                                        view.loadingList = false;
                                        view.viewPreviousCommentsLink.$.show();
                                    } else {
                                        view.viewPreviousCommentsLink.$.hide();
                                    }

                                    window.ui.hideProcessing();
                                });
                            };
                            view.getList();

                            view.postComment = function () {
                                var txt = view.postCommentText.$.val();
                                if (txt != "") {
                                    view.postCommentText.$.val("");
                                    console.log(txt);
                                    window.ui.showProcessing();
                                    aviewer.api("aniparti_data_collection", { data_ref: ugcId,data_text:txt,  data_type: 20, data_user: aviewer.user.id }, function (res) {
                                        window.ui.hideProcessing();
                                      
                                        view.appendCommentItem({ data_text: txt, username: aviewer.user.username, usid: aviewer.user.id ,data_time:Date.now()},true);
                                    });
                                }
                             

                            };
                            view.postCommentLink.onclick = function () {
                                view.postComment();
                            };
                            view.postCommentText.onkeydown = function (e) {
                                if (e.keyCode == 13) view.postComment();
                            };
                        }
                    })
                };
                app.saveAndShareUGC = function (shareURL) {

                    book=aviewer.currentPlay_book;
                    ugcId=aviewer.currentPlay_ugcId;
                    app.loginUser(function (user) {
                        console.log("app.loginUser");
                        ui.modals.open({
                            title: "Share & Publish Now", element: aviewer.saveAndPublishUI,
                            buttons: '<div class="ui-ui-modal-action-buttons"><button class="btn default pull-left ui-ui-modal-cancel-button buttonRadius" >Cancel</button><button class="btn btn-danger pull-right ui-ui-modal-ok-button buttonRadius">Save & Publish</button></div>'

                        }).ready = function () {
                            var md = this;
                            md.setWidth("350px");
                            window.bindElements(md.$, md);
                            md.$.find(".ui-ui-modal-cancel-button").css("width", "130px").css("color", "white").html("CANCEL");
                            md.$.find(".ui-ui-modal-ok-button").css("width", "130px").html("SHARE & PUBLISH");

                            md.publishTitle.$.val(user.username + "'s " + book.name);

                            if (user.emailOnly) {
                                md.publishTitle.$.val(user.username);
                            }
                            md.closing = function (ok) {

                                if (ok) {


                                    window.ui.showProcessing();



                                    var userData = { dubbedSounds: {}, dubbedImages: {}, dubbedObjects: aviewer.dubbedObjects };

                                    var completePublish = function () {
                                        var repo = {
                                            user_id: user.id, type: 1051, tags: "", status: 0, ref_key: book.id, repo_path: book.repo_path, description: "", name: md.publishTitle.$.val(), scope: 100
                                        };
                                        repo.scope = md.publishModePrivate.checked ? 200 : 100;
                                        repo.content = JSON.stringify(userData);
                                        aviewer.api('save_repo_av', repo, function (res) {

                                            if (shareURL) {
                                                ui.modals.info("Share & Publish Now", "<h6 style='color:gray;text-align:center'>Successfully saved</h6>").ready = function () {
                                                    this.$.find(".ui-ui-modal-ok-button").css("margin-left", "-65px");
                                                    this.closing = function () {
                                                        app.shareToPublic('http://mad.aniparti.com/ugc?' + res.id,true)
                                                        return (true);
                                                    }

                                                };

                                                
                                            }
                                            console.log(res);
                                            window.ui.hideProcessing();
                                            md.forceClose();
                                        });

                                    };

                                    app.uploadDubbedImages(function (images) {
                                        images.forEach(function (mm) {
                                            userData.dubbedImages[mm.key] = mm;
                                        });

                                        app.uploadDubbedSounds(function (sounds) {
                                            sounds.forEach(function (snd) {
                                                userData.dubbedSounds[snd.org] = snd.uploaded;
                                            });
                                            completePublish();
                                            console.log(userData);
                                        });


                                    });



                                    return (false);
                                }
                                return (true);
                            };
                        }

                    }, true);

                };

                app.shareToPublic = function (url,backToList) {
                    var md = ui.modals.info('Copy the LINK to share', '<label>URL:</label><br/><div class="inputArea"></div><h6 style="color:red;text-align:center;font-size:80%">Copy &amp; Paste this URL wherever you want to share</h6>');
                    md.ready = function () {

                        this.$.find(".ui-ui-modal-ok-button").css("margin-left", "-65px");
                    };
                    aviewer.copyURLText.$.show();
                    md.$.find(".inputArea").append(aviewer.copyURLText);
                    aviewer.copyURLText.$.val(url);
                    aviewer.copyURLText.$.focus();
                    if (window.isOS()) {
                        var range = document.createRange();
                        range.selectNodeContents(aviewer.copyURLText);
                        var selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                        aviewer.copyURLText.setSelectionRange(0, 999999);
                    } else {
                        aviewer.copyURLText.$.select();
                    }
                    md.closing = function () {

                        var successful = document.execCommand('copy');
                        var msg = successful ? 'successful' : 'unsuccessful';
                        console.log(msg);
                        aviewer.copyURLText.$.hide();
                        $(document.body).append(aviewer.copyURLText);
                        if (backToList) {
                            aviewer.saveShareCompleted = true;
                            aviewer.app.popView();
                        }
                        return (true);
                    };

                };
                app.playBook = function (book, userData, ugcId,refreshList) {
                    
                    aviewer.currentPlay_book = book;
                    aviewer.currentPlay_userData = userData;
                    aviewer.currentPlay_ugcId = ugcId;
                    aviewer.dubbedSounds = {};
                    aviewer.dubbedImages = {};
                    aviewer.dubbedObjects = {};
                    aviewer.userDubbedImages = {};
                    aviewer.userDubbedSounds = {};
                    aviewer.userDubbedSoundsApplied = {};
                    aviewer.isUGCVersion = false;
                    if (userData) {
                        aviewer.userDubbedSounds = userData.dubbedSounds;
                        aviewer.userDubbedImages = userData.dubbedImages;
                        aviewer.userDubbedObjects = userData.dubbedObjects || {};
                        aviewer.isUGCVersion = true;
                    }
                     app.pushView({

                        html: aviewer.playBookUI,
                        ready: function (view) {
                            window.ui.showProcessing();
                            view.css("overflow", "hidden");
                         
                            var windowWidth = $(window).width();
                            var windowHeight = $(window).height();

                            if (windowWidth > windowHeight) {
                                var w = (windowWidth * 0.5);
                                if (w > 600) w = 600;
                                view.css("width", w + "px");
                                view.css("left", "50%").css("margin-left", -(w * 0.5) + "px");
                            }

                           

                            aviewer.saveAndPublishButton.hide();
                            aviewer.shareButton.hide();
                            aviewer.likeButton.hide();
                            aviewer.commentsButton.hide();

                            setTimeout(function (view) {

                               // aviewer.viewerArea.insertBefore(view.navigationBar.$);

                                view.append(window.layoutContainer);

                                //window.layoutContainer.insertBefore(view.popViewButton.$);
                                console.log("book", book);
                                window.loadContent(book.content);
                                window.layoutContainer.show();
                              
                                window.ui.hideProcessing();
                                if (userData) {
                                    if(ugcId) view.addClass('likeSupport');
                                    console.log('likeSupport', view);                                    
                                }
                                else {
                                    aviewer.saveAndPublishButton.show();
                                    view.addClass('shareSupport');
                                }
                            }, 200, view);

                            view.dead = function () {
                                window.clearContent();
                                window.layoutContainer.hide();
                                $(document.body).append(window.layoutContainer);
                                if (window.ugcIndexPage) {

                                }
                                history.pushState(null, null, window.ugcIndexPage ? "ugc/view?" + book.id : "ugc?" + book.id);
                                if (refreshList) refreshList();

                                
                            };
                            
                            if (userData) {
                                aviewer.likeButton.show();
                                aviewer.commentsButton.show();
                                aviewer.shareButton.show();

                                if (ugcId) {
                                    aviewer.isUGCVersion = true;
                                    if (aviewer.likedThisUGC) {
                                        aviewer.likeButton.addClass("liked");
                                    } else {
                                         

                                        aviewer.likeButton.removeClass("liked");
                                        aviewer.likeButton[0].onclick = function () {
                                            app.loginUser(function (user) {
                                                if (aviewer.UGCLikes[parseInt(aviewer.user.id)]) {
                                                    aviewer.likeButton.addClass("liked");
                                                    return;
                                                }
                                                console.log("aviewer.user", aviewer.user);


                                                window.ui.showProcessing();                                                                                        
                                                aviewer.api("aniparti_data_collection", { data_ref: ugcId, data_type: 10, data_user: aviewer.user.id }, function (res) {
                                                    aviewer.UGCLikes[parseInt(aviewer.user.id)] = true;
                                                    window.ui.hideProcessing();
                                                    aviewer.likeButton.addClass("liked");
                                                });
                                            });

                                        };
                                        
                                       


                                    }
                                    
                                    aviewer.shareButton[0].onclick = function () {
                                        app.shareToPublic('http://mad.aniparti.com/ugc?' + ugcId);
                                    }
                                    aviewer.commentsButton[0].onclick = function () {
                                       
                                        app.loginUser(function (user) {
                                            var slide = window.viewer.activeSlide;                                            
                                            slide.pause();
                                            console.log("slide-pause", slide.uuid);
                                            app.showBookComments(ugcId, function () {                                             
                                                slide.resume();
                                                console.log("slide-resume", slide.uuid);                                                
                                            });
                                        });
                                        
                                    };


                                }
                                
                            }
                           

                          
                          

                            aviewer.saveAndPublishButton[0].onclick = function (e) {
                                if (!window.audioinput) {
                                    //ui.modals.error("Save &amp Publish", "Not available on Web<br/>Please use App"); return;

                                }
                                app.saveAndShareUGC();
                                e.stopPropagation();
                                e.preventDefault();
                                return (false);

                            };

                        }
                     });

                     $(".sidebarLinks.backToListLink")[0].onclick = function () {
                         console.log(".sidebarLinks.backToListLink");
                         aviewer.app.popView();

                     };

                };
                app.hideEmailAddress = function (email) {
                    var parts = email.split("@");
                    var name = parts[0];
                    var moreparts = parts[1].split(".");
                    var padding = "*****************************************";
                    if (name.length < 2) name += "***";
                    if (moreparts[0].length > 2) parts[1] = (moreparts[0].substr(0, 2) + padding.substr(0, moreparts[0].length - 2)) + "." + moreparts[1];
                    parts[0] = name.substr(0, 2) + padding.substr(0, name.length - 2);
                   
                    return (parts[0] + "@" + parts[1]);

                };
                app.showUserGeneratedBooks = function (mainBook, ugcId) {

                    app.pushView({
                        noTransistions: window.ugcIndexPage,
                        html: window.parseItemTags(aviewer.userGeneratedBooksUI, function (k) {
                            return (eval(k));
                        }),
                        ready: function (view) {
                            
                            if (window.ugcIndexPage) {
                                view.backToListButton.$.hide();
                            }
                            view.mainBookImage.onerror = function () {
                                this.src = aviewer.serverUrl+"/global/img/publish-thumbnail.jpg_2";
                            };
                            view.mainBookImage.src = aviewer.serverUrl +'/'+ mainBook.repo_path + "_2";

                            view.loadUgc = function (item) {

                                item.userData = JSON.parse(item.content);
                                window.ui.showProcessing();
                                aviewer.likedThisUGC = false;
                                aviewer.UGCLikes = {};
                              
                                aviewer.api("aniparti_data_collection_query", { data_ref: item.id, data_type: 10 }, function (data) {
                                    data.res.forEach(function (d) {
                                        var like_user =parseInt(d.data_user);
                                        aviewer.UGCLikes[like_user] = true;
                                        if (aviewer.user && like_user == parseInt(aviewer.user.id)) {
                                            aviewer.likedThisUGC = true;
                                        }
                                    });
                                    var viewKey = 'data_view_' + (aviewer.user ? aviewer.user.id : '-1') + '_' + item.id;  
                                    if (!window.ui.storage.get(viewKey)) {
                                        aviewer.api("aniparti_data_collection", { data_ref: item.id, data_type:30}, function (res) {
                                            window.ui.storage.set(viewKey, 'true');
                                            window.ui.hideProcessing();
                                            app.playBook( mainBook, item.userData, item.id);
                                        });
                                    }
                                    else {
                                        window.ui.hideProcessing();
                                        app.playBook(mainBook, item.userData, item.id);
                                    }

                                });
                            };
                            view.getList = function (clear,justRefreshList) {
                                if (clear) view.listItems.$.html("");
                                var start = view.listItems.$.find(".listItemTemplate").length;
                                view.loadingList = true;
                                var q = {
                                    limit: { start: start, count: 10 },
                                    filter: { type: 1051, scope: 100, ref_key: mainBook.id },
                                    fetchContent:true,
                                    fields: {
                                        comments: '(select count(data_user) from aniparti_data_collection where data_ref=ap.id AND data_type=20)',
                                        likes: '(select count(data_user) from aniparti_data_collection where data_ref=ap.id AND data_type=10)',
                                        views: '(select count(data_user) from aniparti_data_collection where data_ref=ap.id AND data_type=30)'
                                    },
                                    order: { 'modified_date': 'DESC' }

                                };

                                if (view.searchList) {
                                    q.search = view.searchList;
                                }
                                   


                               
                                window.ui.showProcessing();

                                aviewer.api("search_repo_public", q, function (res) {
                                    console.log(res);
                                    if (res.data.length < 10)
                                        view.loadingList = true;
                                    else
                                        view.loadingList = false;

                                    res.data.forEach(function (item) {
                                        if (item.usid == -1000) {
                                            item.name =app.hideEmailAddress(item.name);
                                        }
                                        var item$ = $(window.parseItemTags(aviewer.userGeneratedBookItemTemplate, function (k) {
                                            return (eval(k));
                                        }));
                                        view.listItems.$.append(item$);
                                        item$[0].onclick = function () {
                                            view.loadUgc(item);
                                            history.pushState(null, null, window.ugcIndexPage ? "ugc/view?" + item.id : "ugc?" + item.id);
                                        };



                                        item$.find("img")[0].onerror = function () {
                                            this.src =aviewer.serverUrl+ "/global/img/large-user-avatar.png";
                                        };
                                        if (item.id == ugcId && !justRefreshList) {
                                            view.loadUgc(item);
                                          
                                        }

                                    });


                                    if (res.data.length == 0 && start<2) {
                                        view.listArea.$.append('<h5 style="color:black;position:absolute;left:0;right:0; top:50%;text-align:center;font-weight:bold;margin-top:-100px;line-height: 50px;"><i style="color:#b5b4b4;font-size:72px;" class="fa fa-exclamation-circle"></i><br/>No list yet ^^;</h5>');
                                    }
                                    if (res.data.length > 19) view.loadingList = false;

                                    window.ui.hideProcessing();
                                });
                            };


                            view.listArea.$.scrollHeightItems(
                                function () {
                                    return (view.listItems.$.height() - 10);
                                },
                                function () {

                                    if (!view.loadingList) view.getList();
                                }
                            );

                            if (mainBook.id == ugcId) {
                                //setTimeout(function () { app.playBook(mainBook); }, 100);
                            }
                            view.getList();

                            view.anipartiLogo.onclick = function (e) {
                                view.getList(true,true);
                                e.preventDefault();e.stopPropagation();
                            };

                            view.refreshItemsLink.onclick = function (e) {
                                view.getList(true, true);
                                e.preventDefault(); e.stopPropagation();
                            };

                            view.readOriginalButton.onclick = function () {
                                app.playBook(mainBook, false, false, function () {
                                    if (aviewer.saveShareCompleted) {
                                        aviewer.saveShareCompleted = false;
                                        setTimeout(function () { view.getList(true, true); }, 100);
                                    }

                                });
                            };

                            view.dead = function () {
                                history.pushState(null, null, "ugc");
                            };

                            view.searchItem = function () {
                                var txt = view.searchItemText.$.val();
                                if (txt != "") {
                                    view.searchItemText.$.val("");
                                    view.searchList = { name: txt+'%' };
                                    view.getList(true,true);
                                }
                                else {
                                    view.searchList = false;
                                    view.getList(true, true);
                                }

                            };
                            view.searchItemLink.onclick = function () {
                                view.searchItem();
                            };
                            view.searchItemText.onkeydown = function (e) {
                                if (e.keyCode == 13) view.searchItem();
                            };

                        }
                    })

                };


                app.showMyUGCList = function () {
                    app.pushView({

                        html: window.parseItemTags(aviewer.myUGCListUI, function (k) {
                            return (eval(k));
                        }),
                        ready: function (view) {



                            view.getList = function (clear) {
                                if (clear) view.listItems.$.html("");
                                var start = view.listItems.$.find(".listItemTemplate").length;
                                view.loadingList = true;
                                var q = {
                                    limit: { start: start, count: 10 },
                                    filter: { type: 1051, user_id: aviewer.user.id },
                                    fetchContent: true,
                                    fields: {
                                        comments: '(select count(data_user) from aniparti_data_collection where data_ref=ap.id AND data_type=20)',
                                        likes: '(select count(data_user) from aniparti_data_collection where data_ref=ap.id AND data_type=10)',
                                        views: '(select count(data_user) from aniparti_data_collection where data_ref=ap.id AND data_type=30)'
                                    },
                                    order: { modified_date: 'DESC' }

                                };

                                window.ui.showProcessing();
                                aviewer.api("search_repo_public", q, function (res) {
                                    console.log(res);
                                    if (res.data.length < 10)
                                        view.loadingList = true;
                                    else
                                        view.loadingList = false;

                                    res.data.forEach(function (item) {
                                        var item$ = $(window.parseItemTags(aviewer.myUGCItemTemplate, function (k) {
                                            return (eval(k));
                                        }));
                                        view.listItems.$.append(item$);
                                       
                                        item$.find("img")[0].onerror = function () {
                                            this.src =aviewer.serverUrl+ "/global/img/publish-thumbnail.jpg";
                                        };

                                        item$.find(".fa-play")[0].onclick = function () {
                                            item.userData = JSON.parse(item.content);
                                            if (!item.mainBook) {
                                                window.ui.showProcessing();
                                                aviewer.api("get_repo_public", { id: item.ref_key }, function (res) {
                                                    window.ui.hideProcessing();
                                                    item.mainBook = res.data;
                                                    app.playBook(item.mainBook, item.userData);
                                                });
                                            }
                                            else app.playBook(item.mainBook, item.userData);
                                        };

                                        item["user_id"] = aviewer.user.id;

                                        item$.find(".privatePublicCheckbox")[0].onchange = function () {
                                            var chkBox = this;
                                            var setPublicPrivate = function (item, scope) {
                                                item.scope = scope;
                                                window.ui.showProcessing();
                                                aviewer.api('save_repo_av', item, function (res) {
                                                    console.log(res);
                                                    window.ui.hideProcessing();
                                                    chkBox.checked = item.scope == 100;
                                                });
                                            };
                                            if (chkBox.checked) {
                                                if (item.scope == 200) {
                                                    window.ui.modals.question("Public", "Do you want to set it for public").closing = function (ok) {
                                                        if (ok)
                                                            setPublicPrivate(item, 100);
                                                        else
                                                            chkBox.checked = item.scope == 100;
                                                        return (true);
                                                    };
                                                }
                                            }
                                            else {
                                                if (item.scope == 100) {
                                                    window.ui.modals.question("Public", "Do you want to remove from public").closing = function (ok) {
                                                        if (ok) setPublicPrivate(item, 200);
                                                        else chkBox.checked = item.scope == 100;
                                                        return (true);
                                                    };
                                                }
                                            }

                                            



                                        };

                                        item$.find(".deleteButton")[0].onclick = function () {
                                            window.ui.modals.question("Delete", "Do you want to delete this item").closing = function (ok) {
                                                if (ok)
                                                {
                                                    window.ui.showProcessing();
                                                    aviewer.api('delete_repo_av', { id: item.id }, function (res) {
                                                        window.ui.hideProcessing();
                                                        view.getList(true);
                                                    });
                                                }
                                                return (true);
                                            };
                                            
                                            
                                        };
                                    });

                                    if (res.data.length > 19) view.loadingList = false;

                                    window.ui.hideProcessing();
                                });
                            };


                            view.listArea.$.scrollHeightItems(
                                function () {
                                    return (view.listItems.$.height() - 10);
                                },
                                function () {

                                    if (!view.loadingList) view.getList();
                                }
                            );


                            view.getList();

                            view.anipartiLogo.onclick = function (e) {
                                view.getList(true,true);
                                e.preventDefault();e.stopPropagation();
                            };

                        }
                    })

                };


                app.testBook = function (id) {

                    window.ui.showProcessing();
                    aviewer.api("get_repo_public", { id: id }, function (res) {
                        window.ui.hideProcessing();
                        app.playBook(res.data, { dubbedSounds: { "/assets/599f57b67d5e68iga9i": "/assets/59a961091e534qsm844" } });

                    });
                };

                app.testBook2 = function (id) {

                    window.ui.showProcessing();
                    aviewer.api("get_repo_public", { id: id }, function (res) {
                        window.ui.hideProcessing();
                        app.showUserGeneratedBooks(res.data);

                    });
                };

                app.pushView({
                    noTransistions: true,
                    html: aviewer.motionBooksUI,
                    ready: function (view) {

                        view.getList = function (clear) {
                            if (clear) view.listItems.$.html("");
                            var start = view.listItems.$.find(".listItemTemplate").length;
                            view.loadingList = true;
                            var q = {
                                limit: { start: start, count: 20 },
                                filter: { type: 106 },
                                order: { modified_date:'DESC' }
                            };
                            window.ui.showProcessing();
                            aviewer.api("search_repo_public", q, function (res) {
                                console.log(res);
                                if (res.data.length < 10)
                                    view.loadingList = true;
                                else
                                    view.loadingList = false;

                                res.data.forEach(function (item) {
                                    var item$ = $(window.parseItemTags(aviewer.motionBookItemTemplate, function (k) {
                                        return (eval(k));
                                    }));
                                    view.listItems.$.append(item$);

                                    item$.find("img")[0].onerror = function () {
                                        this.src =aviewer.serverUrl+ "/global/img/publish-thumbnail.jpg";
                                    };
                                    item$.click(function () {

                                        window.ui.showProcessing();
                                        aviewer.api("get_repo_public", { id: item.id }, function (res) {
                                            window.ui.hideProcessing();
                                            app.showUserGeneratedBooks(res.data);
                                            history.pushState(null, null,window.ugcIndexPage ? "ugc/view?" + item.id : "ugc?" + item.id);
                                           


                                        });


                                    });

                                });

                                if (res.data.length > 19) view.loadingList = false;

                                window.ui.hideProcessing();
                            });
                        };


                        view.listArea.$.scrollHeightItems(
                            function () {
                                return (view.listItems.$.height() - 10);
                            },
                            function () {

                                if (!view.loadingList) view.getList();
                            }
                        );
                        aviewer.user = window.ui.storage.get("aviewerUser");
                        if (aviewer.user) {

                            aviewer.user = JSON.parse(aviewer.user);
                            $(document.body).addClass('userIsLoggedIn');

                        }
                       

                       

                        if (aviewer.ugcRefId && aviewer.ugcRefId != "") {
                            console.log("aviewer.ugcRefId", aviewer.ugcRefId);
                            window.ui.showProcessing();
                            aviewer.api("get_repo_public", { id: aviewer.ugcRefId }, function (res) {
                                window.ui.hideProcessing();
                                app.showUserGeneratedBooks(res.data, aviewer.ugcId);

                            });
                        }
                        else {
                            if (window.ugcIndexPage)  setTimeout(function () { $(".listOfItemsArea").html('<h4 style="color:black;text-align:center">No ugc content available</h4>'); }, 100);
                        }


                        if (!window.ugcIndexPage) {
                            view.getList();
                        }
                        


                        
                        view.anipartiLogo.onclick = function (e) {
                            view.getList(true);
                            e.preventDefault();e.stopPropagation();
                        };

                        if (!window.isMobileDevice) {
                            

                        }
                        setTimeout(function () {
                            //app.loginUser(function (user) { });
                            //app.registerUser();
                        }, 100);
                        

                    }
                });


                app.userSettings = function () {
                    app.pushView({

                        html: window.parseItemTags(aviewer.userSettingsUI, function (k) {
                            return (eval(k));
                        }),
                        ready: function (view) {
                                                 

                        }
                    });

                };

                document.addEventListener("backbutton", function () {
                    if (confirm("Do you want to exit")) {
                        navigator.app.exitApp();
                    }

                    return;
                    var currentView = app.rootElement.views.find(".view-present");
                    if (currentView.hasClass('mainScreenView')) {
                      
                    }
                    else {
                        app.popView();
                    }

                }, false);

             

              
            }
        });

        $("#mainContainer").show();
       // aviewer.appView.$.insertBefore(aviewer.viewerArea);
        $("#mainContainer").append(aviewer.appView.$);
        aviewer.appView.$.find(".ui-views-sidebar-overlay,.ui-views-sidebar").remove();
       
        window.prepareNewNavigationSystem();
        window.layoutContainer.hide();
        //window.topNavBar.hide();
        window.layoutContainer.append($(".viewerErrorMessage"));
        if (!window.isMobileDevice) {
            if (windowWidth > 600) windowWidth = 600;
            window.layoutContainer.css("width", windowWidth + "px").css("left", "50%").css("margin-left", "-" + (windowWidth / 2) + "px");
            
        }
        window.windowWidth = windowWidth;
        $(".ugcLinks").show();
        

        aviewer.shareButton = $(".sidebarLinks.shareLink");
        aviewer.saveAndPublishButton = $(".sidebarLinks.ugcPublishingLink");
        aviewer.commentsButton = $(".pageNavigationPanel .commentLink");
        aviewer.likeButton = $(".pageNavigationPanel .likeLink");
        $(".nextEpisodeLink,.maniSearchLink,.notReguiredInUGC").hide();



    };


    aviewer.modifyImage = function (modifyImageComplete, sww, shh, modifyImageCancel, editTitle, modifyImageAction) {
         if (!aviewer.fabricCanvas) {

            window.bindElements(aviewer.modifyImageUI, aviewer.modifyImageUI);

            aviewer.appView.$.append(aviewer.modifyImageUI);
            aviewer.fabricCanvas = new window.ui.canvas("modifyImageCanvas", { width: 0, height: 0 });
            aviewer.fabricCanvas.setViewport(aviewer.appView.$.width(), aviewer.appView.$.height());
            aviewer.fabricCanvas.pan.x = -aviewer.fabricCanvas.width / 2;
            aviewer.fabricCanvas.pan.y = -(aviewer.fabricCanvas.height / 2);
            aviewer.fabricCanvas.absolutePan(aviewer.fabricCanvas.pan);
            aviewer.fabricCanvas.resCanv = window.createCanvasObject(10, 10);

            aviewer.modifyImageUI.penWidth = 5;
            aviewer.modifyImageUI.penSize.$.customSliderInput(1, 10).smartEdit(aviewer.modifyImageUI.penWidth).onUpdate = function (v) {
                aviewer.modifyImageUI.penWidth = v;
                aviewer.modifyImageUI.penSizeBall.$.css("transform", "scale(" + (v / 10) + ")");
                if (aviewer.fabricCanvas.drawing && aviewer.fabricCanvas.drawing.currentPoly) {
                    aviewer.fabricCanvas.drawing.currentPoly.lineWidth = aviewer.modifyImageUI.penWidth;
                }
            };

            aviewer.modifyImageUI.penColorValue = "rgb(0,0,0)";
            aviewer.modifyImageUI.penColor.$.ColorPicker({

                onBeforeShow: function () {
                    aviewer.modifyImageUI.penColor.$.ColorPickerSetColor(aviewer.modifyImageUI.penColorValue);
                },
                onChange: function (hsb, hex, rgb) {
                    var c = "rgb(" + rgb.r + "," + rgb.g + "," + rgb.b + ")";
                    aviewer.modifyImageUI.penColor.$.css('backgroundColor', c);
                    aviewer.modifyImageUI.penColorValue = c;
                    if (aviewer.fabricCanvas.drawing && aviewer.fabricCanvas.drawing.currentPoly) {
                        aviewer.fabricCanvas.drawing.currentPoly.color = aviewer.modifyImageUI.penColorValue;
                    }

                }
            });

            aviewer.modifyImageUI.penOkButton.$.click(function () {
                $(".hideWrittingUI").show();
                aviewer.modifyImageUI.penOptions.$.hide();

                aviewer.fabricCanvas.drawingMode = false;
                var obj = aviewer.fabricCanvas.drawing.finishNewObject();
                aviewer.fabricCanvas.setActiveObject(obj);
                obj.setCoords();
                aviewer.fabricCanvas.renderAll();


            });
            aviewer.modifyImageUI.penCancelButton.$.click(function () {
                $(".hideWrittingUI").show();
                aviewer.modifyImageUI.penOptions.$.hide();
                aviewer.fabricCanvas.drawingMode = false;
                aviewer.fabricCanvas.drawing.reset();
                aviewer.fabricCanvas.renderAll();
            });


            aviewer.fabricCanvas._mouseWheel = function (evt) {


            };
            aviewer.fabricCanvas.enableInteraction().selection = false;
             
            aviewer.fabricCanvas.itemEditOptions = aviewer.modifyImageUI.find(".itemEditOptions");

            aviewer.fabricCanvas._renderOverlay = function (ctx) {

                aviewer.fabricCanvas.itemEditOptions.hide();

                if (aviewer.fabricCanvas._activeObject) {
                    if (aviewer.fabricCanvas._activeObject.resizingBox) return;
                    if (aviewer.fabricCanvas._activeObject.textObject) {
                        aviewer.modifyImageUI.editObjectButton.$.show();
                    }
                    else {
                        aviewer.modifyImageUI.editObjectButton.$.hide();
                    }
                    
                    aviewer.fabricCanvas._activeObject.updateBounds();
                    aviewer.fabricCanvas.itemEditOptions.show();
                    var z = aviewer.fabricCanvas.currentZoom;
                    var rc = aviewer.fabricCanvas._activeObject.bounds;

                    var _width = rc.width * z;
                    var _height = rc.height * z;

                    var _left = ((rc.left * z) - aviewer.fabricCanvas.pan.x) + _width + (10 * z);
                    var _top = (rc.top * z) - aviewer.fabricCanvas.pan.y;
                    aviewer.fabricCanvas.itemEditOptions.css("left", _left + "px").css("top", _top + "px");
                }
              

              


                if (aviewer.fabricCanvas.drawingMode) {

                }
            };

            aviewer.fabricCanvas.itemEditOptions.find(".deleteObject").click(function () {
                if (aviewer.fabricCanvas._activeObject) {
                    aviewer.fabricCanvas.deleteObject(aviewer.fabricCanvas._activeObject);
                    aviewer.fabricCanvas.renderAll();
                }
                    
            });

            aviewer.fabricCanvas.itemEditOptions.find(".editObject").click(function () {
                if (aviewer.fabricCanvas._activeObject) {
                    if (aviewer.fabricCanvas._activeObject.textObject) {
                        aviewer.fabricCanvas.editTextBox(aviewer.fabricCanvas._activeObject);
                    }
                }

            });

            aviewer.fabricCanvas.itemEditOptions.find(".duplicateObject").click(function () {


            });
             
            aviewer.fabricCanvas.resizingBox = aviewer.fabricCanvas.newObject({
                lockMovementX: true, lockMovementY: true, hasRotatingPoint: false, resizingBox: true,

                originX: "center", originY: "center", centeredScaling: true, width: 200, height: 200,evented:false,
                _render: function (ctx) {
                    var width = this.width * this.scaleX;
                    var height = this.height * this.scaleY;
                    this.width = width;
                    this.height = height;
                    this.scaleX = 1;
                    this.scaleY = 1;
                    ctx.strokeStyle = "rgb(200,200,200)";

                    ctx.strokeRect(-width / 2, -height / 2, width, height);

                }

            });

            aviewer.fabricCanvas.drawing = aviewer.fabricCanvas.newObject({
                left: 0, top: 0, evented: false, resizingBox: true, width: 1, height: 1, points: [], polys: [],
                ready: function () {
                    this.startNewPoly();
                },
                addPoint: function (x, y) {

                    this.currentPoly.points.push({ x: x, y: y });
                },
                reset:function(){
                    this.polys.length = 0;

                },
                startNewPoly: function () {
                    this.currentPoly = { color: aviewer.modifyImageUI.penColorValue, points: [], lineWidth: aviewer.modifyImageUI.penWidth };
                    this.polys[this.polys.length] = this.currentPoly;
                },
                _render: function (ctx) {

                    var self = this;
                    this.polys.forEach(function (pl) {
                        ctx.strokeStyle = pl.color;
                        ctx.lineWidth = pl.lineWidth;

                        ctx.beginPath();
                        pl.points.forEach(function (p, index) {
                            if (index == 0) {
                                ctx.moveTo(p.x, p.y);
                            }
                            else {
                                ctx.lineTo(p.x, p.y);
                            }
                        });
                        ctx.stroke();
                    });


                },
                finishNewObject: function () {
                    var minx = 99999, miny = 99999, maxx = -99999, maxy = -99999;

                    this.polys.forEach(function (pl) {
                        pl.points.forEach(function (p, index) {
                            if (p.x > maxx) maxx = p.x;
                            if (p.y > maxy) maxy = p.y;
                            if (p.x < minx) minx = p.x;
                            if (p.y < miny) miny = p.y;
                        });
                    });

                    var obj = aviewer.fabricCanvas.newObject({
                        originX: "center", originY: "center", centeredScaling: true, cornerSize: 40,
                        width: maxx - minx, height: maxy - miny, left: minx, top: miny, polys: JSON.parse(JSON.stringify(this.polys)),
                        _render: this._render,
                        _render1: function (ctx) {
                            var w = this.width * this.scaleX;
                            var h = this.height * this.scaleY;

                            this.scaleX = 1;
                            this.scaleY = 1;

                            this.width = w; this.height = h;

                            var sx = this.width / this.awidth;
                            var sy = this.height / this.aheight;
                            this.polys.forEach(function (pl) {
                                ctx.strokeStyle = pl.color;
                                ctx.lineWidth = pl.lineWidth;
                                ctx.beginPath();
                                pl.points.forEach(function (p, index) {
                                    if (index == 0) {
                                        ctx.moveTo(p.x * sx, p.y * sy);
                                    }
                                    else {
                                        ctx.lineTo(p.x * sx, p.y * sy);
                                    }
                                });
                                ctx.stroke();
                            });

                        }
                    });


                    this.polys.length = 0;

                    obj.polys.forEach(function (pl) {
                        pl.points.forEach(function (p, index) {
                            p.x -= minx + obj.width * 0.5;
                            p.y -= miny + obj.height * 0.5;
                        });
                    });


                    obj.left += obj.width * 0.5;
                    obj.top += obj.height * 0.5;
                    obj.awidth = obj.width;
                    obj.aheight = obj.height;

                    return (obj);
                }
            });

            aviewer.fabricCanvas.onDragging = function (dmx, dmy, ee, e) {
                if (!aviewer.fabricCanvas.drawingMode) return;
                if (Math.abs(dmx) > 2 || Math.abs(dmy) > 2) {
                    var x = aviewer.fabricCanvas.lmx + aviewer.fabricCanvas.pan.x;
                    var y = aviewer.fabricCanvas.lmy + aviewer.fabricCanvas.pan.y;
                    aviewer.fabricCanvas.drawing.addPoint(x, y);
                    aviewer.fabricCanvas.renderAll();
                }

            };

            aviewer.fabricCanvas.onDraggingUp = function () {
                if (!aviewer.fabricCanvas.drawingMode) return;

                aviewer.fabricCanvas.drawing.startNewPoly();
                //aviewer.fabricCanvas.drawingMode = false;
                //aviewer.fabricCanvas.setActiveObject(aviewer.fabricCanvas.drawing.finishNewObject());
                //aviewer.fabricCanvas.renderAll();
            };


            aviewer.fabricCanvas.editTextBox = function (tbox) {
                window.ui.modals.question("Edit Text", '<textarea rows=10 style="width:100%;text-align:center;border-radius:12px"></textarea>').ready = function () {
                    var md = this;
                    md.$.css("min-width", "330px").css("width", "330px");
                    md.$.find("textarea").val(tbox.text).select().focus();
                    md.$.find('.ui-ui-modal-ok-button').addClass('btn-danger').html("Ok");
                    md.$.find('.ui-ui-modal-cancel-button').html("Cancel");
                    md.closing = function (res) {

                        if (res) {
                            tbox.text = md.$.find("textarea").val();
                            tbox.setCoords();
                            setTimeout(function () {
                                aviewer.fabricCanvas.renderAll();
                                if (tbox.width > aviewer.fabricCanvas.width) tbox.width = aviewer.fabricCanvas.width;
                                aviewer.fabricCanvas.renderAll();

                            }, 200);

                        }
                        return (true);
                    };

                };


            };
            aviewer.fabricCanvas.addTextBox = function (txt) {

                var txb = aviewer.fabricCanvas.newObject({
                    textObject: true, originX: "center", originY: "center", centeredScaling: true, textAlign: "center",
                    left: 0, top: 0, width: 50, height: 50, borderPadding: 5, text: txt, lineSpacing: 0, fontFamily: "Open Sans",
                    cornerSize: 40,
                    _render: function (ctx) {
                        var texts = this.text.split('\n');

                        var width = this.width * this.scaleX;
                        var height = this.height * this.scaleY;

                        var pd = this.borderPadding;
                        var lpc = this.lineSpacing;
                        var x = -width / 2, y = -height / 2;
                        this.scaleX = 1; this.scaleY = 1;
                        this.height = height;
                        var lineHeight = (height - ((pd * 2.0) + (lpc * texts.length))) / (texts.length);


                        if (lineHeight < 7) {
                            lineHeight = 7;
                            height = (lineHeight + (pd * 2) + lpc) * texts.length;
                            this.height = height;
                            y = -height / 2;
                        }
                        ctx.save();
                        var tws = [];


                        var firstWidth = true;
                        ctx.font = (lineHeight) + "px " + this.fontFamily;
                        for (var i = 0; i < texts.length; i++) {
                            var ww = ctx.measureText(texts[i]).width;
                            if (ww > width || firstWidth) width = (ww + pd * 3) + lpc;
                            tws.push(ww);
                            firstWidth = false;

                        }
                        this.width = width;


                        var printText = function (x, y, i) {
                            ctx.fillText(texts[i], x, y);
                        }
                        if (this.textAlign == "center")
                            printText = function (x, y, i) { ctx.fillText(texts[i], x + (((width - pd * 2) * 0.5) - ((tws[i] * 0.5) + pd * 0.5)), y); }
                        else if (this.textAlign == "right")
                            printText = function (x, y, i) { ctx.fillText(texts[i], x + (((width - pd * 2)) - ((tws[i]) + pd * 0.5)), y); }

                        ctx.fillStyle = this.fontColor;


                        for (var i = 0; i < texts.length; i++)
                            printText(x + pd, (((y + (lineHeight + lpc) * i) + (lineHeight / 1.25)) + pd) + lpc * 0.5, i);


                        ctx.restore();
                    },
                    ready: function () {
                        this.setControlVisible("ml", false);
                        this.setControlVisible("mr", false);
                        this.setControlVisible("mt", false);
                        this.setControlVisible("mb", false);

                    },
                    clipTo: function (ctx) {
                        var w = this.width, h = this.height, x = -this.width / 2, y = -this.height / 2;
                        ctx.rect(x, y, w, h);
                    }
                });

                txb.setCoords();
                aviewer.fabricCanvas.setActiveObject(txb);

                return (txb);


            };


            aviewer.modifyImageUI.action_textObject = function () {
                aviewer.fabricCanvas.addTextBox("Text field");
                aviewer.fabricCanvas.renderAll();
            };
            aviewer.modifyImageUI.find(".textObject").click(aviewer.modifyImageUI.action_textObject);

            aviewer.modifyImageUI.action_penObject = function () {
                aviewer.fabricCanvas.drawingMode = true;
                aviewer.fabricCanvas.drawing.bringToFront();
                aviewer.fabricCanvas.drawing.polys.length = 0;
                aviewer.fabricCanvas.drawing.startNewPoly();
                aviewer.fabricCanvas._discardActiveObject();
                $(".hideWrittingUI").hide();
                aviewer.fabricCanvas.renderAll();
                aviewer.modifyImageUI.penOptions.$.show();
            };
            aviewer.modifyImageUI.find(".penObject").click(aviewer.modifyImageUI.action_penObject);


            aviewer.modifyImageUI.action_imageObject = function () {
                window.ui.modals.info("Select Bubble", '<div style="height:340px;overflow-y:auto;border-radius:12px;border:solid 1px silver"><ul class="list-unstyled"></ul></div>').ready = function () {
                    var md = this;
                    md.$.css("min-width", "320px").css("width", "320px");
                    md.$.find('.ui-ui-modal-ok-button').html("Close");


                    var list = md.$.find(".list-unstyled");
                    for (var i = 1; i < 21; i++) {
                        var tm = $('<li class="imagelist-item media"><img class="mr-3" width="64" height="64" src="' + window.appUrl + '/images/bubbles/' + i + '.png" ></li>');
                        list.append(tm);
                        tm[0].onclick = function () {
                            var img = $(this).find("img")[0];
                            var mg = aviewer.fabricCanvas.newObject({
                                imageObject: true, originX: "center", originY: "center", centeredScaling: true, textAlign: "center",
                                left: 0, top: 0, width: img.width * 3, height: img.height * 3, cornerSize: 40,
                                _render: function (ctx) {
                                    ctx.drawImage(this.img, -this.width / 2, -this.height / 2, this.width, this.height);
                                },
                                ready: function () {
                                    this.img = new Image();
                                    this.img.src = img.src;
                                    var self = this;
                                    this.img.onload = function () {
                                        //self.width = this.width;
                                        // self.height = this.height;
                                    };
                                }
                            });

                            mg.setCoords();
                            mg.sendToBack();
                            aviewer.fabricCanvas.setActiveObject(mg);
                            md.close();
                        };
                    }


                };

            };
            aviewer.modifyImageUI.find(".imageObject").click(aviewer.modifyImageUI.action_imageObject);


            aviewer.modifyImageUI.action_uploadImageObject = function () {
                window.ui.modals.question("Upload Image", '').ready = function () {
                    var md = this;
                    md.$.css("min-width", "330px").css("width", "330px");                
                    md.$.find('.ui-ui-modal-ok-button').addClass('btn-success').html("Upload Image").fileUploadButtonEx({
                        accept: "image/*", onFileData: function (data) {                        
                            window.checkImageSource(data, function () {
                                var mg = aviewer.fabricCanvas.newObject({
                                    imageObject: true, originX: "center", originY: "center", centeredScaling: true, textAlign: "center",
                                    left: 0, top: 0, width: this.width, height: this.height, cornerSize: 40,
                                    _render: function (ctx) {
                                        ctx.drawImage(this.img, -this.width / 2, -this.height / 2, this.width, this.height);
                                    },
                                    ready: function () {
                                        this.img = new Image();
                                        this.img.src = data;

                                        var sw = this.width;
                                        var sh = this.height;
                                        var mw = aviewer.fabricCanvas.resizingBox.width;
                                        var mh = aviewer.fabricCanvas.resizingBox.height;
                                        var scale = 1;

                                        if (sw > sh) {
                                            scale = mw / sw;
                                            sh = sh * scale;
                                            if (sh > mh) scale *= (mh / sh);
                                            sw *= scale;
                                        }
                                        else {
                                            scale = mh / sh;
                                            sw = sw * scale;
                                            if (sw > mw) scale *= (mw / sw);
                                            sh *= scale;

                                        }

                                        this.scaleX = scale;
                                        this.scaleY = scale;


                                    }
                                });
                                mg.setCoords();
                                aviewer.fabricCanvas.resizingBox.bringToFront();
                                aviewer.fabricCanvas.setActiveObject(mg);
                                md.close(false);
                            });
                        }
                    });

                    md.closing = function (res) {
                          return (!res);
                    };



                    md.$.find('.ui-ui-modal-cancel-button').html("Cancel");
                  

                };
            };
            aviewer.modifyImageUI.find(".uploadImageObject").click(aviewer.modifyImageUI.action_uploadImageObject);
            

            aviewer.modifyImageUI.action_emojObject = function () {
                window.ui.modals.question("Select Emoj", '<input type="range" min="0" max="10" value="5" style="width:99%;margin-left:1%" /><div style="height:340px;overflow-y:auto;border-radius:12px;border:solid 1px silver"> <ul class="list-unstyled"></ul></div>').ready = function () {
                    var md = this;
                    md.$.css("min-width", "320px").css("width", "320px");
                    md.$.find('.ui-ui-modal-ok-button').html("Confirm");
                    md.$.find('.ui-ui-modal-cancel-button').html("Close");
                    md.emojSpeed = 100 + (((10 - 5) - 5) * 7);
                    md.emojSpeedValue = 5;
                    md.runEmoj = function (md) {

                        if (md.selectedEmoj) {
                            md.runingEmoj = true;
                            var img = md.selectedEmoj.image;
                            img.totalFrames = img.width / img.height;
                            if (img.frameIndex > img.totalFrames - 1) img.frameIndex = 0;


                            md.emojSpeed = (1500 + (((10 - md.emojSpeedValue) - 5) * 250)) / img.totalFrames;

                            img.style.marginLeft = (-img.frameIndex * img.height) + "px";
                            //console.log("md.emojSpeed", md.emojSpeed);
                            img.frameIndex++;
                            md.runingEmoj = true;
                            if (!md.isClosed) {
                                setTimeout(md.runEmoj, md.emojSpeed, md);
                            }
                        }

                    };


                    md.closing = function (res) {
                        md.isClosed = true;
                        if (res && md.selectedEmoj) {
                            var img = md.selectedEmoj.image;
                            var sz = img.naturalHeight;
                            var mg = aviewer.fabricCanvas.newObject({
                                originX: "center", originY: "center", centeredScaling: true, textAlign: "center",
                                left: 0, top: 0, width: sz, height: sz, cornerSize: 40,
                                _render: function (ctx) {
                                    ctx.drawImage(this.img, 0, 0, this.width, this.height, -this.width / 2, -this.height / 2, this.width, this.height);
                                },
                                ready: function () {
                                    this.img = new Image();
                                    this.img.src = img.src;
                                    var self = this;
                                    this.emoj = {
                                        image: img.src, speed: md.emojSpeed, width: img.naturalWidth, height: img.naturalHeight,

                                    };
                                }
                            });

                            mg.setCoords();
                            mg.bringToFront();
                            aviewer.fabricCanvas.setActiveObject(mg);
                        }
                        return (true);
                    };

                    md.$.find("input")[0].onchange = function () {

                        md.emojSpeedValue = this.value;

                    };

                    var list = md.$.find(".list-unstyled");
                    for (var i = 1; i < 12; i++) {
                        var tm = $('<li class="imagelist-item  media emoj-list-item"><div><img class="mr-3"  height="60" src="' + window.appUrl + '/images/emojs/' + i + '.png" /></div></li>');
                        list.append(tm);
                        tm[0].onclick = function () {
                            list.find(".emoj-list-item").removeClass("selected");
                            $(this).addClass("selected");
                            md.selectedEmoj = this;
                            if (!md.runingEmoj) md.runEmoj(md);
                        };
                        tm.find("img").each(function () {
                            this.frameIndex = 0;
                            tm[0].image = this;
                        });
                    }




                };

            };
            aviewer.modifyImageUI.find(".emojObject").click(aviewer.modifyImageUI.action_emojObject);

        

            
            aviewer.fabricCanvas.renderAll();

            aviewer.fabricCanvas.__onMouseDown = function (e) {
                e = aviewer.fabricCanvas.processMosuedown(e);
                if (aviewer.fabricCanvas.drawingMode) {
                    return;
                }
                if (aviewer.fabricCanvas.ignoreMousedown) {
                    aviewer.fabricCanvas.ignoreMousedown = false;
                    return;

                }
                return aviewer.fabricCanvas.__onMouseDown_old(e);

            };

            aviewer.modifyImageUI.confirmButton.onclick = function () {
                aviewer.fabricCanvas.resizingBox.visible = false;

                aviewer.fabricCanvas.emojs = [];
                var canvasObjects = 0;
                aviewer.fabricCanvas.forEachObject(function (obj) {
                    if (obj.emoj) {
                        obj.emoj.x = obj.left;
                        obj.emoj.y = obj.top;
                        obj.emoj.sx = obj.scaleX;
                        obj.emoj.sy = obj.scaleY;
                        aviewer.fabricCanvas.emojs.push(obj.emoj);
                        aviewer.fabricCanvas.deleteObject(obj);
                    }
                    else canvasObjects++;
                });
                console.log("canvasObjects", canvasObjects);
                console.log("aviewer.fabricCanvas.emojs", aviewer.fabricCanvas.emojs);

                aviewer.fabricCanvas._discardActiveObject();
                var url = aviewer.fabricCanvas.toDataURL({
                    left: (aviewer.fabricCanvas.resizingBox.left - aviewer.fabricCanvas.pan.x) - aviewer.fabricCanvas.resizingBox.width * 0.5,
                    top: (aviewer.fabricCanvas.resizingBox.top - aviewer.fabricCanvas.pan.y) - aviewer.fabricCanvas.resizingBox.height * 0.5,
                    width: aviewer.fabricCanvas.resizingBox.width, height: aviewer.fabricCanvas.resizingBox.height,                    
                });
                
                aviewer.fabricCanvas.resizingBox.visible = true;
              
                if (canvasObjects > 2) {
                    window.checkImageSource(url, function () {
                        console.log("image updated");
                        aviewer.fabricCanvas.resCanv.setSize(aviewer.fabricCanvas.sww, aviewer.fabricCanvas.shh);
                        aviewer.fabricCanvas.resCanv.ctx.drawImage(this, 0, 0, this.width, this.height, 0, 0, aviewer.fabricCanvas.sww, aviewer.fabricCanvas.shh);
                        if (aviewer.fabricCanvas.modifyImageComplete) {
                            aviewer.fabricCanvas.modifyImageComplete(aviewer.fabricCanvas.resCanv.toDataURL("image/png"), aviewer.fabricCanvas.emojs);
                            aviewer.modifyImageUI.hide();
                        }
                    });
                }
                else {
                    aviewer.fabricCanvas.resCanv.setSize(aviewer.fabricCanvas.sww, aviewer.fabricCanvas.shh);
                    if (aviewer.fabricCanvas.modifyImageComplete) {
                        aviewer.fabricCanvas.modifyImageComplete(aviewer.fabricCanvas.resCanv.toDataURL("image/png"), aviewer.fabricCanvas.emojs);
                        aviewer.modifyImageUI.hide();
                    }
                }
               

             
               
            };
            aviewer.modifyImageUI.cancelButton.onclick = function () {

                aviewer.modifyImageUI.hide(); 
                if (aviewer.fabricCanvas.modifyImageCancel) aviewer.fabricCanvas.modifyImageCancel();
            };
        }
        else {
            aviewer.fabricCanvas.forEachObject(function (obj) {
                if (!obj.resizingBox) {
                    aviewer.fabricCanvas.deleteObject(obj);
                }
            });
            $(".hideWrittingUI").show();
            aviewer.modifyImageUI.penOptions.$.hide();
            aviewer.fabricCanvas.drawingMode = false;
            aviewer.fabricCanvas.drawing.reset();
            aviewer.modifyImageUI.show();
        }
         if (modifyImageAction.defaultAction == "Emoji") {
             aviewer.modifyImageUI.action_emojObject();
         }
         else if (modifyImageAction.defaultAction == "Text") {
             aviewer.fabricCanvas.editTextBox(aviewer.fabricCanvas.addTextBox("Text field"));
             aviewer.fabricCanvas.renderAll();
         }
         else if (modifyImageAction.defaultAction == "Image") {
             aviewer.modifyImageUI.action_uploadImageObject();
         }
         else if (modifyImageAction.defaultAction == "Pen") {
             aviewer.modifyImageUI.action_penObject();
         }

         aviewer.modifyImageUI.editTitle.$.html(editTitle);
         aviewer.fabricCanvas.modifyImageComplete = modifyImageComplete;
         aviewer.fabricCanvas.modifyImageCancel = modifyImageCancel;
         aviewer.fabricCanvas.sww = sww;
         aviewer.fabricCanvas.shh = shh;

        var sw = sww;
        var sh = shh;
        var mw = aviewer.fabricCanvas.width - 50;
        var mh = aviewer.fabricCanvas.height - 50;
        var scale = 1;

        if (sw > sh) {
            scale = mw / sw;
            sh = sh * scale;
            if (sh > mh) scale *= (mh / sh);
           sw *= scale;
        }
        else {
            scale = mh / sh;
            sw = sw * scale;
            if (sw > mw) scale *= (mw / sw);
            sh *= scale;

        }
        aviewer.fabricCanvas.drawing.reset();
        aviewer.fabricCanvas.resizingBox.width = sww * scale;
        aviewer.fabricCanvas.resizingBox.height = shh * scale;

        aviewer.fabricCanvas.scale = scale;
        aviewer.fabricCanvas.resizingBox.setCoords();
        aviewer.fabricCanvas.renderAll();

        console.log("aviewer.fabricCanvas.scale", aviewer.fabricCanvas.scale);

       
    }
    window.loadJSFile(document, window.appUrl + "/fabric.min.js").onload = function () {
        //setTimeout(function () { aviewer.modifyImage(false, 300, 400); }, 200);
    };


    window.loadJSFile(document, window.appUrl + "/lame.min.js").onload = function () { };

    
    if (!window.audioinput) {
        /*
        window.loadJSFile(document, window.appUrl + "/audioInputCapture.js").onload = function () {

            console.log("define window.audioinput", audioinput);
            audioinput._initWebAudio();

        };
        */

    }


    if (!window.isMobileDevice) {
        window.mainContainer.css("width", "100%").css("left", "0%").css("margin-left", "0");
    }
   
    aviewer.showUserMenu = function (icon) {
        $(icon).parent().append(aviewer.userMenu);
        aviewer.userMenu.toggleClass('show');

    };
    aviewer.userLoginLink = function () {
        
        aviewer.app.loginUser(function (user) {
            $(document.body).addClass('userIsLoggedIn');

        });

    };

    aviewer.userLogout = function () {
        $(document.body).removeClass('userIsLoggedIn');
        aviewer.app.logoutUser();

    };
    


    if (!window.isMobileDevice) {
       

    }


    window.trim_string = function (str, length) {
        var s = str.toString();
        if (s.length > length)
            return (s.substr(0, length) + "...");
        else
            return (s);
    };
</script>
<style>
    .ui-ui-modal-action-buttons1 button {
        margin-left:-65px !important;
    }
    .form-control {
        
        background-color: #eeeeee;border-radius: 10px;line-height: 1.65;
        margin-bottom:10px;margin-top:10px;
        
    }
  .likeButton.liked {

  }
    body, body * {
           font-family: 'Open Sans', sans-serif;
        }
     h1,h2,h3,h4,h5,h6 {
         text-transform:none !important;
     }
    .box-shadow-menu:before {
        background: #d71a1a !important;
        box-shadow: 0 0.3em 0 0 #d71a1a, 0 0.6em 0 0 #d71a1a !important;
    }

    .listItemTemplate .imgWrapper {
        width: 142px;
        height: 92px;
        overflow: hidden;
        margin:10px;
        background-color:#f1f1f1;
    }

    .listItemTemplate {
        border-bottom: solid 1px #f3f3f3;
        margin-bottom: 2px;
    }
    .listItemTemplate .media-body {
        margin-top:20px;
    }

    

        .listItemTemplate h3,.listItemTemplate h4,.listItemTemplate h5 {
            color: black;
            text-transform:none;
        }
         .listItemTemplate  h3 {
        font-weight:600;
        font-size:14px;
        }

         .listItemTemplate  h5 {
        font-weight:300;
        font-size:14px;
        color:gray;
        }

          .listItemTemplate  h4 {
        font-weight:400;
        font-size:14px;
        color:gray;
        }


    
    .listItemTemplate:hover,.listItemTemplate:active {
        background-color:#ebebeb;
    }
    .buttonRadius {
        border-radius:18px;
    }

    .listOfItemsArea {
        padding:0; position:absolute;top:50px;bottom:0px;left:0;right:0;width:100%;height:calc(100% - 50px);overflow-y:auto;overflow-x:hidden;border-top:solid 1px #f3f3f3

    }
    .listOfItems {
        display: inline-block;
        width: 100%;
    }
    .btn {
        border-radius:1px;
         
    }
    .ui-ui-modal .btn ,.btn.withShadow{
        -webkit-box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.43);
                -moz-box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.43);
                box-shadow: 0px 0px 5px 0px rgba(0,0,0,0.43);
                    font-size: 0.8rem;
                    background-color:#c4c4c4;
                    border-color: #c4c4c4;
                        text-transform: uppercase;
                        color:white !important;
                        width: 130px;
    }
    .btn-primary,.btn-primary:disabled {
       
         background-color: #0068c8;
        border-color: #0068c8;
    }


    .btn-success,.btn-success:disabled {

        background-color: #3ab100;
        border-color: #3ab100;
    }

    .btn-danger,.btn-danger:disabled {
        

        background-color: #ec4534 !important;
        border-color: #ec4534  !important;
    }
    .btn-default,.btn-default:disabled {
        color:white;
        background-color: #8d8d8d;
        border-color: #8d8d8d;
    }
     .btn-default2,.btn-default2:disabled {
        color:white;
        background-color: #434343;
        border-color: #434343;
    }
    

    .sz100P {
        width:100%;
    }

    @media (min-width: 900px) {
        
        .listItemTemplate {
            width:50%;
            float:left;

        }

         .listItemTemplate .media-body {
            transform:scale(0.9);
            transform-origin:left top;
        }

        .listOfItems,.ugcListPageTop {
           position:absolute;
           left:50% !important;
           width:900px !important;
           margin-left:-450px !important;
           border-left:solid 1px #e0e0e0;
           border-right:solid 1px #e0e0e0;
          


        }

    }

     @media (min-width: 11200px) {
       
        .listItemTemplate {
            width:33.33%;
            float:left;
            
        }
        .listItemTemplate .media-body {
            transform:scale(0.85);
            transform-origin:left top;
        }

         .listOfItems,.ugcListPageTop {
           position:absolute;
           left:50%;
           width:1200px;
           margin-left:-600px;
        }

    }

    .header-button {
        position: absolute;
        font-size: 120%;
        color: #fff;
        bottom: 8px;
    }
 
    .ui-ui-modal {
        position: absolute;
        left: 50%;
        top: 50%;
        font-family: inherit;
        border-radius: 0;
        background-color: white;
        -webkit-box-shadow: 0px 0px 17px 0px rgba(0,0,0,0.53);
                -moz-box-shadow: 0px 0px 17px 0px rgba(0,0,0,0.53);
                box-shadow: 0px 0px 17px 0px rgba(0,0,0,0.53);
                border:0 !important;
    }
    .popover-body {
        padding: 9px 14px;
        color: #212529;
         margin-bottom: 0;
         padding-bottom:25px;
    }
    .popover-header {
        padding: 8px 14px;
        margin-bottom: 0;
        font-size: 1rem;
        color: white;
        background-color: #ec4534;
        border-bottom:none;
      border-top-left-radius:0;
        border-top-right-radius: 0;
    }
    

    .ui-ui-modal-title-span {
        font-weight:700;
    }
    .badge {
        width: 48px;
        height: 48px;
        padding-top: 5px;
        border-radius: 100%;
    }

    .custom-control-input:active ~ .custom-control-indicator {
        color: #fff;
        background-color: #d71a1a;
    }


    .custom-checkbox .custom-control-indicator {
        border-radius: .25rem;
    }
    .custom-control-input:checked ~ .custom-control-indicator {
        color: #fff;
        background-color: #d71a1a;
    }
     .custom-control-indicator {
        position: absolute;
        top: .25rem;
        left: 0;
        display: block;
        width: 1rem;
        height: 1rem;
        pointer-events: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        background-color: #d71a1a;
        background-repeat: no-repeat;
        background-position: center center;
        background-size: 50% 50%;
    }
    .custom-control-input:checked ~ .custom-control-indicator {
        color: #fff;
        background-color: #d71a1a;
    }

    .imagelist-item {
        float:left;
        margin:2px;
        width:62px;
        height:62px;
        padding:1px;
    }
    .imagelist-item:hover {
        border:solid 1px gray;
    }
    .imagelist-item img {
        width:100%;
        height:100%;
    }
    .ui-ui-modal-title {
        text-align: center;
    font-size: 130%;
        color: #e3e3e3;
    }
</style>

<style>
    body .userMenu .userLinks {
         display:none !important; 
    }
    body.userIsLoggedIn .userMenu .userLinks {
        display:inherit !important;
    }
    body.userIsLoggedIn .userMenu .userLoginLink {
        display:none !important;
    }
     

</style>

<div data-bind="appView" style="position:absolute;left:0;top:0px;right:0;height:100%; overflow:hidden;">
    <input data-bind="copyURLText" type="text" class="form-control" style="display:none;margin-bottom:20px; width:100%" />
    
</div>


<script type="text/html" data-execute="aviewer.userMenu=$($(this).html())">
    <div  onclick="$(this).removeClass('show');" class="dropdown-menu userMenu" style="right:0;left:unset">
        <a class="dropdown-item userLoginLink" onclick="aviewer.userLoginLink(); return (false);" href="#">Login</a>
        <a class="dropdown-item myUGCListLink userLinks" onclick="aviewer.app.showMyUGCList();return (false);" href="#">My UGC List</a>
        <a class="dropdown-item userSettingsLink userLinks" onclick="aviewer.app.userSettings(); return (false);" href="#">Settings</a>
        <a class="dropdown-item userLogoutLink userLinks"  onclick="aviewer.userLogout(); return (false);" href="#">Logout</a>
        
    </div>

</script>


<script type="text/html" data-execute="aviewer.maskingImageFiltersUI=$(this).html()">
    <div style="position:absolute;left:0;top:0;width:100%;height:100%;background-color:white; pointer-events:fill">
        <style>
            .filtersTab ul  {
                padding-left:5px;
                padding-right:5px;
                position:absolute;
                left:0;right:0;top:-5px;
            }

            .filtersTab ul li {
                width:33.3%;
            }
            .filtersTab ul li a {
                display:block;
                width:100%;
                color: white;
                background-color: #dadada;
                border-color: #dadada;
                border-top-left-radius:10px;
                border-top-right-radius:10px;
                padding-top:8px;
                padding-bottom:8px;
            }
            .filtersTab ul li.active a {
                display:block;
                width:100%;
                color: white;
                background-color: #676767;
                border-color: #676767;
            }

            .filtersTab .tab-pane {
                 position:absolute;
                left:0;right:0;bottom:0;
                top:30px;
                 background-color: #676767;
                 overflow-x:auto;
                 padding:5px;                     
            }
            .filtersTab .tab-pane button {
                float:left;
                margin:3px;
                border-radius:8px;
                padding:8px;
                background-color: #a5a5a5;
                border-color: #a5a5a5;
                color:#f3f3f3;
            }

            .filtersTab .tab-pane button.active {               
                background-color: #d0d0d0;border-color: #d0d0d0;
                color:#f3f3f3;
            }

        </style>
      
        <div class="filtersTab" style="position:absolute;left:0;right:0;bottom: 50px; height: 130px;">
            <ul class="nav nav-tabs " role="tablist" style="">
                <li class="active">
                    <a href="#firstFilter" class="btn btn-default btn-sm">First Filter</a>
                </li>
                <li>
                    <a href="#SecondFilter" class="btn btn-default btn-sm" >Second Filter</a>
                </li>
                <li>
                    <a href="#thirdFilter" class="btn btn-default btn-sm">Third Filter</a>
                </li>
            </ul>
            <div class="tab-pane firstFilter"></div>
            <div class="tab-pane SecondFilter"></div>
            <div class="tab-pane thirdFilter"></div>
        </div>
     
        

        <div style="position:absolute;left:0;right:0;height:50px;bottom:0;background-color:white;padding-top:8px">
            <button class="maskingImageConfirmButton btn btn-success withShadow" style="background-color: #ec4534;border-color: #ec4534; pointer-events:fill;position:absolute;right:10px;width:100px">Next >></button>
            <button class="maskingImageCancelButton btn btn-default withShadow" style="pointer-events:fill;position:absolute;left:10px; width:100px">Cancel</button>

        </div>
     </div>
</script>

<script type="text/html" data-execute="aviewer.maskingImageManipulatorUI=$(this).html()">
    <div style="position:absolute;left:0;top:0;width:100%;height:100%; pointer-events:none">
        <h5 class="maskingImageManipulatorTitle" style="position:absolute;left:0;right:0;top:5px;padding:5px;text-align:center">Edit Masking</h5>
        <i class="fa fa-repeat" style="position:absolute;left:50%;top:40px;margin-left:-16px;font-size:32px;color:white"></i>
        <input class="maskingImageRotator" type="range" min="-180" max="180" value="0" style="pointer-events:fill; position:absolute;left:20px;top:80px;width:calc(100% - 40px)" />
       
        <i style="font-size:32px;color:white;position:absolute;right:8px;top:50%" class="maskingImageScalerPOS fa fa-minus "></i>
        <i style="font-size:32px;color:white;position:absolute;right:8px;top:50%" class="maskingImageScalerPOS fa fa-plus"></i>

        <input class="maskingImageScalerPOS maskingImageScaler" type="range" min="1" max="100" value="50"  style="pointer-events:fill; position:absolute;left:calc(100% - 30px);transform-origin:left top;top:50%;width:calc(100% - 40px);transform:rotate(-90deg)" />

        <button class="maskingImageConfirmButton btn btn-success withShadow" style=" pointer-events:fill;position:absolute;right:10px;bottom:10px; width:100px">Confirm</button>
        <button class="maskingImageCancelButton btn btn-default withShadow" style="pointer-events:fill;position:absolute;left:10px;bottom:10px; width:100px">Cancel</button>
    </div>
</script>


    <script type="text/html" data-execute="aviewer.motionBooksUI=$(this).html()">
        <div class="ui-views-fullscreen-view mainScreenView">
            <div class="header-bar" >
                <div class="logo" style="width:100%;text-align:center;">
                    <img data-bind="anipartiLogo" src="http://mad.aniparti.com/global/img/logo-aniparti-plain-white-shadow.png" height="30" style="margin-top:11px">
                </div>

                <div class="header-button" style="right:10px;top:10px;">
                    <i class="fa fa-navicon" onclick="aviewer.showUserMenu(this);"></i>
                </div>



            </div>

            <div data-bind="listArea" class="container-fluid listOfItemsArea" style="top:50px;bottom:0px;height:calc(100% - 50px);">

                <div data-bind="listItems" class="listOfItems"></div>

            </div>
        </div>
    </script>

    <style>
        .loginUserUI p {
            margin-top:6px;
            margin-bottom:6px;
        }
         .loginUserUI input {
             border:none;
             border-bottom:solid 2px black;
             text-align:left;
             border-radius:unset;
             font-size:110%;
         }
         .loginUserUI button {
             width:80%;
             margin-top:5px;
             border-radius:20px;
             font-size:110%;
             font-weight:bold;
         }
         .loginUserUI label{
             float:left;
         }
    </style>
    <script type="text/html" data-execute="aviewer.loginUserUI=$(this).html()">
        <div class="ui-views-fullscreen-view loginUserUI" style="text-align:center;padding:20px;overflow-x:hidden;overflow-y:auto">
            <a class="header-button" onclick="aviewer.app.popView()" style="left:10px;top:10px;"><i class="fa fa-arrow-left"></i></a>

            <p>
                <img src="http://mad.aniparti.com/global/img/logo-aniparti.png" height="130" />

            </p>
            <p>
                <h5 style="color:black;padding:20px;font-weight:bold">Share <br /> your motions comics to the world!</h5>
            </p>
            <div style="width:300px;position:absolute;left:50%;margin-left:-150px;">
                <div class="form-group">
                    <input type="text" data-bind="userName" class="form-control" placeholder="ID">
                </div>
                <div class="form-group">
                    <input type="password" data-bind="userPassword" class="form-control" placeholder="Password">
                </div>

                <div class="form-group">
                    <p>
                        <button data-bind="signInButton" class="btn btn-danger">Sign In</button>
                        
                        <button data-bind="signUpButton" type="button" class="btn btn-link">Sign Up</button>
                        <button type="button" class="btn btn-link">Forgot your password?</button>
                    </p>

                    <p style="margin:20px;">
                        <img src="http://mad.aniparti.com/global/img/cparti-logo.png" height="40" />
                    </p>
                    <p>
                        <label style="font-size:80%;width:100%;text-align:center">CrowdParti Co., Ltd. All rights Reserved</label>

                    </p>

                </div>
            </div>

        </div>
    </script>



<script type="text/html" data-execute="aviewer.registerUserUI=$(this).html()">
    <div class="ui-views-fullscreen-view loginUserUI registerUserUI" style="text-align:center;padding:20px;overflow-x:hidden;overflow-y:auto">
        <a class="header-button" onclick="aviewer.app.popView()" style="left:10px;top:10px;color:#ec4534"><i class="fa fa-arrow-left"></i></a>
        <p data-bind="userPicture">
            <img  src="http://mad.aniparti.com/global/img/large-user-avatar.png" height="130" />

        </p>
        <div style="width:300px;position:absolute;left:50%;margin-left:-150px;margin-top:20px;">
            <div class="form-group">
               
                <input type="text" data-bind="userName" value1="asif1001" class="form-control" placeholder="Username">
            </div>
            <div class="form-group">
                
                <input type="email" data-bind="userEmail" value1="asif1001@hotmail.com" class="form-control" placeholder="Email">
            </div>
            <div class="form-group">
              
                <input type="password" data-bind="userPassword" value1="Vtech123" class="form-control" placeholder="Password">
            </div>
            <div class="form-group">
               
                <input type="password" data-bind="userCPassword" value1="Vtech123" class="form-control" placeholder="Confirm Password">
            </div>

            <div class="form-group" style="margin-top:20px">
                <p>
                    <button data-bind="signUpButton" class="btn btn-danger">Sign Up</button>
                   

                </p>

                <p style="margin:20px;">
                    <img src="http://mad.aniparti.com/global/img/cparti-logo.png" height="40" />
                </p>
                <p>
                    <label style="font-size:80%;float:none">CrowdParti Co., Ltd. All rights Reserved</label>

                </p>

            </div>
        </div>


        <div style="position:absolute;left:0;top:0;right:0;bottom:0px; display:none;overflow:hidden" data-bind="imageCropper">
            <a class="header-button" data-bind="cancelImageCropper" style="left:10px;top:10px;"><i class="fa fa-arrow-left"></i></a>
            <a class="header-button" data-bind="doneImageCropper" style="right:10px;top:10px;"><i class="fa fa-check"></i></a>

            <div style="position:absolute;left:0;top:50px;right:0;bottom:110px;" data-bind="imageCropperDiv">


            </div>
        </div>
    </div>
</script>
<style>
    .header-bar{
        height:50px;left:0;top:0;right:0;position:absolute;background-color:#ec4534;
    }
    .header-bar  >a {
        color:white !important;
    }
</style>
<script type="text/html" data-execute="aviewer.userSettingsUI=$(this).html()">
    <div class="ui-views-fullscreen-view loginUserUI registerUserUI" style="text-align:center;padding:20px;overflow-x:hidden;overflow-y:auto;padding-top:50px;">
        <div class="header-bar">
            <a class="header-button" onclick="aviewer.app.popView()" style="left:10px;top:10px;color:#ec4534"><i class="fa fa-arrow-left"></i></a>
           
        </div>
        <div style="width:300px;position:absolute;left:50%;margin-left:-150px;margin-top:20px;">
            <p data-bind="userPicture">
                <img src="http://mad.aniparti.com/global/img/large-user-avatar.png" height="130" style="border-radius:100%" />

            </p>
            <table style="width:100%">
                <tr>
                    <td><label style="font-weight:bold">NAME&nbsp;</label></td>
                    <td><label>{{aviewer.user.username}}</label></td>
                </tr>
                <tr>
                    <td><label style="font-weight:bold">EMAIL&nbsp;</label></td>
                    <td><label>{{aviewer.user.email}}</label></td>
                </tr>
                <tr><td>&nbsp;</td></tr>
                <tr><td colspan="2" align="center"><button class="btn btn-default sz100P" style="color:white">Change Password</button></td></tr>
            </table>
          
        </div>
    </div>
</script>

<style>
    .playBookUI .navigationBar {
        position:absolute;left:0;right:0;bottom:0;height:50px;
        opacity:0.9;
        background-color:#c7c7c7;
    }
    .playBookUI .navigationBar i {
        font-size:38px;
        position:absolute;
        top:5px;
        color:gray;
    }
    .playBookUI .navigationBar i.fa-refresh {
        left:2%;
    }
    .playBookUI .navigationBar i.fa-cloud-upload {
        right:2%;
        color1:#0068c8;
         display:none;
    }

    .playBookUI .navigationBar i.likeButton {
        left:30%;
        color1:#d71a1a;
        display:none;
    }


    .playBookUI .navigationBar i.fa-chevron-up {
        left:calc(50% - 30px);
    }

     .playBookUI .navigationBar i.fa-chevron-down {
        right:2%;
    }

     

    .playBookUI .navigationBar i.likeButton:before {
            content: "\f08a";
    }

    .playBookUI .navigationBar i.likeButton.liked:before {
            content: "\f004";
    }


    .likeSupport .navigationBar i.likeButton {       
        display:inherit;
    }

     .likeSupport .navigationBar i.fa-chevron-up {
        left:60%
    }

     .likeSupport .navigationBar i.fa-chevron-down {
        right:2%;
    }

     .shareSupport .navigationBar i.fa-cloud-upload {
       display:inherit;
    }

     .shareSupport .navigationBar i.fa-chevron-up {
        left:30%
    }

     .shareSupport .navigationBar i.fa-chevron-down {
        left:60%;
    }

    .navigationBar .pageDisplay1 {
            color:black;
            position:absolute;
            left:0;top:-20px;
            border-radius:20px;
            background-color:#c7c7c7;
        
                padding-bottom:20px;
                padding-left:10px;
                padding-right:10px;
            text-align:center;
            pointer-events:none;
            text-transform:uppercase;
              font-size:80%;
              width:100px;
        }

     .navigationBar .loadingText {
            color:black;
            position:absolute;
            left:50%;top:-20px;
            width:80px;
            margin-left:-40px;
           
             text-align:center;
            pointer-events:none;
            font-size:70%;
            text-transform:uppercase;

        }


</style>
    <script type="text/html" data-execute="aviewer.playBookUI=$(this).html()">
        <div class="ui-views-fullscreen-view playBookUI" ></div>
    </script>

    <script type="text/html" data-execute="aviewer.saveAndPublishUI=$(this).html()">


        <div class="form-group" style="min-height:160px;position:relative">
            <h6 style="color:gray;margin-top:15px">Set title:</h6>
            <input type="text" data-bind="publishTitle" class="form-control" style="background-color: #eeeeee;border-radius: 10px;line-height: 1.65;">
            <label style="position:absolute;left:70px;top:100px;"><input type="radio" name="publishMode" checked data-bind="publishModePublic" style="margin-right:20px"  />For the public</label>

             <label style="position:absolute;left:70px;top:130px;"><input type="radio" name="publishMode" data-bind="publishModePrivate" style="margin-right:20px" />Private only</label>
           

        </div>
    </script>



<script type="text/html" data-execute="aviewer.shareUGCUI=$(this).html()">
    <div style="text-align:center;padding:5px;">
        <h4 style="color:black;text-decoration:underline">How to share</h4><br />
        <input type="text" contenteditable="true" style="position:absolute;width:100px;left:-1000px" class="copyUrlText" />
        <p><button class="btn btn-default2 buttonRadius sz100P copyByUrl"><i style="color:#858687" class="fa fa-link"></i> Copy URL</button></p> 
        <p><button class="btn btn-primary buttonRadius sz100P" disabled>Share to QQ</button></p>
        <p><button class="btn btn-success buttonRadius sz100P" disabled>Share to WeChat</button></p>
        <p><button class="btn btn-default buttonRadius  ui-ui-modal-cancel-button">Ok</button></p> 
    </div>
    
    

</script>



    <script type="text/html" data-execute="aviewer.dubAudioUI=$(this).html()">
        <table style="width:100%;" >
            <tr>
                <td><a href="#" class="badge badge-pill badge-danger pull-left"><i class="fa fa-3x fa-close"></i></a></td>
                <td><h3 style="color:silver;text-align:center;font-size:48px" class="recordingTimeDisplay">00:00</h3></td>
                <td><a href="#" style="padding-top:11px;padding-left:10px" class="badge badge-pill badge-success pull-right"><i class="fa fa-2x fa-play"></i></a></td>
                

            </tr>
            <tr><td>&nbsp;</td></tr>
        </table>
        <div style="position:absolute;width:80%;height:1px;background-color:#8d8d8d;bottom:20px;left:10%"></div>
    </script>
<style>
       .motionBookItemTemplate .media-body a {
                    display: inline-block;
                    min-width: 40px;
                }

            .motionBookItemTemplate h3 {
                margin-bottom: 10px;
            }

            .motionBookItemTemplate h5 {
               

            }

            .motionBookItemTemplate h4 {
                

                margin-bottom:10px;
            }

            .motionBookItemTemplate .fa-heart-o {
                color: #ec4534;
            }
            

</style>

    <script type="text/html" data-execute="aviewer.motionBookItemTemplate=$(this).html()">
        <div class="media listItemTemplate motionBookItemTemplate">
            <div class="imgWrapper">
                <img class="d-flex mr-3" height="92" src="{{aviewer.serverUrl+item.repo_path}}" alt="image">

            </div>
            <div class="media-body">
                <h3 class="mt-0">{{window.trim_string(item.name,20)}} </h3>
                <h4>{{Date.fromatFromTime(item.created_date,"yyyy.mm.dd")}}</h4>
               
            </div>
        </div>


    </script>

    <script type="text/html" data-execute="aviewer.userGeneratedBooksUI=$(this).html()">
        <div class="ui-views-fullscreen-view">
            <div class="header-bar">
                <div class="logo" style="width:100%;text-align:center;">
                    <img data-bind="anipartiLogo" src="http://mad.aniparti.com/global/img/logo-aniparti-plain-white-shadow.png" height="30" style="margin-top:11px">

                </div>

                <div class="header-button" style="right:10px;top:10px;">
                    <i class="fa fa-navicon" onclick="aviewer.showUserMenu(this);"></i>
                </div>

                <a class="header-button" data-bind="backToListButton" onclick="aviewer.app.popView();history.pushState(null, null, 'ugc');" style="left:10px;top:10px;"><i class="fa fa-arrow-left"></i></a>

            </div>
            <div class="container-fluid ugcListPageTop" style="padding:0; position:absolute;top:50px;height:250px;left:0;right:0;width:100%;border-top:solid 1px #f3f3f3">
                
                <h3 style="font-size:110%;color:#ec4534;padding-left:10px;padding-top:10px">&nbsp;{{mainBook.name}}</h3>
                <div class="media listItemTemplate ugcListPageTop">
                    <div class="imgWrapper" style="height:150px;width:108px;">
                        <img data-bind="mainBookImage" class="d-flex mr-3" height="150"  alt="image">

                    </div>
                    <div class="media-body" style="height:149px;position:relative">
                        <h4>Published on <span style="color:#ec4534;"> {{Date.fromatFromTime(mainBook.modified_date,"ddd mmm dd yyyy")}} </span></h4>                        
                        <button data-bind="readOriginalButton" class="btn btn-sm btn-warning" style="border-radius:10px; position:absolute;left:0px;width:130px; bottom:10px;color:white">View Original</button>
                    </div>
                </div>
                <div style="position:absolute;left:10px;top:200px;right:10px;">
                    <a style="position: absolute;left: 10px;top: 10px;font-weight: bold;text-shadow: 1px 2px 4px #8d8d8d;font-size: 140%;color: white;" data-bind="refreshItemsLink"><i class="fa fa-refresh"></i></a>
                    <input placeholder="'title' or 'name'" data-bind="searchItemText" type="text" style="font-size: 90%;color: #a6a6a6;position: absolute;padding: 4px;left: 50px;top: 12px;width: calc(100% - 95px);border: solid 1px #e0e0e0;background-color: #e0e0e0;border-radius: 12px;padding-left: 20px;" />
                    <a style="position: absolute;right: 10px;top: 10px;font-weight: bold;text-shadow: 1px 2px 4px #8d8d8d;font-size: 140%;color: white;" data-bind="searchItemLink"><i class="fa fa-search"></i></a>
                </div>
            </div>
            <div data-bind="listArea" class="container-fluid listOfItemsArea" style="padding:0; position:absolute;top:300px;bottom:0px;left:0;right:0;width:100%;height:calc(100% - 300px);overflow-y:auto;overflow-x:hidden;border-top:solid 1px #f3f3f3">

                <div data-bind="listItems" class="listOfItems"></div>

            </div>
        </div>
    </script>
    <style>
        .userGeneratedBookItem {
            padding-right: 5px;
            position: relative;
        }

            .userGeneratedBookItem .imgWrapperUser {
                width: 48px;
                height: 48px;
                border-radius: 100%;
                margin-right: 20px;
            }

            .userGeneratedBookItem .media-body {
                margin-top: 10px;
            }

                .userGeneratedBookItem .media-body a {
                    display: inline-block;
                    min-width: 70px;
                }

            .userGeneratedBookItem h3 {
                margin-bottom: 8px;
                color:#ec4534;
                font-weight: 500;

            }

            .userGeneratedBookItem h5 {
               position:absolute;
               right:8px;
               top:12px;
               display:none;
            }

            .userGeneratedBookItem h4 {
                float: left;
                margin-top:0px;
            }

            .userGeneratedBookItem .fa {
                color: #ec4534;
                font-size:150%;
                font-weight:600;
            }

            .userGeneratedBookItem .imgWrapperUser .fa-play {
                position: absolute;
                left: 24px;
                top: 16px;
                font-size: 34px;
                color: #aba6a6;
                opacity: 0.7;
                visibility: hidden;
            }

            .userGeneratedBookItem:hover .imgWrapperUser .fa-play {
                visibility: visible;
            }
            .userGeneratedBookItem .media-body a.views {
                    float:right;
                    margin-right:5px;
                }
    </style>
    <script type="text/html" data-execute="aviewer.userGeneratedBookItemTemplate=$(this).html()">
        <div class="media listItemTemplate userGeneratedBookItem">
            <div class="imgWrapper imgWrapperUser">
                <img class="d-flex mr-3" height="48"  src="{{aviewer.serverUrl+'/assets/user_'+item.usid}}" alt="image">                
            </div>
            <div class="media-body">
                <h3 class="mt-0">{{window.trim_string(item.name,30)}} </h3>
                <h4>
                    <a><i class="fa fa-heart-o"></i> {{item.likes}}</a>
                    <a><i class="fa fa-comment-o"></i> {{item.comments}}</a>
                    <a><i class="fa fa-rss"></i> {{item.views}}</a>                   
                </h4>
                <h5>{{Date.fromatFromTime(item.created_date,"yyyy.mm.dd")}}</h5>
            </div>
        </div>


    </script>





<script type="text/html" data-execute="aviewer.myUGCListUI=$(this).html()">
    <div class="ui-views-fullscreen-view">
        <div class="header-bar">
            <div class="logo" style="width:100%;text-align:center;">
                <img data-bind="anipartiLogo" src="http://mad.aniparti.com/global/img/logo-aniparti-plain-white-shadow.png" height="30" style="margin-top:11px">
            </div>
            <a class="header-button" onclick="aviewer.app.popView(); " style="left:10px;top:10px;"><i class="fa fa-arrow-left"></i></a>

        </div>
         <div data-bind="listArea" class="container-fluid listOfItemsArea" style="padding:0; position:absolute;top:50px;bottom:0px;left:0;right:0;width:100%;height:calc(100% - 50px);overflow-y:auto;overflow-x:hidden;border-top:solid 1px #f3f3f3">
            <div data-bind="listItems" class="listOfItems"></div>

        </div>
    </div>
</script>

<style>
    .myUGCItemTemplate h4 {
        margin-top:10px;
    }


    .myUGCItemTemplate .actionButtons {
        display:none;
        position:absolute;
        bottom:5px;
        left:148px;
        right:5px;
    }
    .myUGCItemTemplate:hover .actionButtons {
        display:inherit;
    }
    .myUGCItemTemplate:hover  {
        height:140px;
    }
    .myUGCItemTemplate .imgWrapper .fa-play {
                position: absolute;
                left: 62px;
                top: 34px;
                font-size: 34px;
                color: #656565;
                opacity: 0.8;
                visibility: hidden;
            }

            .myUGCItemTemplate:hover .imgWrapper .fa-play {
                visibility: visible;
            }
            .actionButtons .btn-danger {
                position:absolute;
                right:20px;
                top:0;
            }
            .actionButtons .custom-checkbox{
                width:35%;
            }
</style>


<script type="text/html" data-execute="aviewer.myUGCItemTemplate=$(this).html()">
    <div class="media listItemTemplate userGeneratedBookItem myUGCItemTemplate">
        <div class="imgWrapper" style="height:82px;width:128px">
            <img class="d-flex mr-3" height="82" src="{{aviewer.serverUrl+item.repo_path}}" alt="image">
            <i class="fa fa-play"></i>
        </div>
        <div class="media-body">
            <h3 class="mt-0">{{item.name}} </h3>
            <h4>
                <a><i class="fa fa-heart-o"></i> {{item.likes}}</a>
                <a><i class="fa fa-share-alt"></i> </a>
                <a class="views"> {{item.views}} views</a>
            </h4>
            <h5>{{Date.fromatFromTime(item.created_date,"yyyy.mm.dd")}}</h5>
            
        </div>

        <div class="actionButtons">
            <label class="custom-control custom-checkbox pull-left">
                <input type="checkbox" {{item.scope==100 ? 'checked' : '';}} class="custom-control-input privatePublicCheckbox">
                <span class="custom-control-indicator"></span>
                <span class="custom-control-description ">Public</span>
            </label>
            &nbsp;|&nbsp;
            <button class="btn btn-sm btn-danger deleteButton">Delete</button>
        </div>
    </div>


</script>


<style>
    .emoj-list-item:hover {
        border:none;
        
    }

    .emoj-list-item {
        border:solid 1px transparent;
        
    }
    .emoj-list-item div {
        height:60px;
        width:60px;
        overflow:hidden;
        
    }
    .emoj-list-item.selected  {
         border:solid 1px silver;
    }
    .emoj-list-item img {
        width:auto;
    }
</style>
<script type="text/html" data-execute="aviewer.modifyImageUI=$($(this).html())">
    

    <div style="position:absolute;left:0;top:0;right:0;bottom:0;border:solid 0px red;background-color:#f5f5f5">
        <div style="position:absolute;left:0;top:0;right:0;bottom:0;">
            <canvas id="modifyImageCanvas" style="position:absolute;left:0;right:0;top:0;bottom:0"></canvas>
        </div>
        <h5 style="color:black;position:absolute;left:0;top:5px;right:0;text-align:center;pointer-events:none" data-bind="editTitle"></h5>
        <button data-bind="cancelButton" class="btn  btn-default hideWrittingUI" style="position:absolute;left:8px;bottom:8px;">Cancel</button>
        <button data-bind="confirmButton"  class="btn  btn-danger hideWrittingUI" style="position:absolute;right:8px;bottom:8px;">Confirm</button>
        
         <table data-bind="penOptions" cellpadding="2" width="100%" style="position:absolute;top:0;left:0;right:0;background-color:#f5f5f5;display:none;margin-top:5px">
            <tr>
                
                <td><div class="hideInput" data-bind="penSize"></div></td>
                <td><div style="border:solid 1px gray;border-radius:6px"><div data-bind="penSizeBall" style="transform:scale(0.5); width:18px;height:18px;border-radius:100%;background-color:black;margin:2px"></div></div></td>
                <td><div style="width:24px;height:24px;background-color:black;border-radius:6px" data-bind="penColor"></div></td>
                <td>&nbsp;</td>
                <td>
                    <button data-bind="penOkButton" class="btn btn-danger btn-sm">Ok</button>
                    
                </td>
                <td>
                    <button data-bind="penCancelButton" class="btn btn-default btn-sm">Cancel</button>
                </td>
            </tr>
        </table>
        <div class="ui-canvas-ItemEdit itemEditOptions" style="display:none">
            <a class="deleteObject btn btn-default" title="Delete object">
                <i class="fa fa-times"></i>
            </a>
            <a data-bind="editObjectButton" class="editObject btn btn-default" title="Edit" >
                <i class="fa fa-pencil"></i>
            </a>           
            <a class="duplicateObject btn btn-default" title="Duplicate object" style="display:none">
                <i class="fa fa-copy"></i>
            </a>

            <a class="sendToBack btn btn-default" style="display:none">
                <i class="fa fa-arrow-up"></i>
            </a>
           <a class="bringToFront btn btn-default"  style="display:none">
                <i class="fa fa-arrow-down"></i>
            </a>
        </div>

        <div class="ui-canvas-ItemEdit hideWrittingUI"  style="right:0;top:10%;">
            <a class="imageObject btn btn-default" >
                <i class="fa fa-comment-o"></i>
            </a>
            <a class="textObject btn btn-default" >
                <i class="fa fa-font"></i>
            </a>
            
            <a class="penObject btn btn-default"  >
                <i class="fa fa-paint-brush"></i>
            </a>

            <a class="emojObject btn btn-default">
                <i class="fa fa-smile-o"></i>
            </a>

            <a class="uploadImageObject btn btn-default">
                <i class="fa fa-picture-o"></i>
            </a>
        </div>
    </div>
   
</script>



<style>
    


    

    .userGeneratedBookCommentTemplate .imgWrapperUser {
        width: 48px;
        height: 48px;
        border-radius: 100%;
        margin-right: 15px;
    }
  

    .userGeneratedBookCommentTemplate .media-body h4 {
        padding-right:30px;
        font-size:11px;
        line-height:1.5;
        text-justify:distribute-all-lines;
        text-align:justify;

    }
    .userGeneratedBookCommentTemplate .media-body h3 {
        color:#434343;
    }
    .userGeneratedBookCommentTemplate .media-body h5 {
        display:block;
        font-size:70%;
        font-weight:500;
        color:#c3c3c3;
    }
</style>
<script type="text/html" data-execute="aviewer.userGeneratedBooksCommentsUI=$(this).html()">
    <div class="ui-views-fullscreen-view">
        <div class="header-bar" style="background-color:#dcd9d9;">
            <h5 style="color:#8d8d8d;padding-top:15px;text-align:center;font-size:100%">COMMENTS</h5> 


            <a class="header-button" data-bind="backToListButton" onclick="aviewer.app.popView();" style="right:10px;top:10px;"><i style="color:#646464" class="fa fa-times"></i></a>

        </div>

        <div data-bind="listArea" class="container-fluid listOfItemsArea" style="padding:0; position:absolute;top:50px;bottom:50px;left:0;right:0;width:100%;height:calc(100% - 100px);overflow-y:auto;overflow-x:hidden;border-top:solid 1px #f3f3f3">
            <a data-bind="viewPreviousCommentsLink" style="text-decoration: underline;color: #00417d;margin: 12px;display: block;padding: 5px;">View previous comments</a>
            <div data-bind="listItems" class="listOfItems">
                
            </div>

        </div>
        <div class="header-bar" style="background-color:#dcd9d9;top:auto;bottom:0">
            <input data-bind="postCommentText" type="text" style="position:absolute;padding:5px; left:7px;top:7px;width:calc(100% - 75px); border:solid 1px #ffffff ;background-color:#ffffff;border-radius:12px;" />
            <a style="position:absolute;right:15px;top:12px;font-weight:bold; text-shadow:2px 3px 12px #8d8d8d" data-bind="postCommentLink" >POST</a>
        </div>
    </div>
</script>

<script type="text/html" data-execute="aviewer.userGeneratedBookCommentTemplate=$(this).html()">
    <div class="media listItemTemplate userGeneratedBookItem userGeneratedBookCommentTemplate">
        <div class="imgWrapper imgWrapperUser">
            <img class="d-flex mr-3" height="48" src="{{aviewer.serverUrl+'/assets/user_'+item.usid}}" alt="image">            
        </div>
        <div class="media-body">
            <h3 class="mt-0">{{window.trim_string(item.username,20)}} </h3>
            <h4>{{item.data_text}}</h4>
            <h5>{{Date.fromatFromTime(item.data_time,"ddd mmm dd yyyy HH:MM:ss")}}</h5>
        </div>
    </div>


</script>